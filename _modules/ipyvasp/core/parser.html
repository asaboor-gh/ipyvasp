<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2024.08.06 -->
        <title>ipyvasp.core.parser - ipyvasp 0.9.98 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">ipyvasp 0.9.98 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">ipyvasp 0.9.98 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../notebooks/quickstart.html">Quickstart</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../summary.html">API Summary</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of API Summary</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.lattice.html">ipyvasp.lattice</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.bsdos.html">ipyvasp.bsdos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.potential.html">ipyvasp.potential</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.widgets.html">ipyvasp.widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.misc.html">ipyvasp.misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.utils.html">ipyvasp.utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.core.parser.html">ipyvasp.core.parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.core.serializer.html">ipyvasp.core.serializer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.core.plot_toolkit.html">ipyvasp.core.plot_toolkit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../_autosummary/ipyvasp.core.spatial_toolkit.html">ipyvasp.core.spatial_toolkit</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../apidoc.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html">IPyVASP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.core.parser">Data Parsers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.core.serializer">Data Serializer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.core.spatial_toolkit">Spatial Toolkit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.core.plot_toolkit">Plot Toolkit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.utils">Additional Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.bsdos">Bandstructure and Density of States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.lattice">Lattice Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.widgets">Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.potential">Potential and Charge Density</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules.html#module-ipyvasp.misc">Miscellaneous</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for ipyvasp.core.parser</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Vasprun&quot;</span><span class="p">,</span> <span class="s2">&quot;Vaspout&quot;</span><span class="p">,</span> <span class="s2">&quot;minify_vasprun&quot;</span><span class="p">,</span> <span class="s2">&quot;xml2dict&quot;</span><span class="p">,</span><span class="s2">&quot;read&quot;</span><span class="p">]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">product</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">serializer</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DataSource</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all data sources. It provides a common interface to access data from different sources.</span>
<span class="sd">    Subclass it to get data from a source and implement the abstract methods.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">skipk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">skipk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skipk</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_skipk</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File: &#39;</span><span class="si">{}</span><span class="s2">&#39;&#39; does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary</span><span class="p">()</span>  <span class="c1"># summary data is read only once</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_bands&quot;</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..bsdos</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bands</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bands</span> <span class="o">=</span> <span class="n">Bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bands</span>  <span class="c1"># keep same instance to avoid data loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_dos&quot;</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..bsdos</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOS</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_dos</span> <span class="o">=</span> <span class="n">DOS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dos</span>  <span class="c1"># keep same instance to avoid data loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_poscar&quot;</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..lattice</span><span class="w"> </span><span class="kn">import</span> <span class="n">POSCAR</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_poscar</span> <span class="o">=</span> <span class="n">POSCAR</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_structure</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poscar</span>  <span class="c1"># keep same instance to avoid data loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_evals_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bands</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize and return an EvalsDataFrame instance, with the given parameters.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..evals_dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">EvalsDataFrame</span>

        <span class="k">return</span> <span class="n">EvalsDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="n">spins</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="n">bands</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">orbs</span><span class="o">=</span><span class="n">orbs</span><span class="p">)</span>

    <span class="c1"># Following methods should be implemented in a subclass</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_summary` should be implemented in a subclass. See Vasprun.get_summary as example.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_structure` should be implemented in a subclass. See Vasprun.get_structure as example.&quot;</span>
        <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_read_skipk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`_read_skipk` should be implemented in a subclass. See Vasprun._read_skipk as example.&quot;</span>
        <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_skipk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the number of first few k-points to skip in band structure plot in case of HSE calculation.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">set_skipk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skipk</span><span class="p">):</span>
        <span class="s2">&quot;Set the number of first few k-points to skip in band structure plot in case of HSE calculation.&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skipk</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span> <span class="o">=</span> <span class="n">skipk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;skipk should be an integer to skip first few random kpoints.&quot;</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">get_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_kpoints` should be implemented in a subclass. See Vasprun.get_kpoints as example.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_evals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_evals` should be implemented in a subclass. See Vasprun.get_evals as example.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_dos` should be implemented in a subclass. See Vasprun.get_dos as example.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_forces` should be implemented in a subclass. See Vasprun.get_forces as example.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_scsteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`get_scsteps` should be implemented in a subclass. See Vasprun.get_scsteps as example.&quot;</span>
        <span class="p">)</span>


<div class="viewcode-block" id="Vaspout"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vaspout">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Vaspout</span><span class="p">(</span><span class="n">DataSource</span><span class="p">):</span>
    <span class="s2">&quot;Read data from vaspout.h5 file on demand.&quot;</span>
    <span class="c1"># These methods are accessible from parent class, but need here for including in sphinx documentation</span>
    <span class="n">get_evals_dataframe</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">get_evals_dataframe</span>
    <span class="n">poscar</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">poscar</span>
    <span class="n">dos</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">dos</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">bands</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">skipk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># super().__init__(path, skipk)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Vaspout is not implemented yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="read"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.read">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">start_match</span><span class="p">,</span> <span class="n">stop_match</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="n">nth_match</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">apply</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a part of the file between start_match and stop_match and returns a generator. It is lazy and fast.</span>
<span class="sd">    `start_match` and `stop_match`(default is end of same line) are regular expressions. `nth_match` is the number of occurence of start_match to start reading.</span>
<span class="sd">    `skip_last` is used to determine whether to keep or skip last line.</span>
<span class="sd">    `apply` should be None or `func` to transform each captured line.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;|&quot;</span> <span class="ow">in</span> <span class="n">start_match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;start_match should be a single match, so &#39;|&#39; character is not allowed.&quot;</span>
        <span class="p">)</span>
    <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># this is fast</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">n_start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">start_match</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nth_match</span> <span class="o">!=</span> <span class="n">n_start</span><span class="p">:</span>
                    <span class="n">n_start</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">matched</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="n">stop_match</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
            <span class="p">):</span>  <span class="c1"># avoid stop before start</span>
                <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_last</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">apply</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">apply</span><span class="p">)</span> <span class="k">else</span> <span class="n">line</span>
                <span class="k">break</span>  <span class="c1"># stop reading</span>
            <span class="k">if</span> <span class="n">matched</span><span class="p">:</span>  <span class="c1"># should be after break to handle last line above</span>
                <span class="k">yield</span> <span class="n">apply</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">apply</span><span class="p">)</span> <span class="k">else</span> <span class="n">line</span></div>

<div class="viewcode-block" id="Vasprun"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Vasprun</span><span class="p">(</span><span class="n">DataSource</span><span class="p">):</span>
    <span class="s2">&quot;Reads vasprun.xml file lazily. It reads only the required data from the file when a plot or data access is requested.&quot;</span>
    <span class="c1"># These methods are accessible from parent class, but need here for including in sphinx documentation</span>
    <span class="n">get_evals_dataframe</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">get_evals_dataframe</span>
    <span class="n">poscar</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">poscar</span>
    <span class="n">dos</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">dos</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="n">DataSource</span><span class="o">.</span><span class="n">bands</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./vasprun.xml&quot;</span><span class="p">,</span> <span class="n">skipk</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">skipk</span><span class="p">)</span>

<div class="viewcode-block" id="Vasprun.read"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.read">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_match</span><span class="p">,</span> <span class="n">stop_match</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="n">nth_match</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">apply</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads a part of the file between start_match and stop_match and returns a generator. It is lazy and fast.</span>
<span class="sd">        `start_match` and `stop_match`(default is end of same line) are regular expressions. `nth_match` is the number of occurence of start_match to start reading.</span>
<span class="sd">        `skip_last` is used to determine whether to keep or skip last line.</span>
<span class="sd">        `apply` should be None or `func` to transform each captured line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span><span class="s1">&#39;self&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_skipk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the number of k-points to skip in band structure plot in case of HSE calculation.&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">v</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;varray.*weights&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/varray&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

<div class="viewcode-block" id="Vasprun.get_summary"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_summary">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns summary data of calculation.&quot;</span>
        <span class="n">incar</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;incar&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/incar&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">:</span> <span class="n">incar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span> <span class="c1"># some people don&#39;t write system in incar</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;ISPIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*ISPIN&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">text</span>
        <span class="p">)</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;NKPTS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">v</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;varray.*kpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/varray&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">_nbands</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*NBANDS[</span><span class="se">\&quot;\&#39;</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">),</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*NBANDS[</span><span class="se">\&quot;\&#39;</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">,</span><span class="n">nth_match</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;NBANDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="c1"># Bad initializations of NBANDS, read last one</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">_nbands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">text</span> 
        <span class="p">)</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;NELECTS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*NELECT&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Beacuse they are poorly writtern as float, come on VASP!</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;LSORBIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;t&quot;</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*LSORBIT&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">else</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;EFERMI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*efermi&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">),</span> <span class="c1"># not always there but this is correct one</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*EFERMI&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">)</span> <span class="c1"># zero, always there in start</span>
            <span class="p">)))</span><span class="o">.</span><span class="n">text</span> 
        <span class="p">)</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;NEDOS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;i.*NEDOS&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">text</span>
        <span class="p">)</span>

        <span class="c1"># Getting ions is kind of terrbile, but it works</span>
        <span class="n">atominfo</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;atominfo&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/atominfo&quot;</span><span class="p">))</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;NIONS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atominfo</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;atoms&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">_type</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">atominfo</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;types&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">rc</span> <span class="ow">in</span> <span class="n">atominfo</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;rc&quot;</span><span class="p">)]</span>
        <span class="n">_inds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">[</span><span class="o">-</span><span class="n">types</span><span class="p">:]]</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">_inds</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># for keeping order, do not use unique or set</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">[:</span><span class="o">-</span><span class="n">types</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span> 
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                
        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;types&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

        <span class="c1"># Getting projection fields</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; &gt;&lt;/</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;partial&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;set&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;field&quot;</span> <span class="ow">in</span> <span class="n">f</span>
        <span class="p">]</span>  <span class="c1"># poor formatting again</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="o">*</span><span class="n">others</span><span class="p">,</span> <span class="n">sets_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;partial&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/partial&gt;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;spin &quot;</span> <span class="ow">in</span> <span class="n">r</span>
            <span class="p">]</span>  <span class="c1"># Least worse way to read sets</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;NSETS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">,</span> <span class="n">sets_lines</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;orbs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="s2">&quot;energy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

        <span class="n">info_dict</span><span class="p">[</span><span class="s2">&quot;incar&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">incar</span> <span class="c1"># Just at end</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vasprun.get_structure"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_structure">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns a structure object including types, basis, rec_basis and positions.&quot;</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;structure.*finalpos&quot;</span><span class="p">,</span> <span class="s2">&quot;select|&lt;/structure&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;v&gt;&quot;</span> <span class="ow">in</span> <span class="n">v</span>
            <span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># Stop at selctive dynamics if exists</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;SYSTEM&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span>
                <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">arrays</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;rec_basis&quot;</span><span class="p">:</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span>
                <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">:],</span>
                <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">types</span><span class="p">,</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;Exported from vasprun.xml&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cartesian&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Vasprun.get_kpoints"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_kpoints">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_kpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns k-points data including kpoints, coords, weights and rec_basis in which coords are calculated.&quot;</span>
        <span class="n">kpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;varray.*kpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/varray&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span> <span class="p">:]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">v</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;varray.*weights&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/varray&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span> <span class="p">:]</span>
        <span class="c1"># Get rec_basis to make cartesian coordinates</span>
        <span class="n">rec_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;structure.*finalpos&quot;</span><span class="p">,</span> <span class="s2">&quot;select|&lt;/structure&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;v&gt;&quot;</span> <span class="ow">in</span> <span class="n">v</span>
            <span class="p">]</span>
        <span class="p">)[</span>
            <span class="mi">3</span><span class="p">:</span><span class="mi">6</span>
        <span class="p">]</span>  <span class="c1"># could be selective dynamics there</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">kpoints</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rec_basis</span><span class="p">)</span>  <span class="c1"># cartesian coordinates</span>
        <span class="n">kpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">kpath</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">kpath</span> <span class="o">/</span> <span class="n">kpath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># normalized kpath to see the band structure of all materials in same scale</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;kpoints&quot;</span><span class="p">:</span> <span class="n">kpoints</span><span class="p">,</span>
                <span class="s2">&quot;coords&quot;</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span>
                <span class="s2">&quot;kpath&quot;</span><span class="p">:</span> <span class="n">kpath</span><span class="p">,</span>
                <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
                <span class="s2">&quot;rec_basis&quot;</span><span class="p">:</span> <span class="n">rec_basis</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Vasprun.get_dos"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_dos">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_dos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ezero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns energy, total and integrated dos of the calculation. If atoms and orbs are specified, then partial dos are included too.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        elim : tuple, energy range to be returned. Default is None, which returns full range. `elim` is applied around `ezero` if specified, otherwise around VBM.</span>
<span class="sd">        ezero : float, energy reference to be used. Default is None, which uses VBM as reference. ezero is ignored if elim is not specified. In output data, ezero would be VBM or ezero itself if specified.</span>
<span class="sd">        atoms : list/tuple/range, indices of atoms to be returned. Default is None, which does not return ionic projections.</span>
<span class="sd">        orbs : list/tuple/range, indices of orbitals to be returned. Default is None, which does not return orbitals.</span>
<span class="sd">        spins : list/tuple/range of spin sets indices to pick. If None, spin set will be picked 0 or [0,1] if spin-polarized. Default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict2Data : object which includes `energy`,&#39;tdos` and `idos` as attributes, and includes `pdos` if atoms and orbs specified. Shape of arrays a is (spins, [atoms, orbs], energy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;total&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/total&gt;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;&lt;r&gt;&quot;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ds</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">)</span>  <span class="c1"># flatten</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NEDOS</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># E, total, integrated</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No dos data found in the file!&quot;</span><span class="p">)</span>

        <span class="n">en</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">integrad</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">vbm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">en</span><span class="p">[(</span><span class="n">integrad</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NELECTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">integrad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># second condition is important</span>
        <span class="n">cbm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">en</span><span class="p">[(</span><span class="n">integrad</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NELECTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">integrad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="n">zero</span> <span class="o">=</span> <span class="n">vbm</span>
        <span class="n">grid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">en</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># default range full</span>
        <span class="k">if</span> <span class="n">elim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elim</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elim</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;elim should be a tuple of length 2&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ezero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ezero</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ezero should be a float or integer&quot;</span><span class="p">)</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="n">ezero</span>

            <span class="n">_max</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">en</span> <span class="o">-</span> <span class="n">zero</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># +1 to make range inclusive</span>
            <span class="n">_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">en</span> <span class="o">-</span> <span class="n">zero</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">en</span><span class="p">[:,</span> <span class="n">_min</span><span class="p">:</span><span class="n">_max</span><span class="p">]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="p">[:,</span> <span class="n">_min</span><span class="p">:</span><span class="n">_max</span><span class="p">]</span>
            <span class="n">integrad</span> <span class="o">=</span> <span class="n">integrad</span><span class="p">[:,</span> <span class="n">_min</span><span class="p">:</span><span class="n">_max</span><span class="p">]</span>
            <span class="n">grid_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">_min</span><span class="p">,</span> <span class="n">_max</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="n">en</span><span class="p">,</span>
            <span class="s2">&quot;tdos&quot;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s2">&quot;idos&quot;</span><span class="p">:</span> <span class="n">integrad</span><span class="p">,</span>
            <span class="s2">&quot;evc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">vbm</span><span class="p">,</span> <span class="n">cbm</span><span class="p">),</span>
            <span class="s2">&quot;ezero&quot;</span><span class="p">:</span> <span class="n">zero</span><span class="p">,</span>
            <span class="s2">&quot;elim&quot;</span><span class="p">:</span> <span class="n">elim</span><span class="p">,</span>
            <span class="s2">&quot;spins&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">en</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">and</span> <span class="n">orbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;partial&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">):</span>  <span class="c1"># no partial dos, hust check that line</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No partial dos found in the file!&quot;</span><span class="p">)</span>

            <span class="n">which_spins</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">en</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">spins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spins</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;spins should be a list, tuple or range got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">spins</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NSETS</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;spins should be a tuple/list/range of positive integers in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NSETS</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="n">which_spins</span> <span class="o">=</span> <span class="n">spins</span>

            <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">/&lt;&gt;r&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;partial&gt;&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;/partial&gt;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;&lt;r&gt;&quot;</span> <span class="ow">in</span> <span class="n">r</span>
            <span class="p">)</span>  <span class="c1"># stripping is must here to ensure that we get only numbers</span>
            <span class="n">old_shape</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NIONS</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NSETS</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NEDOS</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">orbs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">gen2numpy</span><span class="p">(</span>
                <span class="n">gen</span><span class="p">,</span>
                <span class="n">old_shape</span><span class="p">,</span>
                <span class="n">slices</span><span class="o">=</span><span class="p">[</span><span class="n">atoms</span><span class="p">,</span> <span class="n">which_spins</span><span class="p">,</span> <span class="n">grid_range</span><span class="p">,</span> <span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">orbs</span><span class="p">]],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># No need to pick up the first column as it is the energy</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;pdos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># (spins, atoms, orbitsl,energy)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;orbs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbs</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;spins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">which_spins</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">orbs</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atoms and orbs should be specified together&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;(spin, [atoms, orbitals], energy)&quot;</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_spin_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">sys_info</span><span class="p">):</span>
        <span class="s2">&quot;sys_info is the summary data of calculation, used to get the shape of the array.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys_info</span><span class="p">,</span> <span class="s2">&quot;orbs&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">!r}</span><span class="s2"> does not have projected orbitals!&quot;</span>
            <span class="p">)</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys_info</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">,</span> <span class="n">sys_info</span><span class="o">.</span><span class="n">NBANDS</span><span class="p">,</span> <span class="n">sys_info</span><span class="o">.</span><span class="n">NIONS</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys_info</span><span class="o">.</span><span class="n">orbs</span><span class="p">))</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span><span class="p">,</span> <span class="n">sys_info</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">),</span> <span class="n">bands</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">orbs</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spin</span><span class="si">{</span><span class="n">spin</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Given </span><span class="si">{</span><span class="n">spin</span><span class="si">}</span><span class="s2"> index for spin is larger than available in the file!&quot;</span>
            <span class="p">)</span>

        <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">/&lt;&gt;r&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;spin</span><span class="si">{</span><span class="n">spin</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;spin</span><span class="si">{</span><span class="n">spin</span><span class="o">+</span><span class="mi">2</span><span class="si">}</span><span class="s2">|&lt;/projected&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;&lt;r&gt;&quot;</span> <span class="ow">in</span> <span class="n">r</span>
        <span class="p">)</span>  <span class="c1"># stripping is must here to ensure that we get only numbers</span>
        <span class="k">return</span> <span class="n">gen2numpy</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">slices</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># (atoms, orbs, kpts, bands)</span>

<div class="viewcode-block" id="Vasprun.get_evals"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_evals">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_evals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">elim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ezero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns eigenvalues and occupations of the calculation. If atoms and orbs are specified, then orbitals are included too.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        elim : tuple, energy range to be returned. Default is None, which returns all eigenvalues. `elim` is applied around `ezero` if specified, otherwise around VBM.</span>
<span class="sd">        ezero : float, energy reference to be used. Default is None, which uses VBM as reference. ezero is ignored if elim is not specified. In output data, ezero would be VBM or ezero itself if specified.</span>
<span class="sd">        atoms : list/tuple/range, indices of atoms to be returned. Default is None, which does not return ionic projections.</span>
<span class="sd">        orbs : list/tuple/range, indices of orbitals to be returned. Default is None, which does not return orbitals.</span>
<span class="sd">        spins : list/tuple/range of spin sets indices to pick. If None, spin set will be picked 0 or [0,1] if spin-polarized. Default is None.</span>
<span class="sd">        bands : list/tuple/range, indices of bands to pick. overrides elim. Useful to load same bands range for spin up and down channels. Plotting classes automatically handle this for spin up and down channels.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict2Data object which includes `evals` and `occs` as attributes, and `pros` if atoms and orbs specified. Shape arrays is (spin, [atoms, orbitals], kpts, bands)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span>
        <span class="n">bands_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">NBANDS</span><span class="p">)</span>

        <span class="n">ev</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;eigenvalues&gt;&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;/eigenvalues&gt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;&lt;r&gt;&quot;</span> <span class="ow">in</span> <span class="n">r</span>
        <span class="p">)</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span> <span class="k">for</span> <span class="n">es</span> <span class="ow">in</span> <span class="n">ev</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">es</span><span class="p">)</span>  <span class="c1"># flatten</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>  <span class="c1"># if not empty</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">NKPTS</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">NBANDS</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[</span>
                <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skipk</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span>
            <span class="p">]</span>  <span class="c1"># shape is (NSPIN, NKPTS, NBANDS, 2)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No eigenvalues found in this file!&quot;</span><span class="p">)</span>
        <span class="n">evals</span><span class="p">,</span> <span class="n">occs</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ev</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sv</span><span class="p">,</span> <span class="n">kv</span><span class="p">,</span> <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">evals</span> <span class="o">==</span> <span class="n">evals</span><span class="p">[</span><span class="n">occs</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># more than half filled indices</span>
        <span class="n">sc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="n">ec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">evals</span> <span class="o">==</span> <span class="n">evals</span><span class="p">[</span><span class="n">occs</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># less than half filled indices</span>
        <span class="n">evc</span><span class="p">,</span> <span class="n">kvc</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span>  <span class="c1"># default values are empty</span>

        <span class="k">if</span> <span class="n">sv</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>  <span class="c1"># if both are not empty</span>
            <span class="n">evc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="n">sv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ev</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ec</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
            <span class="n">zero</span> <span class="o">=</span> <span class="n">evc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># default value of ezero</span>
            <span class="c1"># svc = (sv[0],sc[0]) # spin indices, implement later if needed</span>
            <span class="n">kvc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">kv</span><span class="p">,</span> <span class="n">kc</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">K</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">K</span><span class="p">)))[</span>
                <span class="mi">0</span>
            <span class="p">]</span>  <span class="c1"># bring closer points first by sorting and take closest ones</span>

        <span class="k">if</span> <span class="n">ezero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ezero</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ezero should be a float or integer&quot;</span><span class="p">)</span>
            <span class="n">zero</span> <span class="o">=</span> <span class="n">ezero</span>
        
        <span class="k">if</span> <span class="n">bands</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;bands should be a list, tuple or range got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bands</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;bands should be a tuple/list/range of positive integers&quot;</span>
                    <span class="p">)</span>
            <span class="n">_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">evals</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">_bands</span><span class="p">]</span>
            <span class="n">occs</span> <span class="o">=</span> <span class="n">occs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">_bands</span><span class="p">]</span>
            <span class="n">bands_range</span> <span class="o">=</span> <span class="n">_bands</span>
        <span class="k">elif</span> <span class="n">elim</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elim</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elim</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;elim should be a tuple of length 2&quot;</span><span class="p">)</span>

            <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span> <span class="o">-</span> <span class="n">zero</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">idx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span> <span class="o">-</span> <span class="n">zero</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">evals</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx_min</span><span class="p">:</span><span class="n">idx_max</span><span class="p">]</span>
            <span class="n">occs</span> <span class="o">=</span> <span class="n">occs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx_min</span><span class="p">:</span><span class="n">idx_max</span><span class="p">]</span>
            <span class="n">bands_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx_min</span><span class="p">,</span> <span class="n">idx_max</span><span class="p">)</span>

        <span class="n">which_spins</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="n">evals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>  <span class="c1"># which spin set to pick, defult is what is available</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;evals&quot;</span><span class="p">:</span> <span class="n">evals</span><span class="p">,</span>
            <span class="s2">&quot;occs&quot;</span><span class="p">:</span> <span class="n">occs</span><span class="p">,</span>
            <span class="s2">&quot;ezero&quot;</span><span class="p">:</span> <span class="n">zero</span><span class="p">,</span>
            <span class="s2">&quot;elim&quot;</span><span class="p">:</span> <span class="n">elim</span><span class="p">,</span>
            <span class="s2">&quot;evc&quot;</span><span class="p">:</span> <span class="n">evc</span><span class="p">,</span>
            <span class="s2">&quot;kvc&quot;</span><span class="p">:</span> <span class="n">kvc</span><span class="p">,</span>
            <span class="s2">&quot;bands&quot;</span><span class="p">:</span> <span class="n">bands_range</span><span class="p">,</span>
            <span class="s2">&quot;spins&quot;</span><span class="p">:</span> <span class="n">which_spins</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">and</span> <span class="n">orbs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spins</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;spins should be a list, tuple or range got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">spins</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NSETS</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;spins should be a tuple/list/range of positive integers in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">NSETS</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="n">which_spins</span> <span class="o">=</span> <span class="n">spins</span>

            <span class="n">pros</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">which_spins</span><span class="p">:</span>
                <span class="n">pros</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_spin_set</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">bands_range</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">orbs</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;pros&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pros</span><span class="p">)</span>  <span class="c1"># (spins, atoms, orbitals, kpoints, bands)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;orbs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbs</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;spins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">which_spins</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">orbs</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;atoms and orbs should be passed together&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;(spins, [atoms, orbitals], kpoints, bands)&quot;</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vasprun.get_forces"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_forces">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Reads force on each ion from vasprun.xml&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;varray.*forces&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/varray&gt;&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)])</span></div>

<div class="viewcode-block" id="Vasprun.get_scsteps"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.get_scsteps">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_scsteps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Reads all self-consistent steps from vasprun.xml&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstringlist</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;&lt;steps&gt;&quot;</span><span class="p">,</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;.*scstep&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;structure&gt;&quot;</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;&lt;/steps&gt;&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># poor formatting</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">):</span>
            <span class="n">_d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;_en&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
                    <span class="n">_d</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arrays</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span></div>

<div class="viewcode-block" id="Vasprun.minify"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.Vasprun.minify">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">minify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Removes partial dos and projected eigenvalues data from large vasprun.xml to make it smaller in size to save on disk.&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;mini-vasprun.xml&quot;</span>
        <span class="n">lines_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;xml&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;partial&quot;</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lines_2</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;/partial&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;projected&quot;</span><span class="p">,</span> <span class="n">skip_last</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">lines_3</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;&lt;/projected&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/xml&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">lines_1</span><span class="p">,</span> <span class="n">lines_2</span><span class="p">,</span> <span class="n">lines_3</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minified vasprun.xml saved at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span></div></div>


<div class="viewcode-block" id="xml2dict"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.xml2dict">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">xml2dict</span><span class="p">(</span><span class="n">xmlnode_or_filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert xml node or xml file content to dictionary.</span>
<span class="sd">    All output text is in string format, so further processing is required to convert into data types/split etc.</span>

<span class="sd">    Each node has ``tag,text,attr,nodes`` attributes. Every text element can be accessed via</span>
<span class="sd">    ``xml2dict()[&#39;nodes&#39;][index][&#39;nodes&#39;][index]...`` tree which makes it simple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xmlnode_or_filepath</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xmlnode_or_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">xmlnode_or_filepath</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xml2dict</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s2">&quot;attr&quot;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">}</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">gen2numpy</span><span class="p">(</span>
    <span class="n">gen</span><span class="p">,</span>
    <span class="n">shape</span><span class="p">,</span>
    <span class="n">slices</span><span class="p">,</span>
    <span class="n">raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span>
    <span class="n">include</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span>
    <span class="n">fix_format</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a generator of text lines to numpy array while excluding comments, given matches and empty lines.</span>
<span class="sd">    Data is sliced and reshaped as per given shape and slices. It is very efficient for large data files to fetch only required data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gen : generator</span>
<span class="sd">        Typical example is `with open(&#39;file.txt&#39;) as f: gen = itertools.islice(f,0,None)`</span>
<span class="sd">    shape : tuple</span>
<span class="sd">        Tuple or list of integers. Given shape of data to be read. Last item is considered to be columns.</span>
<span class="sd">        User should keep track of empty lines and excluded lines.</span>
<span class="sd">    slices : tuple</span>
<span class="sd">        Tuple or list of integers or range or -1. Given slices of data to be read along each dimension.</span>
<span class="sd">        Last item is considered to be columns.</span>
<span class="sd">    raw : bool</span>
<span class="sd">        Returns raw data for quick visualizing and determining shape such as columns, if True.</span>
<span class="sd">    dtype : object</span>
<span class="sd">        Data type of numpy array to be returned. Default is float.</span>
<span class="sd">    delimiter : str</span>
<span class="sd">        Delimiter of data in text file.</span>
<span class="sd">    include : str</span>
<span class="sd">        Match to include in each line to be read. If None, all lines are included.</span>
<span class="sd">    exclude : str</span>
<span class="sd">        Match to exclude in each line to be read. If None, no lines are excluded.</span>
<span class="sd">    fix_format : bool</span>
<span class="sd">        If True, it will fix the format of data in each line. It is useful when data is not properly formatted. like 0.500-0.700 -&gt; 0.500 -0.700</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        numpy array of given shape and dtype.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape must be a list/tuple of size of dimensions.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;slices must be a list/tuple of size of dimensions.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape and slices must be of same size.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Each item in shape must be integer of size of that dimension, at least 1.&quot;</span>
            <span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sli</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slices</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sli</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expect -1 to pick all data or list/tuple/range to slice data in a dimension, got </span><span class="si">{</span><span class="n">sli</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sli</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sli</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expect -1 to pick all data or list/tuple/range to slice data in a dimension, got </span><span class="si">{</span><span class="n">sli</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sli</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sli</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect non-empty items in slices, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sli</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Verify order, index and values in take</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sli</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sli</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect integers in a slice, got </span><span class="si">{</span><span class="n">sli</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sli</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect positive integers in a slice, got </span><span class="si">{</span><span class="n">sli</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sli</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Some indices in slice </span><span class="si">{</span><span class="n">sli</span><span class="si">}</span><span class="s2"> are out of bound for dimension </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> of size </span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sli</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sli</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>  <span class="c1"># Check order</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect increasing order in a slice, got </span><span class="si">{</span><span class="n">sli</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">sli</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sli</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">))</span> <span class="k">else</span> <span class="n">N</span>
            <span class="k">for</span> <span class="n">sli</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">new_shape</span><span class="p">))</span>  <span class="c1"># include columns here for overall data count.</span>

    <span class="c1"># Process generator</span>
    <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gen</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gen</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gen</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># remove empty lines</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span>
        <span class="n">gen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="p">)</span>  <span class="c1"># Discard lines after required data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fold_dim</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">take</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">take</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">gen</span>  <span class="c1"># return does not work here.</span>

        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">take</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">,))</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">yield</span> <span class="n">group</span>
                <span class="n">group</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">flatten</span><span class="p">(</span><span class="n">gen</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">yield from</span> <span class="n">flatten</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">g</span>

    <span class="c1"># Slice data, but we keep columns here for now, should return raw data if asked.</span>
    <span class="c1"># reverse order to pick innermost first but leave columns</span>
    <span class="k">for</span> <span class="n">take</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">slices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">fold_dim</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">take</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># flatter on success</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

    <span class="c1"># Negative connected digits to avoid fix after slicing to reduce time.</span>
    <span class="k">if</span> <span class="n">fix_format</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d)-(\d)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1 -\2&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>  <span class="c1"># lines already have &#39;\n&#39; at the end.</span>

    <span class="c1"># Split columns and flatten after escaped from raw return.</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">gen</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">fold_dim</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">slices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># columns</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>


<div class="viewcode-block" id="minify_vasprun"><a class="viewcode-back" href="../../../modules.html#ipyvasp.core.parser.minify_vasprun">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">minify_vasprun</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="s2">&quot;Minify vasprun.xml file by removing projected data.&quot;</span>
    <span class="k">return</span> <span class="n">Vasprun</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">minify</span><span class="p">()</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">export_outcar</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Read potential at ionic sites from OUTCAR file.&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;./OUTCAR&quot;</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="c1"># Raeding it</span>
    <span class="k">with</span> <span class="n">P</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="c1"># Processing</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;NIONS&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;electrostatic&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="n">stop_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">nlines</span>
        <span class="k">if</span> <span class="s2">&quot;fractional&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;vectors are now&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">b_first</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span>

    <span class="c1"># Data manipulation</span>
    <span class="c1"># Potential</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">stop_index</span><span class="p">]</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">pot_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">initial</span><span class="p">,</span> <span class="n">last</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">pot_arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Ion index fixing</span>
    <span class="c1"># Nearest neighbors</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">first</span> <span class="p">:</span> <span class="n">first</span> <span class="o">+</span> <span class="n">N</span><span class="p">]</span>
    <span class="n">pos_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span>
    <span class="n">pos_arr</span><span class="p">[</span><span class="n">pos_arr</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_arr</span><span class="p">[</span><span class="n">pos_arr</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Fixing outer layers</span>
    <span class="c1"># positions and potential</span>
    <span class="n">pos_pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">pos_arr</span><span class="p">,</span> <span class="n">pot_arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]])</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">b_first</span> <span class="p">:</span> <span class="n">b_first</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])))</span>
    <span class="n">final_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ion_pot&quot;</span><span class="p">:</span> <span class="n">pot_arr</span><span class="p">,</span>
        <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="n">pos_arr</span><span class="p">,</span>
        <span class="s2">&quot;site_pot&quot;</span><span class="p">:</span> <span class="n">pos_pot</span><span class="p">,</span>
        <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span>
        <span class="s2">&quot;rec_basis&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">OutcarData</span><span class="p">(</span><span class="n">final_dict</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">export_locpot</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_set</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns Data from LOCPOT and similar structure files like CHG/PARCHG etc. Loads only single set based on what is given in data_set argument.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    locpot : str, path/to/LOCPOT or similar stuructured file like CHG. LOCPOT is auto picked in CWD.</span>
<span class="sd">    data_set : int, 0 for electrostatic data, 1 for magnetization data if ISPIN = 2. If non-colinear calculations, 1,2,3 will pick Mx,My,Mz data sets respectively. Only one data set is loaded, so you should know what you are loading.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GridData : ``ipyvasp.serializer.GridData`` object with 3D volumetric data set loaded as attribute &#39;values&#39;.</span>

<span class="sd">    Exceptions</span>
<span class="sd">    ----------</span>
<span class="sd">    Would raise index error if magnetization density set is not present in case ``data_set &gt; 0``.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Read `vaspwiki-CHGCAR &lt;https://www.vasp.at/wiki/index.php/CHGCAR&gt;`_ for more info on what data sets are available corresponding to different calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;./LOCPOT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{!r}</span><span class="s2"> does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">data_set</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">data_set</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;`data_set` should be 0 (for electrostatic),1 (for M or Mx),2 (for My),3 (for Mz)! Got </span><span class="si">{</span><span class="n">data_set</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># data fixing after reading islice from file.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fix_data</span><span class="p">(</span><span class="n">islice_gen</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_gen</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">islice_gen</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">COUNT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
                <span class="n">new_gen</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">COUNT</span>
            <span class="p">)</span>  <span class="c1"># Count is must for performance</span>
            <span class="c1"># data written on LOCPOT is in shape of (NGz,NGy,NGx)</span>
            <span class="n">N_reshape</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_reshape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{!r}</span><span class="s2"> may not be in proper format!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                    <span class="s2">&quot;Magnetization density may not be present in </span><span class="si">{!r}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="c1"># Reading File</span>
    <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">poscar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">poscar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># Empty one</span>
        <span class="n">Nxyz</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>  <span class="c1"># Grid line read</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Nxyz</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># islice is faster generator for reading potential</span>
        <span class="n">pot_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">nlines</span><span class="p">),</span> <span class="n">Nxyz</span><span class="p">)})</span>
            <span class="n">ignore_set</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Pointer already ahead.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ignore_set</span> <span class="o">=</span> <span class="n">nlines</span>  <span class="c1"># Needs to move pointer to magnetization</span>
        <span class="c1"># reading Magnetization if True</span>
        <span class="n">ignore_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Some kind of useless data</span>
        <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Note: data_set = 1 picks Mx for non-colinear case, and M for ISPIN = 2.&quot;</span>
            <span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">ignore_n</span> <span class="o">+</span> <span class="n">ignore_set</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">nlines</span><span class="p">),</span> <span class="n">Nxyz</span><span class="p">)}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ignore_n</span> <span class="o">+</span> <span class="n">nlines</span> <span class="o">+</span> <span class="n">ignore_set</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">nlines</span><span class="p">),</span> <span class="n">Nxyz</span><span class="p">)}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ignore_n</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nlines</span> <span class="o">+</span> <span class="n">ignore_set</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">nlines</span><span class="p">),</span> <span class="n">Nxyz</span><span class="p">)}</span>
            <span class="p">)</span>

    <span class="c1"># Read Info</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.._lattice</span><span class="w"> </span><span class="kn">import</span> <span class="n">export_poscar</span>  <span class="c1"># Keep inside to avoid import loop</span>

    <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">export_poscar</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poscar</span><span class="p">))</span>
    <span class="n">final_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">SYSTEM</span><span class="o">=</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="o">**</span><span class="n">pot_dict</span><span class="p">,</span> <span class="n">poscar</span><span class="o">=</span><span class="n">poscar_data</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">GridData</span><span class="p">(</span><span class="n">final_dict</span><span class="p">)</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Abdul Saboor
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=e7e13039"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    </body>
</html>