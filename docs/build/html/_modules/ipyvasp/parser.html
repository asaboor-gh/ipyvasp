<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <meta name="generator" content="sphinx-5.1.1, furo 2022.06.21"/>
        <title>ipyvasp.parser - ipyvasp 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ipyvasp 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">ipyvasp 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc.html">API</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for ipyvasp.parser</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">serializer</span>
<span class="c1">#from ipyvasp import utils, serializer</span>


<div class="viewcode-block" id="dict2tuple"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.dict2tuple">[docs]</a><span class="k">def</span> <span class="nf">dict2tuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a dictionary (nested as well) to namedtuple, accessible via index and dot notation as well as by unpacking.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the namedtuple</span>
<span class="sd">    d : dict</span>
<span class="sd">        Dictionary to be converted to namedtuple. It can be nested as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())(</span>
           <span class="o">*</span><span class="p">(</span><span class="n">dict2tuple</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
           <span class="p">)</span></div>

<div class="viewcode-block" id="read_asxml"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.read_asxml">[docs]</a><span class="k">def</span> <span class="nf">read_asxml</span><span class="p">(</span><span class="n">path</span> <span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a big vasprun.xml file into memory once and then apply commands. If current folder contains ``vasprun.xml`` file, it automatically picks it.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path/To/vasprun.xml</span>

<span class="sd">    Returns</span>
<span class="sd">        ``XML element tree`` to use in other functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;./vasprun.xml&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File: &#39;</span><span class="si">{}</span><span class="s2">&#39;&#39; does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">elif</span> <span class="s1">&#39;vasprun.xml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;File name should end with &#39;vasprun.xml&#39;&quot;</span><span class="p">)</span>

    <span class="n">fsize</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_file_size</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fsize</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">print_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Memory Consumption Warning!</span>
<span class="s2">    ---------------------------</span>
<span class="s2">    File: </span><span class="si">{}</span><span class="s2"> is large (</span><span class="si">{}</span><span class="s2">). It may consume a lot of memory (generally 3 times the file size).</span>
<span class="s2">        An alternative way is to use `ipyvasp.split_vasprun()` to split the file into multiple files and then read resulting &#39;_vasprun.xml&#39; file.</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;MB&#39;</span> <span class="ow">in</span> <span class="n">fsize</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">print_str</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="s1">&#39;GB&#39;</span> <span class="ow">in</span> <span class="n">fsize</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">print_str</span><span class="p">)))</span>
        
    <span class="n">nt</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;VasprunXML&#39;</span><span class="p">,[</span><span class="s1">&#39;path&#39;</span><span class="p">,</span><span class="s1">&#39;root&#39;</span><span class="p">])</span> <span class="c1"># Safe and full of info</span>
    <span class="k">return</span> <span class="n">nt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">getroot</span><span class="p">())</span> <span class="c1"># THis is xml_data for other functions</span></div>

<div class="viewcode-block" id="xml2dict"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.xml2dict">[docs]</a><span class="k">def</span> <span class="nf">xml2dict</span><span class="p">(</span><span class="n">xmlnode_or_filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert xml node or xml file content to dictionary. All output text is in string format, so further processing is required to convert into data types/split etc.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        xmlnode_or_filepath: It is either a path to an xml file or an ``xml.etree.ElementTree.Element`` object.</span>
<span class="sd">        </span>
<span class="sd">    Each node has ``tag,text,attr,nodes`` attributes. Every text element can be accessed via</span>
<span class="sd">    ``xml2dict()[&#39;nodes&#39;][index][&#39;nodes&#39;][index]...`` tree which makes it simple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xmlnode_or_filepath</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">read_asxml</span><span class="p">(</span><span class="n">xmlnode_or_filepath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">xmlnode_or_filepath</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">xml2dict</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">:</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">}</span></div>

<div class="viewcode-block" id="exclude_kpts"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.exclude_kpts">[docs]</a><span class="k">def</span> <span class="nf">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kpts</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;weights&#39;</span><span class="p">}):</span>
            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">kpts</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
    <span class="n">exclude</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">[</span><span class="n">exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">item</span><span class="o">!=</span><span class="n">weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
    <span class="n">skipk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span> <span class="c1">#that much to skip</span>
    <span class="k">return</span> <span class="n">skipk</span></div>

<div class="viewcode-block" id="get_ispin"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_ispin">[docs]</a><span class="k">def</span> <span class="nf">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ISPIN&#39;</span><span class="p">}):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="get_force"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_force">[docs]</a><span class="k">def</span> <span class="nf">get_force</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="s2">&quot;Reads force on each ion from vasprun.xml&quot;</span>
    <span class="n">forces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;forces&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">):</span>
                <span class="n">forces</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">forces</span><span class="p">,</span> <span class="o">*</span><span class="n">subnode</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    
    <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">forces</span></div>

<div class="viewcode-block" id="get_scsteps"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_scsteps">[docs]</a><span class="k">def</span> <span class="nf">get_scsteps</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="s2">&quot;Reads scsteps energies from vasprun.xml&quot;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;scstep&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">):</span>
            <span class="n">_d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;_en&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                    <span class="n">_d</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">arrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">arrays</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>


<div class="viewcode-block" id="get_space_info"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_space_info">[docs]</a><span class="k">def</span> <span class="nf">get_space_info</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">xml_data</span><span class="o">.</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s1">&#39;OUTCAR&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s2"> not found. OUTCAR file should be in same directory as of </span><span class="si">{</span><span class="n">xml_data</span><span class="o">.</span><span class="n">path</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
    
    <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">pos_line</span> <span class="o">=</span> <span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;^positions|^\s+positions&#39;</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;cartesian_positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">in</span> <span class="n">pos_line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
    
    <span class="n">k_line</span> <span class="o">=</span> <span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">include</span> <span class="o">=</span> <span class="s1">&#39;^k-points|^\s+k-points&#39;</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;cartesian_kpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">in</span> <span class="n">k_line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">two_pi</span><span class="p">,</span> <span class="n">reciprocal</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;2pi/SCALE.*position&#39;</span><span class="p">,</span><span class="n">text</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;k-points&#39;</span><span class="p">)</span>
        <span class="n">reciprocal</span> <span class="o">=</span> <span class="n">reciprocal</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">two_pi</span> <span class="o">=</span> <span class="n">two_pi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="n">k_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reciprocal</span><span class="p">])</span>
    <span class="n">k_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">two_pi</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">final</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">final</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;finalpos&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;rec_basis&#39;</span><span class="p">:</span>
                    <span class="n">rec_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)])</span>
                    <span class="n">k_coords</span> <span class="o">=</span> <span class="n">k_rec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rec_basis</span><span class="p">)</span>
                    <span class="n">ks_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">k_scale</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">kc_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">k_coords</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">where</span> <span class="o">=</span> <span class="p">(</span><span class="n">kc_norm</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="c1"># Some kpoints may yield zero norm</span>
                    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ks_norm</span><span class="p">[</span><span class="n">where</span><span class="p">]</span><span class="o">/</span><span class="n">kc_norm</span><span class="p">[</span><span class="n">where</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">cartesian_kpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">k_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">k_scale</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;cartesian_kpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cartesian_kpath</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">info_dict</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="get_summary"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_summary">[docs]</a><span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i_car</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;incar&#39;</span><span class="p">):</span>
        <span class="n">incar</span><span class="o">=</span><span class="p">{</span><span class="n">car</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span><span class="n">car</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">car</span> <span class="ow">in</span> <span class="n">i_car</span><span class="p">}</span>
    <span class="n">n_ions</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;atoms&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">type_ions</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom_types</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom_types</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;types&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elem</span><span class="o">=</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;rc&#39;</span><span class="p">)]</span>
    <span class="n">elem_name</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#collect IONS names</span>
    <span class="p">[</span><span class="n">elem_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[:</span><span class="o">-</span><span class="n">type_ions</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elem_name</span><span class="p">]</span>
    <span class="n">elem_index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#start index</span>
    <span class="p">[</span><span class="n">elem_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="o">+</span><span class="n">elem_index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">[</span><span class="o">-</span><span class="n">type_ions</span><span class="p">:]];</span>
    <span class="n">ISPIN</span><span class="o">=</span><span class="n">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="n">NELECT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NELECT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Fields</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pro</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">):</span>
            <span class="n">dos_fields</span><span class="o">=</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)]</span>
            <span class="n">dos_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dos_fields</span> <span class="k">if</span> <span class="s1">&#39;energy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">dos_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span> <span class="c1">#efermi for condition required.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;efermi&#39;</span><span class="p">}):</span>
            <span class="n">efermi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    
    <span class="c1">#Writing information to a dictionary</span>
    <span class="n">space_info</span> <span class="o">=</span> <span class="n">get_space_info</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="n">info_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">incar</span><span class="p">[</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">],</span><span class="s1">&#39;NION&#39;</span><span class="p">:</span><span class="n">n_ions</span><span class="p">,</span><span class="s1">&#39;NELECT&#39;</span><span class="p">:</span><span class="n">NELECT</span><span class="p">,</span><span class="s1">&#39;TypeION&#39;</span><span class="p">:</span><span class="n">type_ions</span><span class="p">,</span>
              <span class="s1">&#39;ElemName&#39;</span><span class="p">:</span><span class="n">elem_name</span><span class="p">,</span><span class="s1">&#39;ElemIndex&#39;</span><span class="p">:</span><span class="n">elem_index</span><span class="p">,</span><span class="s1">&#39;Fermi&#39;</span><span class="p">:</span> <span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span>
              <span class="s1">&#39;fields&#39;</span><span class="p">:</span><span class="n">dos_fields</span><span class="p">,</span><span class="s1">&#39;incar&#39;</span><span class="p">:</span><span class="n">incar</span><span class="p">,</span> <span class="s1">&#39;space_info&#39;</span><span class="p">:</span><span class="n">space_info</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">info_dic</span><span class="p">)</span></div>

<div class="viewcode-block" id="join_ksegments"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.join_ksegments">[docs]</a><span class="k">def</span> <span class="nf">join_ksegments</span><span class="p">(</span><span class="n">kpath</span><span class="p">,</span><span class="n">kseg_inds</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Joins a broken kpath&#39;s next segment to previous. `kseg_inds` should be list of first index of next segment&quot;&quot;&quot;</span>
    <span class="n">path_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kseg_inds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">kseg_inds</span><span class="p">:</span>
            <span class="n">path_list</span><span class="p">[</span><span class="n">ind</span><span class="p">:]</span> <span class="o">-=</span> <span class="n">path_list</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">path_list</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_kpts"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_kpts">[docs]</a><span class="k">def</span> <span class="nf">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">kpts</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;kpointlist&#39;</span><span class="p">}):</span>
            <span class="n">kpoints</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">kpts</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
    <span class="n">kpoints</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpoints</span><span class="p">[</span><span class="n">skipk</span><span class="p">:])</span>
    <span class="c1">#KPath solved.</span>
    <span class="n">kpath</span> <span class="o">=</span> <span class="n">get_space_info</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">cartesian_kpath</span><span class="p">[</span><span class="n">skipk</span><span class="p">:]</span>
    <span class="n">kpath</span> <span class="o">=</span> <span class="n">kpath</span> <span class="o">-</span> <span class="n">kpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Shift to start at 0</span>
    <span class="n">kpath</span> <span class="o">=</span> <span class="n">kpath</span><span class="o">/</span><span class="n">kpath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Normaliz to 1 to see all bandstuructres on common axis in full range</span>
    <span class="c1"># Do Not Join KPath if it is broken, leave that to plotting functions</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;NKPTS&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">kpoints</span><span class="p">),</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="n">kpoints</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="n">kpath</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_tdos"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_tdos">[docs]</a><span class="k">def</span> <span class="nf">get_tdos</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">tdos</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#assign for safely exit if wrong spin set entered.</span>
    <span class="n">ISPIN</span> <span class="o">=</span> <span class="n">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;dos&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">tdos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
            <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">tdos_1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 2&#39;</span><span class="p">}):</span>
                    <span class="n">tdos_2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
                    <span class="n">tdos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">tdos_1</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">tdos_2</span><span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">spin_set</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#can get any</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spin_set</span><span class="p">)}):</span>
                    <span class="n">tdos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span> <span class="c1">#efermi for condition required.</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;efermi&#39;</span><span class="p">}):</span>
            <span class="n">efermi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">dos_dic</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tdos</span><span class="p">}</span>
    <span class="c1">#Filtering in energy range.</span>
    <span class="k">if</span> <span class="n">elim</span><span class="p">:</span> <span class="c1">#check if elim not empty</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span>
            <span class="n">tdos</span><span class="o">=</span><span class="n">tdos</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ISPIN</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">spin_set</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span>
            <span class="n">tdos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">tdos_1</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:],</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">tdos_2</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:]}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">spin_set</span><span class="o">!=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tdos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">efermi</span><span class="o">&gt;=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">)))</span>
            <span class="n">tdos</span><span class="o">=</span><span class="n">tdos</span><span class="p">[</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">,:]</span>
        <span class="n">dos_dic</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;grid_range&#39;</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">lo_ind</span><span class="p">,</span><span class="n">up_ind</span><span class="p">),</span><span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tdos</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">dos_dic</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_evals"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_evals">[docs]</a><span class="k">def</span> <span class="nf">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">elim</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="n">evals</span><span class="p">,</span> <span class="n">occs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span> <span class="c1">#assign for safely exit if wrong spin set entered.</span>
    <span class="n">ISPIN</span> <span class="o">=</span> <span class="n">get_ispin</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skipk</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">skipk</span> <span class="o">=</span> <span class="n">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#that much to skip by default</span>
    <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;eigenvalues&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">neighbor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">evals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span> <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])[</span><span class="n">skipk</span><span class="p">:]</span>
                    <span class="n">evals</span><span class="p">,</span> <span class="n">occs</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">evals</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">NBANDS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 1&#39;</span><span class="p">}):</span>
                    <span class="n">eval_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span> <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])[</span><span class="n">skipk</span><span class="p">:]</span>
                    <span class="n">eval_1</span><span class="p">,</span> <span class="n">occs_1</span> <span class="o">=</span> <span class="n">eval_1</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">eval_1</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin 2&#39;</span><span class="p">}):</span>
                    <span class="n">eval_2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">th</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">]</span> <span class="k">for</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])[</span><span class="n">skipk</span><span class="p">:]</span>
                    <span class="n">eval_2</span><span class="p">,</span> <span class="n">occs_2</span> <span class="o">=</span> <span class="n">eval_2</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">eval_2</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">evals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">eval_1</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">eval_2</span><span class="p">}</span>
                    <span class="n">occs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">occs_1</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">occs_2</span><span class="p">}</span>
                    <span class="n">NBANDS</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span> <span class="c1">#efermi for condition required.</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">attrib</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;efermi&#39;</span><span class="p">}:</span>
            <span class="n">efermi</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">evals_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Fermi&#39;</span><span class="p">:</span><span class="n">efermi</span><span class="p">,</span><span class="s1">&#39;ISPIN&#39;</span><span class="p">:</span><span class="n">ISPIN</span><span class="p">,</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">:</span><span class="n">NBANDS</span><span class="p">,</span><span class="s1">&#39;evals&#39;</span><span class="p">:</span><span class="n">evals</span><span class="p">,</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">NBANDS</span><span class="p">),</span><span class="s1">&#39;occs&#39;</span><span class="p">:</span><span class="n">occs</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">elim</span><span class="p">:</span> <span class="c1">#check if elim not empty</span>
        <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">up_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evals</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">evals</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">]</span>
            <span class="n">occs</span> <span class="o">=</span> <span class="n">occs</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">up_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eval_1</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">lo_ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eval_1</span><span class="p">[:,:]</span><span class="o">-</span><span class="n">efermi</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">elim</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">evals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">eval_1</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">],</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">eval_2</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">]}</span>
            <span class="n">occs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span><span class="n">occs_1</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">],</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span><span class="n">occs_2</span><span class="p">[:,</span><span class="n">lo_ind</span><span class="p">:</span><span class="n">up_ind</span><span class="p">]}</span>
        <span class="n">NBANDS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">up_ind</span> <span class="o">-</span> <span class="n">lo_ind</span><span class="p">)</span> <span class="c1">#update Bands</span>
        <span class="n">evals_dic</span><span class="p">[</span><span class="s1">&#39;NBANDS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NBANDS</span>
        <span class="n">evals_dic</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">lo_ind</span><span class="p">,</span><span class="n">up_ind</span><span class="p">)</span>
        <span class="n">evals_dic</span><span class="p">[</span><span class="s1">&#39;evals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evals</span>
        <span class="n">evals_dic</span><span class="p">[</span><span class="s1">&#39;occs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">occs</span>
        
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">(</span><span class="n">evals_dic</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_bands_pro_set"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_bands_pro_set">[docs]</a><span class="k">def</span> <span class="nf">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">spin_set</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipk</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bands_range</span><span class="p">:</span><span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns bands projection of a spin_set(default 1). If spin-polarized calculations, gives SpinUp and SpinDown keys as well.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        xml_data    : From ``read_asxml`` function&#39;s output.</span>
<span class="sd">        skipk (int): Number of initil kpoints to skip (Default 0).</span>
<span class="sd">        spin_set (int): Spin set to get, default is 1.</span>
<span class="sd">        bands_range (range): If elim used in ``get_evals``,that will return ``bands_range`` to use here. Note that range(0,2) will give 2 bands 0,1 but tuple (0,2) will give 3 bands 0,1,2.</span>
<span class="sd">        set_path (str): path/to/_set[1,2,3,4].txt, works if ``split_vasprun`` is used before.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict2Data: ``ipyvasp.Dict2Data`` with attibutes of bands projections and related parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bands_range</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_list</span><span class="o">==</span><span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No bands prjections found in given energy range.&quot;</span><span class="p">)</span>
    <span class="c1"># Try to read _set.txt first. instance check is important.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_path</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">set_path</span><span class="p">):</span>
        <span class="n">_header</span> <span class="o">=</span> <span class="n">islice2array</span><span class="p">(</span><span class="n">set_path</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">NKPTS</span><span class="p">,</span> <span class="n">NBANDS</span><span class="p">,</span> <span class="n">NIONS</span><span class="p">,</span> <span class="n">NORBS</span> <span class="o">=</span> <span class="n">_shape</span>
        <span class="k">if</span> <span class="n">NORBS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">NORBS</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;py&#39;</span><span class="p">,</span><span class="s1">&#39;pz&#39;</span><span class="p">,</span><span class="s1">&#39;px&#39;</span><span class="p">,</span><span class="s1">&#39;dxy&#39;</span><span class="p">,</span><span class="s1">&#39;dyz&#39;</span><span class="p">,</span><span class="s1">&#39;dz2&#39;</span><span class="p">,</span><span class="s1">&#39;dxz&#39;</span><span class="p">,</span><span class="s1">&#39;x2-y2&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NORBS</span><span class="p">)]</span> <span class="c1">#s,p,d in indices.</span>
        <span class="n">COUNT</span> <span class="o">=</span> <span class="n">NIONS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="p">(</span><span class="n">NKPTS</span><span class="o">-</span><span class="n">skipk</span><span class="p">)</span><span class="o">*</span><span class="n">NORBS</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">NBANDS</span><span class="o">*</span><span class="n">NIONS</span><span class="o">*</span><span class="n">skipk</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Read till end.</span>
        <span class="k">if</span> <span class="n">bands_range</span><span class="p">:</span>
            <span class="n">_b_r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
            <span class="c1"># First line is comment but it is taken out by exclude in islice2array.</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NIONS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="n">NIONS</span><span class="o">*</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">_b_r</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skipk</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">)]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">start</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">]</span> <span class="c1">#flatten</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">NIONS</span> <span class="c1"># 1 band has nions</span>
            <span class="n">NBANDS</span> <span class="o">=</span> <span class="n">_b_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">_b_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># upadte after start</span>

        <span class="n">NKPTS</span> <span class="o">=</span> <span class="n">NKPTS</span><span class="o">-</span><span class="n">skipk</span> <span class="c1"># Update after start, and bands_range.</span>
        <span class="n">COUNT</span> <span class="o">=</span> <span class="n">NIONS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">NKPTS</span><span class="o">*</span><span class="n">NORBS</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">islice2array</span><span class="p">(</span><span class="n">set_path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="n">nlines</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">COUNT</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">,</span><span class="n">NORBS</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">})</span>

    <span class="c1">#Collect Projection fields</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[];</span>
    <span class="k">for</span> <span class="n">pro</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;projected&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="s1">&#39;eig&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="s1">&#39;occ&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">NORBS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="c1">#Get NIONS for reshaping data</span>
    <span class="n">NIONS</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;atoms&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spin</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spin_set</span><span class="p">)}:</span>
            <span class="n">k_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">kp</span> <span class="k">for</span> <span class="n">kp</span> <span class="ow">in</span> <span class="n">spin</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;kpoint&#39;</span> <span class="ow">in</span> <span class="n">kp</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]]</span>
    <span class="n">k_sets</span> <span class="o">=</span> <span class="n">k_sets</span><span class="p">[</span><span class="n">skipk</span><span class="p">:]</span>
    <span class="n">NKPTS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_sets</span><span class="p">)</span>
    <span class="n">band_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k_s</span> <span class="ow">in</span> <span class="n">k_sets</span><span class="p">:</span>
        <span class="n">b_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">k_s</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;band&#39;</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">bands_range</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">band_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b_set</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bands_range</span><span class="p">)</span>
            <span class="n">band_sets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b_set</span><span class="p">[</span><span class="n">b_r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">b_r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">NBANDS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">band_sets</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">k_sets</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Error prone solution but 5 times fater than list comprehension.</span>
        <span class="n">bands_pro</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_sets</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">band</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">COUNT</span> <span class="o">=</span> <span class="n">NKPTS</span><span class="o">*</span><span class="n">NBANDS</span><span class="o">*</span><span class="n">NORBS</span><span class="o">*</span><span class="n">NIONS</span> <span class="c1"># Must be counted for performance.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">bands_pro</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">COUNT</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Alternate slow solution</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error using `np.fromiter`.</span><span class="se">\n</span><span class="s2">Falling back to (slow) list comprehension...&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">bands_pro</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_sets</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">band</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
        <span class="n">bands_pro</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">bands_pro</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bands_pro</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">bands_pro</span> <span class="c1"># Release memory</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">,</span><span class="n">NORBS</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">})</span></div>

<div class="viewcode-block" id="get_dos_pro_set"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_dos_pro_set">[docs]</a><span class="k">def</span> <span class="nf">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="p">:</span><span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns dos projection of a spin_set(default 1) as numpy array. If spin-polarized calculations, gives SpinUp and SpinDown keys as well.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        xml_data : From ``read_asxml`` function</span>
<span class="sd">        spin_set (int): Spin set to get, default 1.</span>
<span class="sd">        dos_range (range): If elim used in ``get_tdos``,that will return dos_range to use here..</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict2Data : ``ipyvasp.Dict2Data`` with attibutes of dos projections and related parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dos_range</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dos_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_list</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No DOS prjections found in given energy range.&quot;</span><span class="p">)</span>

    <span class="n">n_ions</span><span class="o">=</span><span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">NION</span>
    <span class="k">for</span> <span class="n">pro</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">):</span>
        <span class="n">dos_fields</span><span class="o">=</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)]</span>
        <span class="c1">#Collecting projections.</span>
        <span class="n">dos_pro</span><span class="o">=</span><span class="p">[];</span> <span class="n">set_pro</span><span class="o">=</span><span class="p">[];</span> <span class="c1">#set_pro=[] in case spin set does not exists</span>
        <span class="k">for</span> <span class="n">ion</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ions</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pro</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;ion </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ion</span><span class="o">+</span><span class="mi">1</span><span class="p">)}):</span>
                    <span class="k">for</span> <span class="n">spin</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">spin</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;spin </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spin_set</span><span class="p">)}):</span>
                            <span class="n">set_pro</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">spin</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)]</span>
            <span class="n">dos_pro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_pro</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dos_range</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span> <span class="c1">#full grid computed.</span>
        <span class="n">dos_pro</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dos_pro</span><span class="p">)</span> <span class="c1">#shape(NION,e_grid,pro_fields)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dos_range</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dos_range</span><span class="p">)</span>
        <span class="n">min_ind</span><span class="o">=</span><span class="n">dos_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_ind</span><span class="o">=</span><span class="n">dos_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">dos_pro</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dos_pro</span><span class="p">)[:,</span><span class="n">min_ind</span><span class="p">:</span><span class="n">max_ind</span><span class="p">,:]</span>
    <span class="n">final_data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dos_pro</span><span class="p">)</span> <span class="c1">#shape(NION,e_grid,pro_fields)</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">({</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">dos_fields</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span><span class="n">final_data</span><span class="p">})</span></div>


<div class="viewcode-block" id="get_structure"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.get_structure">[docs]</a><span class="k">def</span> <span class="nf">get_structure</span><span class="p">(</span><span class="n">xml_data</span><span class="p">):</span>
    <span class="n">SYSTEM</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SYSTEM&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">final</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;finalpos&#39;</span><span class="p">}):</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;varray&#39;</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;basis&#39;</span><span class="p">}):</span>
                    <span class="n">basis</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrib</span><span class="o">==</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;positions&#39;</span><span class="p">}):</span>
                    <span class="n">positions</span><span class="o">=</span><span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)]</span>
    <span class="c1"># element labels</span>
    <span class="n">types</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">_type</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;types&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elems</span>  <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;rc&#39;</span><span class="p">)]</span>
    <span class="n">_inds</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">[</span><span class="o">-</span><span class="n">types</span><span class="p">:]])</span>

    <span class="n">INDS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="n">_inds</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">elems</span><span class="p">[:</span><span class="o">-</span><span class="n">types</span><span class="p">]))</span>
    <span class="n">unique_d</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">INDS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">INDS</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Names</span><span class="p">)}</span>
    <span class="n">space_info</span> <span class="o">=</span> <span class="n">get_space_info</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">space_info</span><span class="o">.</span><span class="n">scale</span>
    <span class="n">cartesian</span> <span class="o">=</span> <span class="n">space_info</span><span class="o">.</span><span class="n">cartesian_positions</span>
    <span class="n">st_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">SYSTEM</span><span class="p">,</span><span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="p">),</span>
            <span class="s1">&#39;extra_info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span><span class="s1">&#39;Exported from vasprun.xml&#39;</span><span class="p">,</span><span class="s1">&#39;cartesian&#39;</span><span class="p">:</span><span class="n">cartesian</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span><span class="n">scale</span><span class="p">},</span>
            <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span><span class="s1">&#39;unique&#39;</span><span class="p">:</span> <span class="n">unique_d</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">st_dic</span><span class="p">)</span></div>

<div class="viewcode-block" id="export_vasprun"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.export_vasprun">[docs]</a><span class="k">def</span> <span class="nf">export_vasprun</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skipk</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">elim</span><span class="p">:</span><span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">dos_only</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a full dictionary of all objects from ``vasprun.xml`` file. It first try to load the data exported by powershell&#39;s `Export-VR(Vasprun)`, which is very fast for large files. It is recommended to export large files in powershell first.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        path  (str): Path to ``vasprun.xml`` file. Default is ``&#39;./vasprun.xml&#39;``.</span>
<span class="sd">        skipk (int): Default is None. Automatically detects kpoints to skip.</span>
<span class="sd">        elim  (list): List [min,max] of energy interval. Default is [], covers all bands.</span>
<span class="sd">        dos_only (bool): If True, only returns dos data with minimal other data. Default is False.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        VasprunData: ``ipyvasp.serializer.VasprunData`` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;./vasprun.xml&#39;</span>

    <span class="n">xml_data</span> <span class="o">=</span> <span class="n">read_asxml</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">set_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s2">&quot;_set</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>
    <span class="c1">#First exclude unnecessary kpoints. Includes only same weight points</span>
    <span class="k">if</span> <span class="n">skipk</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">skipk</span> <span class="o">=</span> <span class="n">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#that much to skip by default</span>
    <span class="n">info_dic</span> <span class="o">=</span> <span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#Reads important information of system.</span>
    <span class="c1">#KPOINTS</span>
    <span class="n">kpts</span> <span class="o">=</span> <span class="n">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">)</span>
    <span class="c1">#EIGENVALS</span>
    <span class="n">eigenvals</span> <span class="o">=</span> <span class="n">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="n">elim</span><span class="p">)</span>
    <span class="c1">#TDOS</span>
    <span class="n">tot_dos</span> <span class="o">=</span> <span class="n">get_tdos</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">elim</span><span class="o">=</span><span class="n">elim</span><span class="p">)</span>
    <span class="c1">#Bands and DOS Projection</span>
    <span class="k">if</span> <span class="n">elim</span><span class="p">:</span>
        <span class="n">bands_range</span> <span class="o">=</span> <span class="n">eigenvals</span><span class="o">.</span><span class="n">indices</span> <span class="c1">#indices in range form.</span>
        <span class="n">grid_range</span><span class="o">=</span><span class="n">tot_dos</span><span class="o">.</span><span class="n">grid_range</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bands_range</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#projection function will read itself.</span>
        <span class="n">grid_range</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">if</span> <span class="n">dos_only</span><span class="p">:</span>
        <span class="n">bands_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Just one band</span>
        <span class="n">skipk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="o">.</span><span class="n">kpath</span><span class="p">)</span> <span class="o">+</span> <span class="n">skipk</span> <span class="o">-</span> <span class="mi">2</span> <span class="c1"># Just Single kpoint</span>
        
    <span class="k">if</span> <span class="n">info_dic</span><span class="o">.</span><span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pro_bands</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">bands_range</span><span class="o">=</span><span class="n">bands_range</span><span class="p">,</span><span class="n">set_path</span><span class="o">=</span><span class="n">set_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pro_dos</span> <span class="o">=</span> <span class="n">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="n">grid_range</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">info_dic</span><span class="o">.</span><span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pro_1</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">bands_range</span><span class="o">=</span><span class="n">bands_range</span><span class="p">,</span><span class="n">set_path</span><span class="o">=</span><span class="n">set_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pro_2</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">skipk</span><span class="o">=</span><span class="n">skipk</span><span class="p">,</span><span class="n">bands_range</span><span class="o">=</span><span class="n">bands_range</span><span class="p">,</span><span class="n">set_path</span><span class="o">=</span><span class="n">set_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">pros</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span> <span class="n">pro_1</span><span class="o">.</span><span class="n">pros</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">pro_2</span><span class="o">.</span><span class="n">pros</span><span class="p">}</span><span class="c1">#accessing spins in dictionary after .pro.</span>
        <span class="n">pro_bands</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">pro_1</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pros</span><span class="p">}</span>
        <span class="n">pdos_1</span> <span class="o">=</span> <span class="n">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="n">grid_range</span><span class="p">)</span>
        <span class="n">pdos_2</span> <span class="o">=</span> <span class="n">get_dos_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">,</span><span class="n">spin_set</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dos_range</span><span class="o">=</span><span class="n">grid_range</span><span class="p">)</span>
        <span class="n">pdos</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">:</span> <span class="n">pdos_1</span><span class="o">.</span><span class="n">pros</span><span class="p">,</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">:</span> <span class="n">pdos_2</span><span class="o">.</span><span class="n">pros</span><span class="p">}</span><span class="c1">#accessing spins in dictionary after .pro.</span>
        <span class="n">pro_dos</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">pdos_1</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span><span class="s1">&#39;pros&#39;</span><span class="p">:</span> <span class="n">pdos</span><span class="p">}</span>
    
    <span class="c1"># Forces and steps</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">get_force</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span>
    <span class="n">scsteps</span> <span class="o">=</span> <span class="n">get_scsteps</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span>

    <span class="c1">#Structure</span>
    <span class="n">poscar</span> <span class="o">=</span> <span class="n">get_structure</span><span class="p">(</span><span class="n">xml_data</span> <span class="o">=</span> <span class="n">xml_data</span><span class="p">)</span>
    <span class="n">poscar</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">info_dic</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span><span class="o">**</span><span class="n">poscar</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()}</span>
    <span class="c1">#Dimensions dictionary.</span>
    <span class="n">dim_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,3)&#39;</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,1)&#39;</span><span class="p">,</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,NBANDS)&#39;</span><span class="p">,</span><span class="s1">&#39;dos&#39;</span><span class="p">:</span><span class="s1">&#39;(grid_size,3)&#39;</span><span class="p">,</span><span class="s1">&#39;pro_dos&#39;</span><span class="p">:</span><span class="s1">&#39;(NION,grid_size,en+pro_fields)&#39;</span><span class="p">,</span><span class="s1">&#39;pro_bands&#39;</span><span class="p">:</span><span class="s1">&#39;(NION,NKPTS,NBANDS,pro_fields)&#39;</span><span class="p">}</span>
    <span class="c1">#Writing everything to be accessible via dot notation</span>
    <span class="n">full_dic</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sys_info&#39;</span><span class="p">:</span><span class="n">info_dic</span><span class="p">,</span><span class="s1">&#39;dim_info&#39;</span><span class="p">:</span><span class="n">dim_dic</span><span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="n">kpts</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span><span class="s1">&#39;kpath&#39;</span><span class="p">:</span><span class="n">kpts</span><span class="o">.</span><span class="n">kpath</span><span class="p">,</span><span class="s1">&#39;bands&#39;</span><span class="p">:</span><span class="n">eigenvals</span><span class="p">,</span>
             <span class="s1">&#39;tdos&#39;</span><span class="p">:</span><span class="n">tot_dos</span><span class="p">,</span><span class="s1">&#39;pro_bands&#39;</span><span class="p">:</span><span class="n">pro_bands</span><span class="p">,</span><span class="s1">&#39;pro_dos&#39;</span><span class="p">:</span><span class="n">pro_dos</span><span class="p">,</span><span class="s1">&#39;poscar&#39;</span><span class="p">:</span> <span class="n">poscar</span><span class="p">,</span>
             <span class="s1">&#39;force&#39;</span><span class="p">:</span><span class="n">force</span><span class="p">,</span><span class="s1">&#39;scsteps&#39;</span><span class="p">:</span><span class="n">scsteps</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">VasprunData</span><span class="p">(</span><span class="n">full_dic</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_validate_evr</span><span class="p">(</span><span class="n">path_evr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&quot;Validates data given for plotting functions. Returns a tuple of (Boolean,data).&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path_evr</span><span class="p">)</span> <span class="o">==</span> <span class="n">serializer</span><span class="o">.</span><span class="n">VasprunData</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path_evr</span>

    <span class="n">path_evr</span> <span class="o">=</span> <span class="n">path_evr</span> <span class="ow">or</span> <span class="s1">&#39;./vasprun.xml&#39;</span> <span class="c1"># default path.</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_evr</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_evr</span><span class="p">):</span>
            <span class="c1"># kwargs -&gt; skipk=skipk,elim=elim</span>
            <span class="k">return</span> <span class="n">export_vasprun</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path_evr</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">path_evr</span><span class="si">!r}</span><span class="s1"> not found!&#39;</span><span class="p">)</span>
    <span class="c1"># Other things are not valid.</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;path_evr must be a path string or output of export_vasprun function.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="islice2array"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.islice2array">[docs]</a><span class="k">def</span> <span class="nf">islice2array</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">,</span><span class="n">delimiter</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;\s+&#39;</span><span class="p">,</span>
                <span class="n">include</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span><span class="n">raw</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fix_format</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">start</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nlines</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">count</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">cols</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">new_shape</span> <span class="p">:</span> <span class="nb">tuple</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a sliced array from txt,csv type files and return to array. Also manages if columns lengths are not equal and return 1D array. </span>
<span class="sd">    It is faster than loading  whole file into memory. This single function could be used to parse EIGENVAL, PROCAR, DOCAR and similar files </span>
<span class="sd">    with just a combination of ``exclude, include,start,stop,step`` arguments. See code of ``ipyvasp.parser.export_locpot`` for example.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        path_or_islice: Path/to/file or ``itertools.islice(file_object)``. islice is interesting when you want to read different slices of </span>
<span class="sd">            an opened file and do not want to open it again. </span>
<span class="sd">        dtype (conversion function): float by default. Data type of output array, it is must have argument.</span>
<span class="sd">        start (int): Starting line number. Default is 0. It could be a list to read slices from file provided that nlines is int. </span>
<span class="sd">            The spacing between adjacent indices in start should be equal to or greater than nlines as pointer in file do not go back on its own.</span>
<span class="sd">            ``start`` should count comments if ``exclude`` is None. You can use ``slice_data`` function to get a dictionary of </span>
<span class="sd">            ``start,nlines, count, cols, new_shape`` and unpack in argument instead of thinking too much.</span>
<span class="sd">        nlines (int): Number of lines after start respectively. Only work if ``path_or_islice`` is a file path. could be None or int.</span>
<span class="sd">        count (int): Default is -1. ``count = np.size(output_array) = nrows x ncols``, if it is known before execution, performance is increased. This parameter is in output of ``slice_data``.</span>
<span class="sd">        delimiter (str):  Default is `\s+`. Could be any kind of delimiter valid in numpy and in the file.</span>
<span class="sd">        cols (tuple): Tuple of indices of columns to pick. Useful when reading a file like PROCAR which e.g. has text and numbers inline. This parameter is in output of ``slice_data``.</span>
<span class="sd">        include (str): Default is None and includes everything. String of patterns separated by | to keep, could be a regular expression.</span>
<span class="sd">        exclude (str): Default is &#39;#&#39; to remove comments. String of patterns separated by | to drop,could be a regular expression.</span>
<span class="sd">        raw (bool): Default is False, if True, returns list of raw strings. Useful to select ``cols``.</span>
<span class="sd">        fix_format (bool): Default is True, it sepearates numbers with poor formatting like ``1.000-2.000`` to ``1.000 -2.000`` which is useful in PROCAR. Keep it False if want to read string literally.</span>
<span class="sd">        new_shape (tuple): Tuple of shape Default is None. Will try to reshape in this shape, if fails fallbacks to 2D or 1D. This parameter is in output of ``slice_data``.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        1D or 2D array of dtype. If raw is True, returns raw data.</span>
<span class="sd">        </span>
<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: **Example**</span>
<span class="sd">        </span>
<span class="sd">        islice2array(&#39;path/to/PROCAR&#39;,start=3,include=&#39;k-point&#39;,cols=[3,4,5])[:2]</span>
<span class="sd">        array([[ 0.125,  0.125,  0.125],</span>
<span class="sd">               [ 0.375,  0.125,  0.125]])</span>
<span class="sd">        islice2array(&#39;path/to/EIGENVAL&#39;,start=7,exclude=&#39;E&#39;,cols=[1,2])[:2]</span>
<span class="sd">        array([[-11.476913,   1.      ],</span>
<span class="sd">               [  0.283532,   1.      ]])</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">        Slicing a dimension to 100% of its data is faster than let say 80% for inner dimensions, so if you have to slice more than 50% of an inner dimension, then just load full data and slice after it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nlines</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;`nlines = None` with `start = array/list` is useless combination.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c1"># return empty array.</span>

    <span class="k">def</span> <span class="nf">_fixing</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span><span class="n">fix_format</span><span class="o">=</span><span class="n">fix_format</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="n">nlines</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">include</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>

        <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span><span class="p">)</span> <span class="c1"># remove whitespace and new lines</span>

        <span class="c1"># Make slices here after comment excluding.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="c1">#As islice moves the pointer as it reads, start[1:]-nlines-1</span>
            <span class="c1"># This confirms spacing between two indices in start &gt;= nlines</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">*</span><span class="p">[</span><span class="n">s2</span><span class="o">-</span><span class="n">s1</span><span class="o">-</span><span class="n">nlines</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]]</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="o">+</span><span class="n">nlines</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="n">nlines</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nlines</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Negative connected digits to avoid, especially in PROCAR</span>
        <span class="k">if</span> <span class="n">fix_format</span><span class="p">:</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d)-(\d)&quot;</span><span class="p">,</span><span class="sa">r</span><span class="s2">&quot;\1 -\2&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_islice</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_islice</span>

    <span class="k">def</span> <span class="nf">_gen</span><span class="p">(</span><span class="n">_islice</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">_islice</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span><span class="s1">&#39;  &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># if is must here.</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">chars</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">dtype</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>

    <span class="c1">#Process Now</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># Read full, Will fix later.</span>
            <span class="n">_islice</span> <span class="o">=</span> <span class="n">_fixing</span><span class="p">(</span><span class="n">_islice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_islice</span><span class="p">)</span>
            <span class="c1"># Must to consume islice when file is open</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">_gen</span><span class="p">(</span><span class="n">_islice</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_islice</span> <span class="o">=</span> <span class="n">_fixing</span><span class="p">(</span><span class="n">path_or_islice</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_islice</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">_gen</span><span class="p">(</span><span class="n">_islice</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">new_shape</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">cols</span><span class="p">:</span> <span class="c1">#Otherwise single array.</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="slice_data"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.slice_data">[docs]</a><span class="k">def</span> <span class="nf">slice_data</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span><span class="n">old_shape</span><span class="p">:</span><span class="nb">tuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a dictionary that can be unpacked in arguments of isclice2array function. This function works only for regular txt/csv/tsv data files which have rectangular data written.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dim_inds (list): List of indices array or range to pick from each dimension. Inner dimensions are more towards right. Last itmes in dim_inds is considered to be columns. If you want to include all values in a dimension, you can put -1 in that dimension. Note that negative indexing does not work in file readig, -1 is s special case to fetch all items.</span>
<span class="sd">        old_shape (tuple): Shape of data set including the columns length in right most place.</span>
<span class="sd">    </span>
<span class="sd">    Suppose You have data as 3D arry where third dimension is along column.</span>
<span class="sd">    </span>
<span class="sd">    .. code-block:: shell</span>
<span class="sd">        :caption: data.txt</span>
<span class="sd">        </span>
<span class="sd">        0 0</span>
<span class="sd">        0 2</span>
<span class="sd">        1 0</span>
<span class="sd">        1 2</span>
<span class="sd">        </span>
<span class="sd">    To pick [[0,2], [1,2]], i.e. second and fourth row, you need to run</span>
<span class="sd">    </span>
<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: slicing data</span>
<span class="sd">        </span>
<span class="sd">        slice_data(dim_inds = [[0,1],[1],-1], old_shape=(2,2,2))</span>
<span class="sd">        {&#39;start&#39;: array([1, 3]), &#39;nlines&#39;: 1, &#39;count&#39;: 2}</span>
<span class="sd">        </span>
<span class="sd">    Unpack above dictionary in ``islice2array`` and you will get output array.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">        The dimensions are packed from right to left, like 0,2 is repeating in 2nd column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Columns are treated diffiernetly.</span>
    <span class="k">if</span> <span class="n">dim_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">r_shape</span> <span class="o">=</span> <span class="n">old_shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dim_inds</span> <span class="o">=</span> <span class="n">dim_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dim_inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dim_inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#start = [[NIONS*NBANDS*k + NIONS*b for b in _b_r] for k in range(skipk,NKPTS)] #kind of thing.</span>
    <span class="n">_prod_</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">dim_inds</span><span class="p">)</span>
    <span class="n">_mult_</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">r_shape</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_shape</span><span class="p">))]</span>
    <span class="n">_out_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">_mult_</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_prod_</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># check if innermost dimensions could be chunked.</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dim_inds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1">#innermost</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">_inds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># consecutive</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_inds</span><span class="p">)</span>
            <span class="n">_out_</span> <span class="o">=</span> <span class="n">_out_</span><span class="p">[::</span><span class="n">step</span><span class="p">]</span> <span class="c1"># Pick first indices</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">step</span><span class="o">*</span><span class="n">nlines</span>
            <span class="c1"># Now check if all indices picked then make chunks in outer dimensions too.</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">!=</span> <span class="n">r_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="c1"># Can&#39;t make chunk of outer dimension if inner is not 100% picked.</span>
                <span class="k">break</span> <span class="c1"># Stop more chunking</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="k">for</span> <span class="n">inds</span> <span class="ow">in</span> <span class="n">dim_inds</span><span class="p">]</span> <span class="c1">#dim_inds are only in rows.</span>
    <span class="n">new_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span><span class="n">_out_</span><span class="p">,</span><span class="s1">&#39;nlines&#39;</span><span class="p">:</span><span class="n">nlines</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">nlines</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">_out_</span><span class="p">),</span><span class="s1">&#39;cols&#39;</span><span class="p">:</span><span class="n">cols</span><span class="p">,</span><span class="s1">&#39;new_shape&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)}</span></div>

<div class="viewcode-block" id="split_vasprun"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.split_vasprun">[docs]</a><span class="k">def</span> <span class="nf">split_vasprun</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Splits a given vasprun.xml file into a smaller _vasprun.xml file plus _set[1,2,3,4].txt files which contain projected data for each spin set.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        path (str): path/to/vasprun.xml file.</span>
<span class="sd">    </span>
<span class="sd">    Output:</span>
<span class="sd">        - _vasprun.xml file with projected data.</span>
<span class="sd">        - _set1.txt for projected data of colinear calculation.</span>
<span class="sd">        - _set1.txt for spin up data and _set2.txt for spin-polarized case.</span>
<span class="sd">        - _set[1,2,3,4].txt for each spin set of non-colinear calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./vasprun.xml&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s1">&#39;_vasprun.xml&#39;</span><span class="p">)</span>
    <span class="n">out_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s1">&#39;_set</span><span class="si">{}</span><span class="s1">.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
    <span class="c1"># process</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;projected|/eigenvalues&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">)]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{!r}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_file</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">outf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="kc">None</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#projected words excluded</span>
        <span class="n">spin_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">middle</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;spin&#39;</span><span class="p">,</span><span class="n">l</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span> <span class="c1">#first useless.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">set_length</span> <span class="o">=</span> <span class="n">spin_inds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">spin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Must define</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">set_length</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#It is technically more than set length, but fine for 1 set</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Must be at zero</span>
        <span class="n">N_sets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span>
        <span class="c1"># Let&#39;s read shape from out_file as well.</span>
        <span class="n">xml_data</span> <span class="o">=</span> <span class="n">read_asxml</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
        <span class="n">_summary</span> <span class="o">=</span> <span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span>
        <span class="n">NIONS</span>  <span class="o">=</span> <span class="n">_summary</span><span class="o">.</span><span class="n">NION</span>
        <span class="n">NORBS</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_summary</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">NBANDS</span> <span class="o">=</span> <span class="n">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">NBANDS</span>
        <span class="n">NKPTS</span>  <span class="o">=</span> <span class="n">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">NKPTS</span>
        <span class="k">del</span> <span class="n">xml_data</span> <span class="c1"># free meory now.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sets</span><span class="p">):</span> <span class="c1">#Reads every set</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{!r}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_sets</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">spin_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># pointer is there next time.</span>
            <span class="n">stop_</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">set_length</span> <span class="c1"># Should move up to set length only.</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_sets</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">setf</span><span class="p">:</span>
                <span class="n">setf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  # Set: </span><span class="si">{}</span><span class="s2"> Shape: (NKPTS[NBANDS[NIONS]],NORBS) = </span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">,</span><span class="n">NORBS</span><span class="p">))</span>
                <span class="n">middle</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">stop_</span><span class="p">)</span>
                <span class="n">setf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;r&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">middle</span> <span class="k">if</span> <span class="s1">&#39;&lt;/r&gt;&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="export_spin_data"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.export_spin_data">[docs]</a><span class="k">def</span> <span class="nf">export_spin_data</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spins</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">elim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns Data with selected spin sets. For spin polarized calculations, it returns spin up and down data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        path  (str): Path to ``vasprun.xml`` file. Default is `&#39;./vasprun.xml&#39;`.</span>
<span class="sd">        skipk (int): Default is None. Automatically detects kpoints to skip.</span>
<span class="sd">        elim  (list): List [min,max] of energy interval. Default is [], covers all bands.</span>
<span class="sd">        spins (str): Spin components to include from &#39;sxyz&#39;, e.g. &#39;sx&#39; will pick &lt;S&gt; and &lt;S_x&gt; if present.</span>
<span class="sd">        Only works if ISPIN == 1, otherwise it will be two sets for spin up and down.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        SpinData: ``ipyvasp.serializer.SpinData`` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spins</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`spins` must be a string from &#39;sxyz&#39;, got </span><span class="si">{</span><span class="n">spins</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="p">[</span><span class="n">comp</span> <span class="ow">in</span> <span class="s1">&#39;sxyz&#39;</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`spins` must be in &#39;sxyz&#39;, got </span><span class="si">{</span><span class="n">spins</span><span class="si">!r}</span><span class="s2">!&quot;</span><span class="p">)</span>

    <span class="n">xml_data</span> <span class="o">=</span> <span class="n">read_asxml</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;./vasprun.xml&#39;</span><span class="p">)</span>

    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;./vasprun.xml&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">set_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="s2">&quot;_set</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>

    <span class="n">skipk</span> <span class="o">=</span> <span class="n">skipk</span> <span class="ow">or</span> <span class="n">exclude_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="o">=</span><span class="n">xml_data</span><span class="p">)</span> <span class="c1">#that much to skip by default</span>
    <span class="n">full_dic</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sys_info&#39;</span><span class="p">:</span><span class="n">get_summary</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)}</span>

    <span class="n">ISPIN</span> <span class="o">=</span> <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;sys_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ISPIN</span>
    <span class="n">LSORBIT</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;sys_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">incar</span><span class="p">,</span> <span class="s1">&#39;LSORBIT&#39;</span><span class="p">,</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;f&#39;</span> <span class="ow">in</span> <span class="n">LSORBIT</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LSORBIT = </span><span class="si">{</span><span class="n">LSORBIT</span><span class="si">}</span><span class="s2"> does not include spin component </span><span class="si">{</span><span class="n">comp</span><span class="si">!r}</span><span class="s2">!&quot;</span><span class="p">)</span>

    <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;dim_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,3)&#39;</span><span class="p">,</span><span class="s1">&#39;evals.&lt;e,u,d&gt;&#39;</span><span class="p">:</span><span class="s1">&#39;(NKPTS,NBANDS)&#39;</span><span class="p">,</span><span class="s1">&#39;spins.&lt;u,d,s,x,y,z&gt;&#39;</span><span class="p">:</span><span class="s1">&#39;(NION,NKPTS,NBANDS,pro_fields)&#39;</span><span class="p">}</span>
    <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;kpoints&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">get_kpts</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="n">skipk</span><span class="p">)</span><span class="o">.</span><span class="n">kpoints</span>

    <span class="n">bands</span> <span class="o">=</span> <span class="n">get_evals</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="n">skipk</span><span class="p">,</span><span class="n">elim</span> <span class="o">=</span> <span class="n">elim</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">evals</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="s1">&#39;evals&#39;</span><span class="p">]</span>
    <span class="n">bands</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">evals</span><span class="p">[</span><span class="s1">&#39;SpinUp&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="n">evals</span><span class="p">[</span><span class="s1">&#39;SpinDown&#39;</span><span class="p">]}</span> <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="n">evals</span><span class="p">})</span>
    
    <span class="k">del</span> <span class="n">bands</span><span class="p">[</span><span class="s1">&#39;evals&#39;</span><span class="p">]</span> <span class="c1"># Do not Delete occupancies here</span>
    <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;evals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span>

    <span class="n">bands_range</span> <span class="o">=</span> <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span> <span class="k">if</span> <span class="n">elim</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1">#indices in range form.</span>

    <span class="n">spin_sets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s1">&#39;sxyz&#39;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spins</span><span class="p">:</span>
                <span class="n">spin_sets</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">spin_set</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="n">skipk</span><span class="p">,</span> <span class="n">bands_range</span> <span class="o">=</span> <span class="n">bands_range</span><span class="p">,</span> <span class="n">set_path</span> <span class="o">=</span> <span class="n">set_paths</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">pros</span>

    <span class="k">if</span> <span class="n">ISPIN</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found ISPIN = 2, output data got attributes spins.&lt;u,d&gt; instead of spins.&lt;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spins</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">))</span>
        <span class="n">pro_1</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">spin_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="n">skipk</span><span class="p">,</span> <span class="n">bands_range</span> <span class="o">=</span> <span class="n">bands_range</span><span class="p">,</span> <span class="n">set_path</span> <span class="o">=</span> <span class="n">set_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pro_2</span> <span class="o">=</span> <span class="n">get_bands_pro_set</span><span class="p">(</span><span class="n">xml_data</span><span class="p">,</span> <span class="n">spin_set</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">skipk</span> <span class="o">=</span> <span class="n">skipk</span><span class="p">,</span> <span class="n">bands_range</span> <span class="o">=</span> <span class="n">bands_range</span><span class="p">,</span> <span class="n">set_path</span> <span class="o">=</span> <span class="n">set_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">spin_sets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">pro_1</span><span class="o">.</span><span class="n">pros</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="n">pro_2</span><span class="o">.</span><span class="n">pros</span><span class="p">}</span>

    <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;spins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spin_sets</span>
    <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;spins&#39;</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;sys_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span>
    <span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;poscar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">full_dic</span><span class="p">[</span><span class="s1">&#39;sys_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span><span class="o">**</span><span class="p">(</span><span class="n">get_structure</span><span class="p">(</span><span class="n">xml_data</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">SpinData</span><span class="p">(</span><span class="n">full_dic</span><span class="p">)</span></div>

<div class="viewcode-block" id="export_outcar"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.export_outcar">[docs]</a><span class="k">def</span> <span class="nf">export_outcar</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Read potential at ionic sites from OUTCAR file.&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./OUTCAR&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="c1"># Raeding it</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="c1"># Processing</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;NIONS&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;electrostatic&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span>
            <span class="n">stop_index</span> <span class="o">=</span> <span class="n">start_index</span><span class="o">+</span><span class="n">nlines</span>
        <span class="k">if</span> <span class="s1">&#39;fractional&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;vectors are now&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">b_first</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">5</span>
        <span class="k">if</span> <span class="s1">&#39;NION&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">ion_line</span> <span class="o">=</span> <span class="n">l</span>
        <span class="k">if</span> <span class="s1">&#39;NKPTS&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">kpt_line</span> <span class="o">=</span><span class="n">l</span>

    <span class="n">NKPTS</span><span class="p">,</span><span class="n">NKDIMS</span><span class="p">,</span><span class="n">NBANDS</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span><span class="n">kpt_line</span><span class="p">)]</span>
    <span class="n">NEDOS</span><span class="p">,</span><span class="n">NIONS</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span><span class="n">ion_line</span><span class="p">)]</span>
    <span class="n">n_kbi</span> <span class="o">=</span> <span class="p">(</span><span class="n">NKPTS</span><span class="p">,</span><span class="n">NBANDS</span><span class="p">,</span><span class="n">NIONS</span><span class="p">)</span>
    <span class="c1"># Data manipulation</span>
    <span class="c1"># Potential</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">stop_index</span><span class="p">]</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">pot_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">initial</span><span class="p">,</span><span class="n">last</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">pot_arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># Ion index fixing</span>
    <span class="c1"># Nearest neighbors</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">first</span><span class="o">+</span><span class="n">N</span><span class="p">]</span>
    <span class="n">pos_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span>
    <span class="n">pos_arr</span><span class="p">[</span><span class="n">pos_arr</span><span class="o">&gt;</span><span class="mf">0.98</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_arr</span><span class="p">[</span><span class="n">pos_arr</span><span class="o">&gt;</span><span class="mf">0.98</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># Fixing outer layers</span>
    <span class="c1"># positions and potential</span>
    <span class="n">pos_pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">pos_arr</span><span class="p">,</span><span class="n">pot_arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]])</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">b_first</span><span class="p">:</span><span class="n">b_first</span><span class="o">+</span><span class="mi">3</span><span class="p">])))</span>
    <span class="n">final_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ion_pot&#39;</span><span class="p">:</span><span class="n">pot_arr</span><span class="p">,</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span><span class="n">pos_arr</span><span class="p">,</span><span class="s1">&#39;site_pot&#39;</span><span class="p">:</span><span class="n">pos_pot</span><span class="p">,</span><span class="s1">&#39;basis&#39;</span><span class="p">:</span><span class="n">basis</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">],</span><span class="s1">&#39;rec_basis&#39;</span><span class="p">:</span><span class="n">basis</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:],</span><span class="s1">&#39;n_kbi&#39;</span><span class="p">:</span><span class="n">n_kbi</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">OutcarData</span><span class="p">(</span><span class="n">final_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="export_locpot"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.parser.export_locpot">[docs]</a><span class="k">def</span> <span class="nf">export_locpot</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">data_set</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns Data from LOCPOT and similar structure files like CHG/PARCHG etc. Loads only single set based on what is given in data_set argument.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        locpot (str): path/to/LOCPOT or similar stuructured file like CHG. LOCPOT is auto picked in CWD.</span>
<span class="sd">        data_set (int): 0 for electrostatic data, 1 for magnetization data if ISPIN = 2. If non-colinear calculations, 1,2,3 will pick Mx,My,Mz data sets respectively. Only one data set is loaded, so you should know what you are loading.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        GridData: ``ipyvasp.serializer.GridData`` object with 3D volumetric data set loaded as attribute &#39;values&#39;.</span>
<span class="sd">        </span>
<span class="sd">    Exceptions:</span>
<span class="sd">        Would raise index error if magnetization density set is not present in case ``data_set &gt; 0``.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">        Read `vaspwiki-CHGCAR &lt;https://www.vasp.at/wiki/index.php/CHGCAR&gt;`_ for more info on what data sets are available corresponding to different calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="s1">&#39;./LOCPOT&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{!r}</span><span class="s2"> does not exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">data_set</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">data_set</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`data_set` should be 0 (for electrostatic),1 (for M or Mx),2 (for My),3 (for Mz)! Got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
    
    <span class="c1"># data fixing after reading islice from file.</span>
    <span class="k">def</span> <span class="nf">fix_data</span><span class="p">(</span><span class="n">islice_gen</span><span class="p">,</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_gen</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">islice_gen</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">COUNT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">new_gen</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">COUNT</span><span class="p">)</span> <span class="c1"># Count is must for performance</span>
            <span class="c1"># data written on LOCPOT is in shape of (NGz,NGy,NGx)</span>
            <span class="n">N_reshape</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_reshape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{!r}</span><span class="s2"> may not be in proper format!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Magnetization density may not be present in </span><span class="si">{!r}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    
    <span class="c1"># Reading File</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">poscar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">poscar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c1"># Empty one</span>
        <span class="n">Nxyz</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="c1"># Grid line read</span>
        <span class="n">nlines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">Nxyz</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1">#islice is faster generator for reading potential</span>
        <span class="n">pot_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;values&#39;</span><span class="p">:</span><span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">nlines</span><span class="p">),</span><span class="n">Nxyz</span><span class="p">)})</span>
            <span class="n">ignore_set</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Pointer already ahead.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ignore_set</span> <span class="o">=</span> <span class="n">nlines</span> <span class="c1"># Needs to move pointer to magnetization</span>
        <span class="c1">#reading Magnetization if True</span>
        <span class="n">ignore_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="c1">#Some kind of useless data</span>
        <span class="k">if</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: data_set = 1 picks Mx for non-colinear case, and M for ISPIN = 2.&quot;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">ignore_n</span><span class="o">+</span><span class="n">ignore_set</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="n">nlines</span><span class="p">),</span><span class="n">Nxyz</span><span class="p">)})</span>
        <span class="k">elif</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ignore_n</span><span class="o">+</span><span class="n">nlines</span><span class="o">+</span><span class="n">ignore_set</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="n">nlines</span><span class="p">),</span><span class="n">Nxyz</span><span class="p">)})</span>
        <span class="k">elif</span> <span class="n">data_set</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ignore_n</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlines</span><span class="o">+</span><span class="n">ignore_set</span>
            <span class="n">pot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">fix_data</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="n">nlines</span><span class="p">),</span><span class="n">Nxyz</span><span class="p">)})</span>

    <span class="c1"># Read Info</span>
    <span class="kn">from</span> <span class="nn">.sio</span> <span class="kn">import</span> <span class="n">export_poscar</span> <span class="c1"># Keep inside to avoid import loop</span>
    <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">export_poscar</span><span class="p">(</span><span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poscar</span><span class="p">))</span>
    <span class="n">final_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">pot_dict</span><span class="p">,</span> <span class="n">poscar</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">GridData</span><span class="p">(</span><span class="n">final_dict</span><span class="p">)</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Abdul Saboor
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    </body>
</html>