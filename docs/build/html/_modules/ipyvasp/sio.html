<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <meta name="generator" content="sphinx-5.1.1, furo 2022.06.21"/>
        <title>ipyvasp.sio - ipyvasp 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ipyvasp 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">ipyvasp 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc.html">API</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for ipyvasp.sio</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED! DO NOT EDIT! File to edit: StructureIO.ipynb (unless otherwise specified).</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;atomic_number&#39;</span><span class="p">,</span> <span class="s1">&#39;atoms_color&#39;</span><span class="p">,</span> <span class="s1">&#39;periodic_table&#39;</span><span class="p">,</span> <span class="s1">&#39;Arrow3D&#39;</span><span class="p">,</span> <span class="s1">&#39;fancy_quiver3d&#39;</span><span class="p">,</span> <span class="s1">&#39;get_selective_dynamics&#39;</span><span class="p">,</span>
           <span class="s1">&#39;write_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;export_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;InvokeMaterialsProject&#39;</span><span class="p">,</span> <span class="s1">&#39;get_kpath&#39;</span><span class="p">,</span> <span class="s1">&#39;read_ticks&#39;</span><span class="p">,</span> <span class="s1">&#39;str2kpath&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_kmesh&#39;</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;rotation&#39;</span><span class="p">,</span> <span class="s1">&#39;get_bz&#39;</span><span class="p">,</span> <span class="s1">&#39;splot_bz&#39;</span><span class="p">,</span> <span class="s1">&#39;iplot_bz&#39;</span><span class="p">,</span> <span class="s1">&#39;to_R3&#39;</span><span class="p">,</span> <span class="s1">&#39;to_basis&#39;</span><span class="p">,</span> <span class="s1">&#39;kpoints2bz&#39;</span><span class="p">,</span>
           <span class="s1">&#39;fix_sites&#39;</span><span class="p">,</span> <span class="s1">&#39;translate_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;get_pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;iplot_lat&#39;</span><span class="p">,</span> <span class="s1">&#39;splot_lat&#39;</span><span class="p">,</span> <span class="s1">&#39;join_poscars&#39;</span><span class="p">,</span> <span class="s1">&#39;repeat_poscar&#39;</span><span class="p">,</span>
           <span class="s1">&#39;scale_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;mirror_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;convert_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;get_transform_matrix&#39;</span><span class="p">,</span>
           <span class="s1">&#39;transform_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;add_vaccum&#39;</span><span class="p">,</span> <span class="s1">&#39;transpose_poscar&#39;</span><span class="p">,</span> <span class="s1">&#39;add_atoms&#39;</span><span class="p">]</span>

<span class="c1"># Cell</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="nn">req</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span><span class="p">,</span> <span class="n">Voronoi</span><span class="p">,</span> <span class="n">KDTree</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mplc</span> <span class="c1">#For viewpoint</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits</span> <span class="kn">import</span> <span class="n">mplot3d</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d.art3d</span> <span class="kn">import</span> <span class="n">Poly3DCollection</span>
<span class="c1"># Inside packages import to work both with package and jupyter notebook.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ipyvasp</span> <span class="kn">import</span> <span class="n">parser</span> <span class="k">as</span> <span class="n">vp</span><span class="p">,</span> <span class="n">serializer</span>
    <span class="kn">from</span> <span class="nn">ipyvasp</span> <span class="kn">import</span> <span class="n">splots</span> <span class="k">as</span> <span class="n">sp</span>
    <span class="kn">from</span> <span class="nn">ipyvasp</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ipyvasp.parser</span> <span class="k">as</span> <span class="nn">vp</span>
    <span class="kn">import</span> <span class="nn">ipyvasp.splots</span> <span class="k">as</span> <span class="nn">sp</span>
    <span class="kn">import</span> <span class="nn">ipyvasp.serializer</span> <span class="k">as</span> <span class="nn">serializer</span>
    <span class="kn">import</span> <span class="nn">ipyvasp.utils</span> <span class="k">as</span> <span class="nn">utils</span>


<span class="c1"># These colors are taken from Mathematica&#39;s ColorData[&quot;Atoms&quot;]</span>
<span class="n">_atom_colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span> <span class="s1">&#39;He&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8367</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="s1">&#39;Li&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7994</span><span class="p">,</span> <span class="mf">0.9976</span><span class="p">,</span> <span class="mf">0.5436</span><span class="p">),</span> <span class="s1">&#39;Be&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7706</span><span class="p">,</span> <span class="mf">0.0442</span><span class="p">,</span> <span class="mf">0.9643</span><span class="p">),</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">143</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">143</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8005</span><span class="p">,</span> <span class="mf">0.1921</span><span class="p">,</span> <span class="mf">0.2015</span><span class="p">),</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">128</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Ne&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6773</span><span class="p">,</span> <span class="mf">0.9553</span><span class="p">,</span> <span class="mf">0.9284</span><span class="p">),</span>
    <span class="s1">&#39;Na&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6587</span><span class="p">,</span> <span class="mf">0.8428</span><span class="p">,</span> <span class="mf">0.4922</span><span class="p">),</span><span class="s1">&#39;Mg&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6283</span><span class="p">,</span> <span class="mf">0.0783</span><span class="p">,</span> <span class="mf">0.8506</span><span class="p">),</span><span class="s1">&#39;Al&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">173</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">178</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">189</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;Si&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">248</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">209</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">152</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">165</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">200</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">50</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;Cl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="s1">&#39;Ar&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5461</span><span class="p">,</span> <span class="mf">0.8921</span><span class="p">,</span> <span class="mf">0.8442</span><span class="p">),</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="mf">0.534</span><span class="p">,</span> <span class="mf">0.7056</span><span class="p">,</span> <span class="mf">0.4207</span><span class="p">),</span> <span class="s1">&#39;Ca&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4801</span><span class="p">,</span> <span class="mf">0.0955</span><span class="p">,</span> <span class="mf">0.7446</span><span class="p">),</span> <span class="s1">&#39;Sc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.902</span><span class="p">,</span> <span class="mf">0.902</span><span class="p">,</span> <span class="mf">0.902</span><span class="p">),</span> <span class="s1">&#39;Ti&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.749</span><span class="p">,</span> <span class="mf">0.7804</span><span class="p">,</span> <span class="mf">0.7608</span><span class="p">),</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.651</span><span class="p">,</span> <span class="mf">0.6706</span><span class="p">,</span> <span class="mf">0.651</span><span class="p">),</span> <span class="s1">&#39;Cr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5412</span><span class="p">,</span> <span class="mf">0.7804</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span> <span class="s1">&#39;Mn&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6118</span><span class="p">,</span> <span class="mf">0.7804</span><span class="p">,</span> <span class="mf">0.4784</span><span class="p">),</span> <span class="s1">&#39;Fe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.32</span><span class="p">,</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.35</span><span class="p">),</span>
    <span class="s1">&#39;Co&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9412</span><span class="p">,</span> <span class="mf">0.6275</span><span class="p">,</span> <span class="mf">0.5647</span><span class="p">),</span> <span class="s1">&#39;Ni&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">141</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">142</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">140</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="s1">&#39;Cu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">184</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">115</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">51</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="s1">&#39;Zn&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">186</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">196</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;Ga&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">90</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">180</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">189</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;Ge&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6051</span><span class="p">,</span> <span class="mf">0.5765</span><span class="p">,</span> <span class="mf">0.6325</span><span class="p">),</span><span class="s1">&#39;As&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">71</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">57</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;Se&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9172</span><span class="p">,</span> <span class="mf">0.0707</span><span class="p">,</span> <span class="mf">0.6578</span><span class="p">),</span>
    <span class="s1">&#39;Br&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">161</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">61</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">45</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span><span class="s1">&#39;Kr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.426</span><span class="p">,</span> <span class="mf">0.8104</span><span class="p">,</span> <span class="mf">0.7475</span><span class="p">),</span><span class="s1">&#39;Rb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4254</span><span class="p">,</span> <span class="mf">0.5859</span><span class="p">,</span> <span class="mf">0.3292</span><span class="p">),</span><span class="s1">&#39;Sr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.326</span><span class="p">,</span> <span class="mf">0.096</span><span class="p">,</span> <span class="mf">0.6464</span><span class="p">),</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.531</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span><span class="s1">&#39;Zr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4586</span><span class="p">,</span> <span class="mf">0.9186</span><span class="p">,</span> <span class="mf">0.9175</span><span class="p">),</span><span class="s1">&#39;Nb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.385</span><span class="p">,</span> <span class="mf">0.8417</span><span class="p">,</span> <span class="mf">0.8349</span><span class="p">),</span><span class="s1">&#39;Mo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3103</span><span class="p">,</span> <span class="mf">0.7693</span><span class="p">,</span> <span class="mf">0.7522</span><span class="p">),</span>
    <span class="s1">&#39;Tc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.2345</span><span class="p">,</span> <span class="mf">0.7015</span><span class="p">,</span> <span class="mf">0.6694</span><span class="p">),</span> <span class="s1">&#39;Ru&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1575</span><span class="p">,</span> <span class="mf">0.6382</span><span class="p">,</span> <span class="mf">0.5865</span><span class="p">),</span> <span class="s1">&#39;Rh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0793</span><span class="p">,</span> <span class="mf">0.5795</span><span class="p">,</span> <span class="mf">0.5036</span><span class="p">),</span> <span class="s1">&#39;Pd&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5252</span><span class="p">,</span> <span class="mf">0.4206</span><span class="p">),</span> <span class="s1">&#39;Ag&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7529</span><span class="p">,</span> <span class="mf">0.7529</span><span class="p">,</span> <span class="mf">0.7529</span><span class="p">),</span> <span class="s1">&#39;Cd&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.67</span><span class="p">,</span><span class="mf">0.73</span><span class="p">),</span> <span class="s1">&#39;In&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">228</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">228</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">228</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="s1">&#39;Sn&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.398</span><span class="p">,</span> <span class="mf">0.4956</span><span class="p">,</span> <span class="mf">0.4915</span><span class="p">),</span>
    <span class="s1">&#39;Sb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">158</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">99</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span><span class="mi">181</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="s1">&#39;Te&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8167</span><span class="p">,</span> <span class="mf">0.0101</span><span class="p">,</span> <span class="mf">0.4513</span><span class="p">),</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">25</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">52</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="s1">&#39;Xe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3169</span><span class="p">,</span> <span class="mf">0.7103</span><span class="p">,</span> <span class="mf">0.6381</span><span class="p">),</span> <span class="s1">&#39;Cs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3328</span><span class="p">,</span> <span class="mf">0.4837</span><span class="p">,</span> <span class="mf">0.2177</span><span class="p">),</span> <span class="s1">&#39;Ba&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1659</span><span class="p">,</span> <span class="mf">0.0797</span><span class="p">,</span> <span class="mf">0.556</span><span class="p">),</span> <span class="s1">&#39;La&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.9281</span><span class="p">,</span> <span class="mf">0.3294</span><span class="p">,</span> <span class="mf">0.7161</span><span class="p">),</span> <span class="s1">&#39;Ce&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8948</span><span class="p">,</span> <span class="mf">0.3251</span><span class="p">,</span> <span class="mf">0.7314</span><span class="p">),</span>
    <span class="s1">&#39;Pr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8652</span><span class="p">,</span> <span class="mf">0.3153</span><span class="p">,</span> <span class="mf">0.708</span><span class="p">),</span> <span class="s1">&#39;Nd&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8378</span><span class="p">,</span> <span class="mf">0.3016</span><span class="p">,</span> <span class="mf">0.663</span><span class="p">),</span> <span class="s1">&#39;Pm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.812</span><span class="p">,</span> <span class="mf">0.2856</span><span class="p">,</span> <span class="mf">0.6079</span><span class="p">),</span> <span class="s1">&#39;Sm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7876</span><span class="p">,</span> <span class="mf">0.2683</span><span class="p">,</span> <span class="mf">0.5499</span><span class="p">),</span> <span class="s1">&#39;Eu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7646</span><span class="p">,</span> <span class="mf">0.2504</span><span class="p">,</span> <span class="mf">0.4933</span><span class="p">),</span> <span class="s1">&#39;Gd&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7432</span><span class="p">,</span> <span class="mf">0.2327</span><span class="p">,</span> <span class="mf">0.4401</span><span class="p">),</span> <span class="s1">&#39;Tb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7228</span><span class="p">,</span> <span class="mf">0.2158</span><span class="p">,</span> <span class="mf">0.3914</span><span class="p">),</span> <span class="s1">&#39;Dy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7024</span><span class="p">,</span> <span class="mf">0.2004</span><span class="p">,</span> <span class="mf">0.3477</span><span class="p">),</span>
    <span class="s1">&#39;Ho&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="mf">0.1874</span><span class="p">,</span> <span class="mf">0.3092</span><span class="p">),</span> <span class="s1">&#39;Er&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.652</span><span class="p">,</span> <span class="mf">0.1778</span><span class="p">,</span> <span class="mf">0.2768</span><span class="p">),</span> <span class="s1">&#39;Tm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6136</span><span class="p">,</span> <span class="mf">0.173</span><span class="p">,</span> <span class="mf">0.2515</span><span class="p">),</span> <span class="s1">&#39;Yb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5579</span><span class="p">,</span> <span class="mf">0.1749</span><span class="p">,</span> <span class="mf">0.2346</span><span class="p">),</span> <span class="s1">&#39;Lu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4757</span><span class="p">,</span> <span class="mf">0.1856</span><span class="p">,</span> <span class="mf">0.2276</span><span class="p">),</span> <span class="s1">&#39;Hf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7815</span><span class="p">,</span> <span class="mf">0.7166</span><span class="p">,</span> <span class="mf">0.7174</span><span class="p">),</span> <span class="s1">&#39;Ta&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7344</span><span class="p">,</span> <span class="mf">0.6835</span><span class="p">,</span> <span class="mf">0.5445</span><span class="p">),</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6812</span><span class="p">,</span> <span class="mf">0.6368</span><span class="p">,</span> <span class="mf">0.3604</span><span class="p">),</span>
    <span class="s1">&#39;Re&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6052</span><span class="p">,</span> <span class="mf">0.5563</span><span class="p">,</span> <span class="mf">0.3676</span><span class="p">),</span> <span class="s1">&#39;Os&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5218</span><span class="p">,</span> <span class="mf">0.4692</span><span class="p">,</span> <span class="mf">0.3821</span><span class="p">),</span> <span class="s1">&#39;Ir&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4456</span><span class="p">,</span> <span class="mf">0.3991</span><span class="p">,</span> <span class="mf">0.3732</span><span class="p">),</span> <span class="s1">&#39;Pt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8157</span><span class="p">,</span> <span class="mf">0.8784</span><span class="p">,</span> <span class="mf">0.8157</span><span class="p">),</span> <span class="s1">&#39;Au&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="s1">&#39;Hg&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7216</span><span class="p">,</span> <span class="mf">0.8157</span><span class="p">,</span> <span class="mf">0.7216</span><span class="p">),</span> <span class="s1">&#39;Tl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.651</span><span class="p">,</span> <span class="mf">0.302</span><span class="p">,</span> <span class="mf">0.3294</span><span class="p">),</span> <span class="s1">&#39;Pb&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3412</span><span class="p">,</span> <span class="mf">0.3804</span><span class="p">,</span> <span class="mf">0.349</span><span class="p">),</span>
    <span class="s1">&#39;Bi&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">49</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">93</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="s1">&#39;Po&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6706</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3608</span><span class="p">),</span> <span class="s1">&#39;At&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4588</span><span class="p">,</span> <span class="mf">0.2706</span><span class="p">,</span> <span class="mf">0.3098</span><span class="p">),</span> <span class="s1">&#39;Rn&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.2188</span><span class="p">,</span> <span class="mf">0.5916</span><span class="p">,</span> <span class="mf">0.5161</span><span class="p">),</span> <span class="s1">&#39;Fr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.2563</span><span class="p">,</span> <span class="mf">0.3989</span><span class="p">,</span> <span class="mf">0.0861</span><span class="p">),</span> <span class="s1">&#39;Ra&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0465</span><span class="p">,</span> <span class="mf">0.4735</span><span class="p">),</span> <span class="s1">&#39;Ac&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.322</span><span class="p">,</span> <span class="mf">0.9885</span><span class="p">,</span> <span class="mf">0.7169</span><span class="p">),</span> <span class="s1">&#39;Th&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3608</span><span class="p">,</span> <span class="mf">0.943</span><span class="p">,</span> <span class="mf">0.6717</span><span class="p">),</span>
    <span class="s1">&#39;Pa&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3975</span><span class="p">,</span> <span class="mf">0.8989</span><span class="p">,</span> <span class="mf">0.628</span><span class="p">),</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.432</span><span class="p">,</span> <span class="mf">0.856</span><span class="p">,</span> <span class="mf">0.586</span><span class="p">),</span> <span class="s1">&#39;Np&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4645</span><span class="p">,</span> <span class="mf">0.8145</span><span class="p">,</span> <span class="mf">0.5455</span><span class="p">),</span> <span class="s1">&#39;Pu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.4949</span><span class="p">,</span> <span class="mf">0.7744</span><span class="p">,</span> <span class="mf">0.5067</span><span class="p">),</span> <span class="s1">&#39;Am&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5233</span><span class="p">,</span> <span class="mf">0.7355</span><span class="p">,</span> <span class="mf">0.4695</span><span class="p">),</span> <span class="s1">&#39;Cm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5495</span><span class="p">,</span> <span class="mf">0.698</span><span class="p">,</span> <span class="mf">0.4338</span><span class="p">),</span> <span class="s1">&#39;Bk&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5736</span><span class="p">,</span> <span class="mf">0.6618</span><span class="p">,</span> <span class="mf">0.3998</span><span class="p">),</span> <span class="s1">&#39;Cf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5957</span><span class="p">,</span> <span class="mf">0.6269</span><span class="p">,</span> <span class="mf">0.3675</span><span class="p">),</span>
    <span class="s1">&#39;Es&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6156</span><span class="p">,</span> <span class="mf">0.5934</span><span class="p">,</span> <span class="mf">0.3367</span><span class="p">),</span> <span class="s1">&#39;Fm&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6335</span><span class="p">,</span> <span class="mf">0.5612</span><span class="p">,</span> <span class="mf">0.3075</span><span class="p">),</span> <span class="s1">&#39;Md&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6493</span><span class="p">,</span> <span class="mf">0.5303</span><span class="p">,</span> <span class="mf">0.2799</span><span class="p">),</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.663</span><span class="p">,</span> <span class="mf">0.5007</span><span class="p">,</span> <span class="mf">0.254</span><span class="p">),</span> <span class="s1">&#39;Lr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6746</span><span class="p">,</span> <span class="mf">0.4725</span><span class="p">,</span> <span class="mf">0.2296</span><span class="p">),</span> <span class="s1">&#39;Rf&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6841</span><span class="p">,</span> <span class="mf">0.4456</span><span class="p">,</span> <span class="mf">0.2069</span><span class="p">),</span> <span class="s1">&#39;Db&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6915</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">,</span> <span class="mf">0.1858</span><span class="p">),</span> <span class="s1">&#39;Sg&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6969</span><span class="p">,</span> <span class="mf">0.3958</span><span class="p">,</span> <span class="mf">0.1663</span><span class="p">),</span>
    <span class="s1">&#39;Bh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7001</span><span class="p">,</span> <span class="mf">0.3728</span><span class="p">,</span> <span class="mf">0.1484</span><span class="p">),</span> <span class="s1">&#39;Hs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7013</span><span class="p">,</span> <span class="mf">0.3512</span><span class="p">,</span> <span class="mf">0.1321</span><span class="p">),</span> <span class="s1">&#39;Mt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.7004</span><span class="p">,</span> <span class="mf">0.331</span><span class="p">,</span> <span class="mf">0.1174</span><span class="p">),</span> <span class="s1">&#39;Ds&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6973</span><span class="p">,</span> <span class="mf">0.312</span><span class="p">,</span> <span class="mf">0.1043</span><span class="p">),</span> <span class="s1">&#39;Rg&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6922</span><span class="p">,</span> <span class="mf">0.2944</span><span class="p">,</span> <span class="mf">0.0928</span><span class="p">),</span> <span class="s1">&#39;Cn&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6851</span><span class="p">,</span> <span class="mf">0.2781</span><span class="p">,</span> <span class="mf">0.083</span><span class="p">),</span> <span class="s1">&#39;Nh&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6758</span><span class="p">,</span> <span class="mf">0.2631</span><span class="p">,</span> <span class="mf">0.0747</span><span class="p">),</span> <span class="s1">&#39;Fl&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6644</span><span class="p">,</span> <span class="mf">0.2495</span><span class="p">,</span> <span class="mf">0.0681</span><span class="p">),</span>
    <span class="s1">&#39;Mc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6509</span><span class="p">,</span> <span class="mf">0.2372</span><span class="p">,</span> <span class="mf">0.0631</span><span class="p">),</span> <span class="s1">&#39;Lv&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6354</span><span class="p">,</span> <span class="mf">0.2262</span><span class="p">,</span> <span class="mf">0.0597</span><span class="p">),</span> <span class="s1">&#39;Ts&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6354</span><span class="p">,</span> <span class="mf">0.2262</span><span class="p">,</span> <span class="mf">0.0566</span><span class="p">),</span> <span class="s1">&#39;Og&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6354</span><span class="p">,</span> <span class="mf">0.2262</span><span class="p">,</span> <span class="mf">0.0528</span><span class="p">)}</span>

<span class="n">_atom_numbers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_atom_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

<span class="k">def</span> <span class="nf">atomic_number</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="s2">&quot;Return atomic number of atom&quot;</span>
    <span class="k">return</span> <span class="n">_atom_numbers</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">atoms_color</span><span class="p">():</span>
    <span class="s2">&quot;Defualt color per atom used for plotting the crystal lattice&quot;</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">Dict2Data</span><span class="p">({</span><span class="n">k</span><span class="p">:[</span><span class="nb">round</span><span class="p">(</span><span class="n">_v</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">_v</span> <span class="ow">in</span> <span class="n">rgb</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">rgb</span> <span class="ow">in</span> <span class="n">_atom_colors</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

<div class="viewcode-block" id="periodic_table"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.periodic_table">[docs]</a><span class="k">def</span> <span class="nf">periodic_table</span><span class="p">():</span>
    <span class="s2">&quot;Display colorerd elements in periodic table.&quot;</span>
    <span class="n">_copy_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;$^</span><span class="se">{{</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s1">$</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_atom_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>
    <span class="n">_copy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_atom_colors</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">180</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">180</span><span class="p">)]</span> <span class="c1"># keep as list before modification</span>

    <span class="n">inds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">17</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">19</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">*</span><span class="p">[(</span><span class="mi">30</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">48</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">12</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">54</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">18</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">72</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">36</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">90</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">54</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span><span class="o">*</span><span class="p">[(</span><span class="mi">93</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">71</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">108</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">86</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span><span class="o">*</span><span class="p">[(</span><span class="mi">111</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">103</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">147</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">57</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">)],</span>
            <span class="o">*</span><span class="p">[(</span><span class="mi">165</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mi">89</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">)]</span>
            <span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">:</span>
        <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_copy_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_copy_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array</span><span class="p">,(</span><span class="mi">10</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">names</span><span class="p">,(</span><span class="mi">10</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_axes</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span><span class="mf">4.5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">color</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<span class="c1"># Cell</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">FancyArrowPatch</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">proj3d</span>

<span class="k">class</span> <span class="nc">Arrow3D</span><span class="p">(</span><span class="n">FancyArrowPatch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw 3D fancy arrow.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">FancyArrowPatch</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verts3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="n">u</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">v</span><span class="p">],</span> <span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">z</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renderer</span><span class="p">):</span>
        <span class="n">xs3d</span><span class="p">,</span> <span class="n">ys3d</span><span class="p">,</span> <span class="n">zs3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verts3d</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="o">=</span> <span class="n">proj3d</span><span class="o">.</span><span class="n">proj_transform</span><span class="p">(</span><span class="n">xs3d</span><span class="p">,</span> <span class="n">ys3d</span><span class="p">,</span> <span class="n">zs3d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">M</span><span class="p">)</span> <span class="c1">#renderer&gt;M for &lt; 3.4 but we don&#39;t need it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">((</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_3d_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renderer</span><span class="p">):</span> <span class="c1"># For matplotlib &gt;= 3.5</span>
        <span class="n">xs3d</span><span class="p">,</span> <span class="n">ys3d</span><span class="p">,</span> <span class="n">zs3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verts3d</span>
        <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span> <span class="o">=</span> <span class="n">proj3d</span><span class="o">.</span><span class="n">proj_transform</span><span class="p">(</span><span class="n">xs3d</span><span class="p">,</span> <span class="n">ys3d</span><span class="p">,</span> <span class="n">zs3d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">((</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="fancy_quiver3d"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.fancy_quiver3d">[docs]</a><span class="k">def</span> <span class="nf">fancy_quiver3d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">C</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">L</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span><span class="n">mutation_scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots 3D arrows on a given ax. See [FancyArrowPatch](https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.patches.FancyArrowPatch.html).</span>
<span class="sd">    Args:</span>
<span class="sd">        - X, Y, Z : 1D arrays of coordinates of arrows&#39; tail point.</span>
<span class="sd">        - U, V, W : 1D arrays of dx,dy,dz of arrows.</span>
<span class="sd">        - ax: 3D axes, if not given, auto created.</span>
<span class="sd">        - C : 1D colors array mapping for arrows. Could be one color.</span>
<span class="sd">        - L : 1D linwidths array mapping for arrows. Could be one linewidth.</span>
<span class="sd">        - mutation_scale: Arrow head width/size scale. Default is 10.</span>
<span class="sd">        - kwargs: FancyArrowPatch&#39;s keyword arguments excluding positions,color, lw and mutation_scale, shrinkA, shrinkB which are already used. An important keyword argument is `arrowstyle` which could be &#39;-&gt;&#39;,&#39;-|&gt;&#39;, their inverted forms and many more. See on matplotlib.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_axes</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.4</span><span class="p">,</span><span class="mf">3.4</span><span class="p">),</span><span class="n">axes_3d</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Same aspect ratio.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">C</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="o">*</span><span class="n">mplc</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">C</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="c1"># Safe for list</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">L</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">]</span>
    <span class="n">args_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mutation_scale</span><span class="o">=</span><span class="n">mutation_scale</span><span class="p">,</span><span class="n">shrinkA</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shrinkB</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="n">Arrow3D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="n">l</span><span class="p">,</span><span class="o">**</span><span class="n">args_dict</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">get_selective_dynamics</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns selective dynamics array for a given POSCAR or None if no inputb given. By default, if a direction is not given, it turns ON with others.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: POSCAR data.</span>
<span class="sd">        - a, b, c: Arrays of shape (N,2) that contain ranges in fractional coordinates to turn selective dynamics on.</span>

<span class="sd">    - **Usage**</span>
<span class="sd">        - `get_selective_dynamics(poscar_data, a = [(0,0.1),(0.9,1)])` will turn selective dynamics on for the first and last 10% of the unit cell in a-direction as T T T.</span>
<span class="sd">        - `get_selective_dynamics(poscar_data, a = [(0,0.1),(0.9,1)], b = [(0,0.1),(0.9,1)])` will turn selective dynamics on for the first and last 10% of the unit cell in ab-plane in form of T T T, F T T and T F T whichever applies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">out_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="p">])</span> <span class="c1"># Default array</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">out_array</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">),</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
    <span class="k">elif</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`a` should be None or array of ranges of shape (N,2) to turn on selective dynamics. got </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">out_array</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">),</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
    <span class="k">elif</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`b` should be None or array of ranges of shape (N,2) to turn on selective dynamics. got </span><span class="si">{</span><span class="n">b</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">out_array</span><span class="p">[(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">),</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
    <span class="k">elif</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`c` should be None or array of ranges of shape (N,2) to turn on selective dynamics. got </span><span class="si">{</span><span class="n">c</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Now Turn ON what is not given but present in other directions</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_array</span><span class="p">[(</span><span class="n">out_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">out_array</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>

    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_array</span><span class="p">[(</span><span class="n">out_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">out_array</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_array</span><span class="p">[(</span><span class="n">out_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">out_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">out_array</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">write_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">selective_dynamics</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes poscar data object to a file or returns string</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: Output of `export_poscar`,`join_poscars` etc.</span>
<span class="sd">        - outfile  : str,file path to write on.</span>
<span class="sd">        - selective_dynamics  : A list [&#39;T T T&#39;,&#39;F F F&#39;,...] strings to turn on selective dynamics at required sites. Use `get_selective_dynamics` to build this list precisely.</span>
<span class="sd">        - overwrite: bool, if file already exists, overwrite=True changes it.</span>

<span class="sd">    **Note**: POSCAR is only written in direct format even if it was loaded from cartesian format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_comment</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">comment</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">SYSTEM</span><span class="si">}</span><span class="s1">  # &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">_comment</span> <span class="ow">or</span> <span class="s1">&#39;Created by Pivopty&#39;</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">scale</span>
    <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{:&lt;20.14f}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:&gt;22.16f}{:&gt;22.16f}{:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span><span class="o">/</span><span class="n">scale</span><span class="p">])</span>
    <span class="n">uelems</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;    &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span> <span class="o">+</span> <span class="s1">&#39;    &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">selective_dynamics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Selective Dynamics&quot;</span>

    <span class="n">out_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Direct</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span>
    <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:&gt;21.16f}{:&gt;21.16f}{:&gt;21.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">selective_dynamics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selective_dynamics</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;len(selective_dynamics) != len(sites).&quot;</span><span class="p">)</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">   </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pos_list</span><span class="p">,</span><span class="n">selective_dynamics</span><span class="p">)]</span>
    <span class="n">out_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pos_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfile</span><span class="si">!r}</span><span class="s2"> exists, can not overwrite, </span><span class="se">\n</span><span class="s2">use overwrite=True if you want to chnage.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">export_poscar</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">content</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Export POSCAR file to python objects. Only Direct POSCAR supported.</span>
<span class="sd">    Args:</span>
<span class="sd">        - path: Path/to/POSCAR file. Auto picks in CWD.</span>
<span class="sd">        - content: POSCAR content as string, This takes precedence to path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="c1"># This acts as slice for islice2array.</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./POSCAR&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Exported by Pivopty&#39;</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># If that is for volume</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="c1">#volume = np.linalg.det(basis)</span>
    <span class="c1">#rec_basis = np.linalg.inv(basis).T # general formula</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">SYSTEM</span><span class="p">,</span><span class="c1">#&#39;volume&#39;:volume,</span>
                <span class="s1">&#39;basis&#39;</span><span class="p">:</span><span class="n">basis</span><span class="p">,</span><span class="c1">#&#39;rec_basis&#39;:rec_basis,</span>
                <span class="s1">&#39;extra_info&#39;</span><span class="p">:{</span><span class="s1">&#39;comment&#39;</span><span class="p">:</span><span class="n">comment</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span><span class="n">scale</span><span class="p">}}</span>

    <span class="n">elems</span> <span class="o">=</span> <span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ions</span> <span class="o">=</span> <span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ions</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="n">ions</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># Check Cartesian and Selective Dynamics</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span> <span class="c1"># remove whitespace or tabs</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;cartesian&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">((</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;cCkK&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;cCkK&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="c1"># Two lines are excluded in below command before start. so start = 7-2</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="s2">&quot;^\s+[a-zA-Z]|^[a-zA-Z]&quot;</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))[:</span><span class="n">N</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;cartesian&#39;</span><span class="p">]:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">to_basis</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Cartesian format found in POSCAR file, converted to direct format.&quot;</span><span class="p">))</span>

    <span class="n">unique_d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elems</span><span class="p">):</span>
        <span class="n">unique_d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">e</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])})</span>

    <span class="n">elem_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elems</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">elem_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span> <span class="o">-</span> <span class="n">inds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">out_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span><span class="n">positions</span><span class="p">,</span><span class="c1">#&#39;labels&#39;:elem_labels,</span>
                     <span class="s1">&#39;unique&#39;</span><span class="p">:</span><span class="n">unique_d</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">_save_mp_API</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Save materials project api key for autoload in functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span><span class="s1">&#39;.ipyvasprc&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="s1">&#39;MP_API_KEY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MP_API_KEY = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api_key</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">_load_mp_data</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span><span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_sites</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_sites</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns fetched data using request api of python form materials project website.</span>
<span class="sd">    Args:</span>
<span class="sd">        - formula  : Material formula such as &#39;NaCl&#39;.</span>
<span class="sd">        - api_key  : API key for your account from material project site. Auto picks if you already used `_save_mp_API` function.</span>
<span class="sd">        - mp_id     : Optional, you can specify material ID to filter results.</span>
<span class="sd">        - max_sites : Maximum number of sites. If None, sets `min_sites + 1`, if `min_sites = None`, gets all data.</span>
<span class="sd">        - min_sites : Minimum number of sites. If None, sets `max_sites + 1`, if `max_sites = None`, gets all data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">api_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">home</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span><span class="s1">&#39;.ipyvasprc&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;MP_API_KEY&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">api_key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;api_key not given. provide in argument or generate in file using `_save_mp_API(your_mp_api_key)&quot;</span><span class="p">)</span>

    <span class="c1">#url must be a raw string</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://legacy.materialsproject.org/rest/v2/materials/</span><span class="si">{}</span><span class="s2">/vasp?API_KEY=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error in fetching data from materials project. Try again!&quot;</span><span class="p">)</span>

    <span class="n">jl</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;response&#39;</span> <span class="ow">in</span> <span class="n">jl</span><span class="p">:</span> <span class="c1">#check if response</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either formula </span><span class="si">{!r}</span><span class="s2"> or API_KEY is incorrect.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formula</span><span class="p">))</span>

    <span class="n">all_res</span> <span class="o">=</span> <span class="n">jl</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">max_sites</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">min_sites</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">min_sites</span><span class="p">,</span> <span class="n">max_sites</span>
    <span class="k">elif</span> <span class="n">max_sites</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">min_sites</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">min_sites</span><span class="p">,</span> <span class="n">min_sites</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">max_sites</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">min_sites</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">max_sites</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_sites</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span> <span class="c1"># Unknown</span>

    <span class="k">if</span> <span class="n">lower</span> <span class="o">!=</span> <span class="s1">&#39;-1&#39;</span> <span class="ow">and</span> <span class="n">upper</span> <span class="o">!=</span> <span class="s1">&#39;-1&#39;</span><span class="p">:</span>
        <span class="n">sel_res</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_res</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;nsites&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;nsites&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower</span><span class="p">:</span>
                <span class="n">sel_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sel_res</span>
    <span class="c1"># Filter to mp_id at last. more preferred</span>
    <span class="k">if</span> <span class="n">mp_id</span> <span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_res</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mp_id</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;material_id&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">all_res</span>

<span class="c1"># Cell</span>
<span class="k">class</span> <span class="nc">InvokeMaterialsProject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Connect to materials project and get data using `api_key` from their site.</span>
<span class="sd">    Usage:</span>
<span class="sd">    ```python</span>
<span class="sd">    from ipyvaspr.sio import InvokeMaterialsProject # or import ipyvasp.InvokeMaterialsProject as InvokeMaterialsProject</span>
<span class="sd">    mp = InvokeMaterialsProject(api_key=&#39;your_api_key&#39;)</span>
<span class="sd">    outputs = mp.request(formula=&#39;NaCl&#39;) #returns list of structures from response</span>
<span class="sd">    outupts[0].export_poscar() #returns poscar data</span>
<span class="sd">    outputs[0].cif #returns cif data</span>
<span class="sd">    ```&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">api_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Request Materials Project acess. api_key is on their site. Your only need once and it is saved for later.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">save_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">api_key</span><span class="p">):</span>
        <span class="s2">&quot;Save api_key for auto reloading later.&quot;</span>
        <span class="n">_save_mp_API</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#cache for 2 calls</span>
    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">formula</span><span class="p">,</span><span class="n">mp_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">max_sites</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">min_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch data using request api of python form materials project website. After request, you can access `cifs` and `poscars`.</span>
<span class="sd">        Args:</span>
<span class="sd">            - formula  : Material formula such as &#39;NaCl&#39;.</span>
<span class="sd">            - mp_id     : Optional, you can specify material ID to filter results.</span>
<span class="sd">            - max_sites : Maximum number of sites. If None, sets `min_sites + 1`, if `min_sites = None`, gets all data.</span>
<span class="sd">            - min_sites : Minimum number of sites. If None, sets `max_sites + 1`, if `max_sites = None`, gets all data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__response</span> <span class="o">=</span> <span class="n">_load_mp_data</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="p">,</span><span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span> <span class="n">mp_id</span> <span class="o">=</span> <span class="n">mp_id</span><span class="p">,</span> <span class="n">max_sites</span> <span class="o">=</span> <span class="n">max_sites</span><span class="p">,</span><span class="n">min_sites</span><span class="o">=</span><span class="n">min_sites</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__response</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="n">req</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;Error in request. Check your api_key or formula.&quot;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span>    <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;cif&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>  <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crystal</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;spacegroup&#39;</span><span class="p">][</span><span class="s1">&#39;crystal_system&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unit</span>    <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;unit_cell_formula&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mp_id</span>   <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;material_id&#39;</span><span class="p">]</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">cif</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span>

            <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Structure(unit=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s2">,mp_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_id</span><span class="si">!r}</span><span class="s2">,symbol=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">!r}</span><span class="s2">,crystal=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">crystal</span><span class="si">!r}</span><span class="s2">,cif=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39;)&quot;</span>

            <span class="k">def</span> <span class="nf">write_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">write_poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
                <span class="s2">&quot;Use `ipyvasp.api.POSCAR.write/ipyvasp.sio.write_poscar` if you need extra options.&quot;</span>
                <span class="n">write_poscar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_poscar</span><span class="p">(),</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="n">overwrite</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">export_poscar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cif</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">abc</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">abc_ang</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;_cell&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;_length&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                            <span class="n">abc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;_angle&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                            <span class="n">abc_ang</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;_volume&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                            <span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;_structural&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                        <span class="n">top</span> <span class="o">=</span> <span class="n">ys</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; # [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mp_id</span><span class="si">!r}</span><span class="s2">][</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">!r}</span><span class="s2">][</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">crystal</span><span class="si">!r}</span><span class="s2">] Created by ipyvasp using Materials Project Database&quot;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;_atom_site_occupancy&#39;</span> <span class="ow">in</span> <span class="n">ys</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span><span class="mi">1</span> <span class="c1"># start collecting pos.</span>
                <span class="n">poses</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
                <span class="n">pos_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">:</span>
                    <span class="n">s_p</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">pos_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;12}</span><span class="s2">  </span><span class="si">{1:&gt;12}</span><span class="s2">  </span><span class="si">{2:&gt;12}</span><span class="s2">  </span><span class="si">{3}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">s_p</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">s_p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># ======== Cleaning ===========</span>
                <span class="n">abc_ang</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span> <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="n">abc_ang</span><span class="p">]</span>
                <span class="n">abc</span>     <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">abc</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;22.16f}</span><span class="s2"> </span><span class="si">{1:&gt;22.16f}</span><span class="s2"> </span><span class="si">{2:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># lattic vector a.</span>
                <span class="n">to_rad</span> <span class="o">=</span> <span class="mf">0.017453292519</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="n">abc_ang</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">to_rad</span>
                <span class="n">bx</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;22.16f}</span><span class="s2"> </span><span class="si">{1:&gt;22.16f}</span><span class="s2"> </span><span class="si">{2:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bx</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">by</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># lattic vector b.</span>
                <span class="n">cz</span> <span class="o">=</span> <span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">by</span><span class="p">)</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">abc_ang</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">to_rad</span><span class="p">)</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">abc_ang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">to_rad</span><span class="p">)</span><span class="o">-</span><span class="n">bx</span><span class="o">*</span><span class="n">cx</span><span class="p">)</span><span class="o">/</span><span class="n">by</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:&gt;22.16f}</span><span class="s2"> </span><span class="si">{1:&gt;22.16f}</span><span class="s2"> </span><span class="si">{2:&gt;22.16f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cx</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cy</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cz</span><span class="o">/</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># lattic vector b.</span>

                <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">elems</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
                <span class="n">nums</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="n">elem</span><span class="p">]))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">nums</span>  <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">elems</span><span class="si">}</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">nums</span><span class="si">}</span><span class="se">\n</span><span class="s2">Direct</span><span class="se">\n</span><span class="si">{</span><span class="n">pos_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">return</span> <span class="n">export_poscar</span><span class="p">(</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">)</span>


        <span class="c1"># get cifs</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__response</span><span class="p">:</span>
            <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Structure</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># set success flag</span>
        <span class="k">return</span> <span class="n">structures</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="get_kpath"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.get_kpath">[docs]</a><span class="k">def</span> <span class="nf">get_kpath</span><span class="p">(</span><span class="o">*</span><span class="n">patches</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span> <span class="kc">None</span> <span class="p">,</span><span class="n">ibzkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rec_basis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate list of kpoints along high symmetry path. Options are write to file or return KPOINTS list.</span>
<span class="sd">    It generates uniformly spaced point with input `n` as just a scale factor of number of points per unit length.</span>
<span class="sd">    You can also specify custom number of kpoints in an interval by putting number of kpoints as 4th entry in left kpoint.</span>
<span class="sd">    Parameters   </span>
<span class="sd">    ----------</span>
<span class="sd">        - *ptaches : Any number of disconnected patches where a single patch is a dictionary like {&#39;label&#39;: (x,y,z,[N]), ...} where x,y,z is high symmetry point and</span>
<span class="sd">                    N (optional) is number of points in current inteval, points in a connected path patch are at least two i.e. `{&#39;p1&#39;:[x1,y1,z1],&#39;p2&#39;:[x2,y2,z2]}`.</span>
<span class="sd">                    A key of a patch should be string reperenting the label of the high symmetry point. A key that starts with &#39;_&#39; is ignored, so you can add points without high symmetry points as well.</span>
<span class="sd">        - n        : int, number per length of body diagonal of rec_basis, this makes uniform steps based on distance between points.</span>
<span class="sd">        - weight : Float, if None, auto generates weights.</span>
<span class="sd">        - ibzkpt : Path to ibzkpt file, required for HSE calculations.</span>
<span class="sd">        - outfile: Path/to/file to write kpoints.</span>
<span class="sd">        - rec_basis: Reciprocal basis 3x3 array to use for calculating uniform points.</span>

<span class="sd">    If `outfile = None`, KPONITS file content is printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide at least one high symmetry path consisting of two points.&quot;</span><span class="p">)</span>

    <span class="n">hsk_list</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Patche must be a dictionary as {&#39;label&#39;: (x,y,z,[N]), ...}&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide at least one high symmetry path consisting of two points.&quot;</span><span class="p">)</span>
        <span class="n">_patch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">patch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Label must be a string&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">set</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Value must be a list or tuple of length 3 or 4, like (x,y,z,[N])&quot;</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;skip&#39;</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">_patch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">hsk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_patch</span><span class="p">)</span>

    <span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">zs</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span><span class="n">joinat</span> <span class="o">=</span> <span class="p">[],[],[],[</span><span class="mi">0</span><span class="p">],[]</span> <span class="c1"># 0 in inds list is important</span>
    <span class="n">_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_len_prev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hsk_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_m</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># number of points given explicitly.</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rec_basis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rec_basis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rec_basis</span><span class="p">)</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">to_R3</span><span class="p">(</span><span class="n">basis</span><span class="p">,[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]])</span>
                    <span class="n">largest_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># body diagonal</span>
                    <span class="n">_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="n">largest_dist</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">_a</span><span class="o">-</span><span class="n">_b</span> <span class="k">for</span> <span class="n">_a</span><span class="p">,</span><span class="n">_b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)]</span> <span class="c1"># restruct point if 4 entries</span>
                    <span class="n">_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">_vec</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># Calculate</span>

            <span class="n">_m</span> <span class="o">=</span> <span class="n">_m</span> <span class="k">if</span> <span class="n">_m</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">2</span> <span class="c1"># minimum of 2 points in a path</span>

            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">_m</span><span class="p">)</span> <span class="c1">#Append first then do next</span>
            <span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">_len_prev</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">joinat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># Add previous in joinpath and label</span>
                <span class="k">if</span> <span class="s1">&#39;skip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">_labels</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">_labels</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">_labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># Drop the label we added before</span>

            <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">_m</span><span class="p">)))</span>
            <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">_m</span><span class="p">)))</span>
            <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">_m</span><span class="p">)))</span>

        <span class="n">_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="n">_len_prev</span><span class="p">])</span> <span class="c1"># Add last in current interval</span>
        <span class="n">_len_prev</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span> <span class="c1">#flatten values.</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">ys</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">zs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">z</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xs</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0:&gt;16.10f}{1:&gt;16.10f}{2:&gt;16.10f}{3:&gt;12.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">zs</span><span class="p">)]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ibzkpt</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">+</span><span class="n">N</span> <span class="c1"># Update N.</span>
            <span class="n">slines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">ibz_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slines</span><span class="p">)</span>
            <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibz_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span> <span class="c1"># Update out_str</span>
    <span class="k">if</span> <span class="n">inds</span><span class="p">:</span>
        <span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># last index to -1</span>

    <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;skip&#39;</span> <span class="o">!=</span> <span class="n">_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
    <span class="n">_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|skip&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">_labels</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s1">&#39;skip&#39;</span><span class="p">]</span>
    <span class="n">top_str</span> <span class="o">=</span> <span class="s2">&quot;Automatically generated using ipyvasp with HSK-INDS = </span><span class="si">{}</span><span class="s2">, LABELS = </span><span class="si">{}</span><span class="s2">, SEG-INDS = </span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Reciprocal Lattice&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span><span class="n">_labels</span><span class="p">,</span><span class="n">joinat</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">read_ticks</span><span class="p">(</span><span class="n">kpoints_file_path</span><span class="p">):</span>
    <span class="s2">&quot;Reads ticks values and labels in header of kpoint file. Returns dictionary of `ktick_inds`,`ktick_vals`,`kseg_inds` that can be unpacked to plotting functions. If not exist in header, returns empty values(still valid).&quot;</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ktick_inds</span><span class="o">=</span><span class="p">[],</span><span class="n">ktick_vals</span><span class="o">=</span><span class="p">[],</span><span class="n">kseg_inds</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">kpoints_file_path</span><span class="p">):</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">vp</span><span class="o">.</span><span class="n">islice2array</span><span class="p">(</span><span class="n">kpoints_file_path</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;HSK-INDS&#39;</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
            <span class="n">hsk</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;HSK-INDS&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;ktick_inds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hsk</span> <span class="k">if</span> <span class="n">h</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;LABELS&#39;</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
            <span class="n">labs</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;LABELS&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;ktick_vals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labs</span> <span class="k">if</span> <span class="n">l</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;SEG-INDS&#39;</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
            <span class="n">segs</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;SEG-INDS&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;kseg_inds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segs</span> <span class="k">if</span> <span class="n">s</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out_dict</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="str2kpath"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.str2kpath">[docs]</a><span class="k">def</span> <span class="nf">str2kpath</span><span class="p">(</span><span class="n">kpath_str</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ibzkpt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rec_basis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get Kpath from a string of kpoints (Line-Mode like). Useful in Terminal.</span>
<span class="sd">    Args:</span>
<span class="sd">        - kpath_str: str, a multiline string similiar to line mode of KPOINTS, initial 4 lines are not required.</span>
<span class="sd">            - If you do not want to label a point, label it as &#39;skip&#39; and it will be removed.</span>
<span class="sd">            - You can add an interger at end of a line to customize number of points in a given patch.</span>
<span class="sd">            - Each empty line breaks the path, so similar points before and after empty line are useless here.</span>
<span class="sd">        - n      : int, number per length of body diagonal of rec_basis, this makes uniform steps based on distance between points.</span>
<span class="sd">        - weight : Float, if None, auto generates weights.</span>
<span class="sd">        - ibzkpt : Path to ibzkpt file, required for HSE calculations.</span>
<span class="sd">        - outfile: Path/to/file to write kpoints.</span>
<span class="sd">        - rec_basis: Reciprocal basis 3x3 array to use for calculating uniform points.</span>

<span class="sd">    - **Example**</span>
<span class="sd">        &gt; str2kpath(&#39;&#39;&#39;0 0 0 !$\Gamma$ 3</span>
<span class="sd">                    0.25 0.25 0.25 !L&#39;&#39;&#39;)</span>
<span class="sd">        &gt; Automatically generated using ipyvasp with HSK-INDS = [0, -1], LABELS = [&#39;$\\Gamma$&#39;, &#39;L&#39;], SEG-INDS = []</span>
<span class="sd">	    &gt;   3</span>
<span class="sd">        &gt; Reciprocal Lattice</span>
<span class="sd">        &gt;   0.0000000000    0.0000000000    0.0000000000    0.333333</span>
<span class="sd">        &gt;   0.1250000000    0.1250000000    0.1250000000    0.333333</span>
<span class="sd">        &gt;   0.2500000000    0.2500000000    0.2500000000    0.333333</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">kpath_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="n">skipN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_n</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">6</span><span class="p">]):</span> <span class="c1">#Handle strings from AFLOW-like softwares</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="n">skipN</span> <span class="o">=</span> <span class="n">_n</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">where_blanks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

    <span class="n">hsk_list</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">skipN</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">_labs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\$</span><span class="se">\\\\</span><span class="s1">[a-zA-Z]+\$|[a-zA-Z]+|[α-ωΑ-Ω]+|\|&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_labs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">_labs</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">_ks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;[-+\d]*[.][\d+]+|[-+]*\d+/\d+|[-+]*\d+&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
            <span class="n">_ks</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">_ks</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_ks</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">_ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Check if you provide fraction correctly in line </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">skipN</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_ks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">_ks</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ks</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;4th number in line </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">skipN</span><span class="si">}</span><span class="s1"> should be integer!&#39;</span><span class="p">)</span>

            <span class="n">hsk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">where_blanks</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">-</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">where_blanks</span><span class="p">)]</span>
        <span class="n">where_blanks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="n">filtered</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">hsk_list</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">where_blanks</span> <span class="k">else</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hsk_list</span><span class="p">,</span><span class="n">labels</span><span class="p">)},]</span> <span class="c1">#Fix up both</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">where_blanks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">where_blanks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There should be at least two points in a patch of path at line </span><span class="si">{</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hsk_list</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">b</span><span class="p">],</span><span class="n">labels</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">b</span><span class="p">])})</span>

    <span class="k">return</span> <span class="n">get_kpath</span><span class="p">(</span><span class="o">*</span><span class="n">patches</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span><span class="n">ibzkpt</span><span class="o">=</span><span class="n">ibzkpt</span><span class="p">,</span><span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span> <span class="n">rec_basis</span> <span class="o">=</span> <span class="n">rec_basis</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">_get_basis</span><span class="p">(</span><span class="n">path_pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns given(computed) and inverted basis as tuple(given,inverted).</span>
<span class="sd">    Args:</span>
<span class="sd">        - path_pos: path/to/POSCAR or 3 given vectors as rows of a matrix.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_pos</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">path_pos</span><span class="p">)</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">path_pos</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_pos</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_pos</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">export_poscar</span><span class="p">(</span><span class="n">path_pos</span><span class="p">)</span><span class="o">.</span><span class="n">basis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> does not exist or not 3 by 3 list.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_pos</span><span class="p">))</span>
    <span class="c1"># Process. 2π is not included in vasp output</span>
    <span class="n">rec_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="c1"># Compact Formula</span>
    <span class="n">Basis</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Basis&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;given&#39;</span><span class="p">,</span> <span class="s1">&#39;inverted&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Basis</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">rec_basis</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">get_kmesh</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cartesian</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ibzkpt</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**Note**: Use `ipyvasp.POSCAR.get_kmesh` to get k-mesh based on current POSCAR.</span>
<span class="sd">    - Generates uniform mesh of kpoints. Options are write to file, or return KPOINTS list.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: export_poscar() or export_vasprun().poscar().</span>
<span class="sd">        - *args: 1 or 3 integers which decide shape of mesh. If 1, mesh points equally spaced based on data from POSCAR.</span>
<span class="sd">        - shift  : Only works if cartesian = False. Defualt is 0. Could be a number or list of three numbers to add to interval [0,1].</span>
<span class="sd">        - weight : Float, if None, auto generates weights.</span>
<span class="sd">        - cartesian: If True, generates cartesian mesh.</span>
<span class="sd">        - ibzkpt : Path to ibzkpt file, required for HSE calculations.</span>
<span class="sd">        - outfile: Path/to/file to write kpoints.</span>
<span class="sd">        - endpoint: Default True, include endpoints in mesh at edges away from origin.</span>

<span class="sd">    If `outfile = None`, KPOINTS file content is printed.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_kmesh() takes 1 or 3 args!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cartesian</span><span class="p">:</span>
        <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">rec_basis</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">rec_basis</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_kmesh expects integer for first positional argument!&quot;</span><span class="p">)</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">norms</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span> <span class="c1"># For making largest side at given n</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_kmesh expects integer at position </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">low</span><span class="p">,</span><span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">shift</span>
    <span class="k">if</span> <span class="n">cartesian</span><span class="p">:</span>
        <span class="n">verts</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># Cartesian KPOINTS are in unit of 2pi/SCALE</span>
        <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

    <span class="p">(</span><span class="n">lx</span><span class="p">,</span><span class="n">ly</span><span class="p">,</span><span class="n">lz</span><span class="p">),(</span><span class="n">hx</span><span class="p">,</span><span class="n">hy</span><span class="p">,</span><span class="n">hz</span><span class="p">)</span> <span class="o">=</span> <span class="n">low</span><span class="p">,</span><span class="n">high</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lz</span><span class="p">,</span><span class="n">hz</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ly</span><span class="p">,</span><span class="n">hy</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lx</span><span class="p">,</span><span class="n">hx</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">):</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No KPOINTS in BZ from given input. Try larger input!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>

    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0:&gt;16.10f}{1:&gt;16.10f}{2:&gt;16.10f}{3:&gt;12.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ibzkpt</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ibzkpt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cartesian</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;cCkK&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ibzkpt file is in cartesian coordinates, use get_kmesh(...,cartesian = True)!&quot;</span><span class="p">)</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">+</span><span class="n">N</span> <span class="c1"># Update N.</span>
        <span class="n">slines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">N</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">ibz_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slines</span><span class="p">)</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ibz_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span> <span class="c1"># Update out_str</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;Reciprocal&#39;</span> <span class="k">if</span> <span class="n">cartesian</span> <span class="o">==</span> <span class="kc">False</span> <span class="k">else</span> <span class="s1">&#39;Cartesian&#39;</span>
    <span class="n">top_str</span> <span class="o">=</span> <span class="s2">&quot;Generated uniform mesh using ipyvasp, GRID-SHAPE = [</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top_str</span><span class="p">,</span><span class="n">out_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">out_str</span><span class="p">)</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">_tan_inv</span><span class="p">(</span><span class="n">vy</span><span class="p">,</span><span class="n">vx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns full angle from x-axis counter clockwise.</span>
<span class="sd">    Args:</span>
<span class="sd">        - vy : Perpendicular componet of vector including sign.</span>
<span class="sd">        - vx : Base compoent of vector including sign.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Place hodler to handle exceptions</span>
    <span class="k">if</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">vx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">vy</span><span class="o">/</span><span class="n">vx</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vy</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">vy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">loop</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns indices of counterclockwise ordered vertices of a plane in 3D.</span>
<span class="sd">    Args:</span>
<span class="sd">        - points: numpy array of shape (N,3) or List[List(len=3)].</span>
<span class="sd">        - loop  : Default is True and appends start point at end to make a loop.</span>
<span class="sd">    - **Example**</span>
<span class="sd">        &gt; pts = np.array([[1,0,3],[0,0,0],[0,1,2]])</span>
<span class="sd">        &gt; inds = order(pts)</span>
<span class="sd">        &gt; pts[inds]</span>
<span class="sd">        ```</span>
<span class="sd">        array([[1, 2, 3],</span>
<span class="sd">               [0, 0, 0],</span>
<span class="sd">               [1, 0, 3]</span>
<span class="sd">               [0, 1, 2]])</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="c1"># Make array.</span>
    <span class="c1"># Fix points if start point is zero.</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">+</span> <span class="mf">0.5</span>

    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 3D cent point.</span>
    <span class="n">vectors</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="n">center</span> <span class="c1"># Relative to center</span>

    <span class="n">ex</span> <span class="o">=</span> <span class="n">vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># i</span>
    <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
    <span class="n">ey</span> <span class="o">=</span> <span class="n">ey</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ey</span><span class="p">)</span>  <span class="c1"># j</span>

    <span class="n">angles</span><span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vectors</span><span class="p">):</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">ey</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">_tan_inv</span><span class="p">(</span><span class="n">vy</span><span class="p">,</span><span class="n">vx</span><span class="p">)</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">angle</span><span class="p">])</span>

    <span class="n">s_angs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">s_angs</span><span class="p">[</span><span class="n">s_angs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span> <span class="c1">#Sort it.</span>

    <span class="k">if</span> <span class="n">loop</span><span class="p">:</span> <span class="c1"># Add first at end for completing loop.</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ss</span><span class="p">,[</span><span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

    <span class="k">return</span> <span class="n">ss</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># Order indices.</span>


<span class="k">def</span> <span class="nf">_out_bz_plane</span><span class="p">(</span><span class="n">test_point</span><span class="p">,</span><span class="n">plane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns True if test_point is between plane and origin. Could be used to sample BZ mesh in place of ConvexHull.</span>
<span class="sd">    Args:</span>
<span class="sd">        - test_points: 3D point.</span>
<span class="sd">        - plane      : List of at least three coplanar 3D points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outside</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">p_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_point</span><span class="p">)</span>
    <span class="n">plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Avoid looped shape.</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#center</span>
    <span class="n">_dot_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p_test</span><span class="o">-</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_dot_</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-5</span><span class="p">:</span>
        <span class="n">outside</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">outside</span>


<span class="k">def</span> <span class="nf">_rad_angle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Returns interier angle between two vectors.</span>
<span class="sd">    Args:</span>
<span class="sd">        - v1,v2 : Two vectors/points in 3D.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">norm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">dot_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">dot_p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>
<div class="viewcode-block" id="rotation"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.rotation">[docs]</a><span class="k">def</span> <span class="nf">rotation</span><span class="p">(</span><span class="n">angle_deg</span><span class="p">,</span><span class="n">axis_vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a scipy Rotation object at given `angle_deg` around `axis_vec`.</span>
<span class="sd">    Usage:</span>
<span class="sd">        rot = rotation(60,[0,0,1])</span>
<span class="sd">        rot.apply([1,1,1])</span>
<span class="sd">        [-0.3660254  1.3660254  1.] #give this</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis_vec</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis_vec</span><span class="p">)</span> <span class="c1"># Normalization</span>
    <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle_deg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">angle_rad</span> <span class="o">*</span> <span class="n">axis_vec</span><span class="p">)</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">get_bz</span><span class="p">(</span><span class="n">path_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">primitive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Return required information to construct first Brillouin zone in form of tuple (basis, normals, vertices, faces).</span>
<span class="sd">    Args:</span>
<span class="sd">        - path_pos : POSCAR file path or list of 3 Real space vectors in 3D as list[list,list,list].</span>
<span class="sd">        - loop   : If True, joins the last vertex of a BZ plane to starting vertex in order to complete loop.</span>
<span class="sd">        - digits : int, rounding off decimal places, no effect on intermediate calculations, just for pretty final results.</span>
<span class="sd">        - primitive: Defualt is False and returns Wigner-Seitz cell, If True returns parallelipiped in rec_basis.</span>

<span class="sd">    - **Attributes**</span>
<span class="sd">        - basis   : get_bz().basis, recprocal lattice basis.</span>
<span class="sd">        - normals : get_bz().normals, all vertors that are perpendicular BZ faces/planes.</span>
<span class="sd">        - vertices: get_bz().vertices, all vertices of BZ, could be input into ConvexHull for constructing 3D BZ.</span>
<span class="sd">        - faces   : get_bz().faces, vertices arranged into faces, could be input to Poly3DCollection of matplotlib for creating BZ from faces&#39; patches.</span>
<span class="sd">        - specials : get_bz().specials, Data with attributes `coords`,`kpoints` and `near` in on-one correspondence for high symmetry KPOINTS in recirprocal coordinates space. `near` gives indices of nearest special points around a vertex. All vertices with z &gt; 0 are included.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">_get_basis</span><span class="p">(</span><span class="n">path_pos</span><span class="p">)</span><span class="o">.</span><span class="n">inverted</span> <span class="c1"># Reads</span>
    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="n">basis</span> <span class="c1"># basis are reciprocal basis</span>
    <span class="c1"># Get all vectors for BZ</span>
    <span class="k">if</span> <span class="n">primitive</span><span class="p">:</span>
        <span class="n">b0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">b1</span><span class="o">+</span><span class="n">b2</span><span class="o">+</span><span class="n">b3</span> <span class="c1">#Diagonal point</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                 <span class="p">[</span><span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b1</span><span class="o">+</span><span class="n">b2</span><span class="p">,</span> <span class="n">b2</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">b0</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">b2</span><span class="o">+</span><span class="n">b3</span><span class="p">,</span><span class="n">b3</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">b0</span><span class="p">,</span><span class="n">b3</span><span class="p">,</span><span class="n">b3</span><span class="o">+</span><span class="n">b1</span><span class="p">,</span><span class="n">b1</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">b1</span><span class="p">,</span><span class="n">b1</span><span class="o">+</span><span class="n">b2</span><span class="p">,</span><span class="n">b1</span><span class="o">+</span><span class="n">b3</span><span class="p">,</span><span class="n">bd</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">b2</span><span class="p">,</span><span class="n">b2</span><span class="o">+</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="o">+</span><span class="n">b3</span><span class="p">,</span><span class="n">bd</span><span class="p">],</span>
                 <span class="p">[</span><span class="n">b3</span><span class="p">,</span><span class="n">b3</span><span class="o">+</span><span class="n">b1</span><span class="p">,</span><span class="n">b3</span><span class="o">+</span><span class="n">b2</span><span class="p">,</span><span class="n">bd</span><span class="p">]</span>
                <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">b1</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">b2</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">b3</span><span class="p">)</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
        <span class="c1"># Generate voronoi diagram</span>
        <span class="n">vor</span> <span class="o">=</span> <span class="n">Voronoi</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vrd</span> <span class="o">=</span> <span class="n">vor</span><span class="o">.</span><span class="n">ridge_dict</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">vrd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">verts_in_face</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vor</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vrd</span><span class="p">[</span><span class="n">r</span><span class="p">]])</span>
                <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">verts_in_face</span><span class="p">)</span>
        <span class="c1">#faces = np.array(faces) # should be a list instead as not regular shape.</span>

    <span class="n">verts</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">faces</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">]</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">face_vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
        <span class="n">face_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># In primitive point at face center</span>
    <span class="k">if</span> <span class="n">primitive</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">face_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">face_vectors</span><span class="p">]</span> <span class="c1"># In regular, cross plane as well.</span>

    <span class="c1"># Order Faces.</span>
    <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span><span class="n">face</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">face</span><span class="p">,</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)]</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">]</span> <span class="c1"># order based on given value of loop</span>

    <span class="c1"># High symmerty KPOINTS in primitive BZ (positive only)</span>
    <span class="n">mid_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">face</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">])</span>
    <span class="n">mid_edges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Do not insert point between unique vertices</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">mid_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mid_edges</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="n">mid_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mid_edges</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># because faces share edges</span>
        <span class="n">mid_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mid_faces</span><span class="p">,</span><span class="n">mid_edges</span><span class="p">])</span>
    <span class="c1"># Bring all high symmetry points together.</span>
    <span class="n">mid_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span><span class="n">mid_faces</span><span class="p">,</span><span class="n">verts</span><span class="p">])</span> <span class="c1"># Coords</span>
    <span class="n">mid_basis_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mid_all</span><span class="p">])</span> <span class="c1"># Kpoints</span>

    <span class="c1"># Round off results</span>
    <span class="n">mid_all_p</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mid_all</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span> <span class="c1"># Coordinates</span>
    <span class="n">mid_basis_p</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mid_basis_all</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span> <span class="c1"># Relative points</span>
    <span class="n">basis</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">face_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">face_vectors</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">verts</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span>
    <span class="n">faces</span>        <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">face</span><span class="p">,</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">])</span>

    <span class="c1">#Order special points near each vertex for z &gt; 0.</span>
    <span class="n">_arrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">verts</span><span class="p">[</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># Only upper hemisphere.</span>
        <span class="n">_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mid_all_p</span><span class="p">):</span> <span class="c1"># coordinates.</span>
            <span class="n">_arr</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">c</span><span class="p">)])</span>
        <span class="n">_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_arr</span><span class="p">)</span>
        <span class="n">_arr</span> <span class="o">=</span> <span class="n">_arr</span><span class="p">[</span><span class="n">_arr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">upto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_arr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_arrs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="n">_arr</span><span class="p">[:</span><span class="n">upto</span><span class="p">]])</span>
    <span class="n">one2one</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">mid_all_p</span> <span class="p">,</span><span class="s1">&#39;kpoints&#39;</span><span class="p">:</span> <span class="n">mid_basis_p</span><span class="p">,</span><span class="s1">&#39;near&#39;</span><span class="p">:</span> <span class="n">_arrs</span><span class="p">}</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;basis&#39;</span><span class="p">:</span><span class="n">basis</span><span class="p">,</span> <span class="s1">&#39;normals&#39;</span><span class="p">:</span><span class="n">face_vectors</span><span class="p">,</span> <span class="s1">&#39;vertices&#39;</span><span class="p">:</span><span class="n">verts</span><span class="p">,</span>
                <span class="s1">&#39;faces&#39;</span><span class="p">:</span><span class="n">faces</span><span class="p">,</span><span class="s1">&#39;specials&#39;</span><span class="p">:</span><span class="n">one2one</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">dict2tuple</span><span class="p">(</span><span class="s1">&#39;BZ&#39;</span><span class="p">,</span><span class="n">out_dict</span><span class="p">)</span>


<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">splot_bz</span><span class="p">(</span><span class="n">bz_data</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plane</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">vectors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">v3</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">vname</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span><span class="n">light_from</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Plots matplotlib&#39;s static figure.</span>
<span class="sd">    Args:</span>
<span class="sd">        - bz_data    : Output of `get_bz`.</span>
<span class="sd">        - fill       : True by defult, determines whether to fill surface of BZ or not.</span>
<span class="sd">        - color      : color to fill surface and stroke color.</span>
<span class="sd">        - vectors    : Plots basis vectors, default is True.</span>
<span class="sd">        - v3         : Plots 3rd vector as well. Only works in 2D and when `vectors=True`.</span>
<span class="sd">        - plane      : Default is None and plots 3D surface. Can take &#39;xy&#39;,&#39;yz&#39;,&#39;zx&#39; to plot in 2D.</span>
<span class="sd">        - ax         : Auto generated by default, 2D/3D axes, auto converts in 3D on demand as well.</span>
<span class="sd">        - vname      : Default is `b` for reciprocal space, can set `a` for plotting cell as after `get_bz(get_bz().basis)` you get real space lattice back if `primitive=True` both times.</span>
<span class="sd">        - colormap  : If None, single color is applied, only works in 3D and `fill=True`. Colormap is applied along z.</span>
<span class="sd">        - light_from: Point from where light is thrown on BZ planes, default is (1,1,1). Only works on plane in 3D.</span>
<span class="sd">        - alpha    : Opacity of filling in range [0,1]. Increase for clear viewpoint.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - ax   : Matplotlib&#39;s 2D axes if `plane=None`.</span>
<span class="sd">        - ax3d : Matplotlib&#39;s 2D axes if `plane` is given.</span>

<span class="sd">    &gt; Tip: `splot_bz(rec_basis,primitive=True)` will plot cell in real space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$k_</span><span class="si">{}</span><span class="s2">$&quot;</span> <span class="k">if</span> <span class="n">vname</span><span class="o">==</span><span class="s1">&#39;b&#39;</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span> <span class="c1">#For both 3D and 2D, initialize 2D axis.</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_axes</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.4</span><span class="p">,</span><span class="mf">3.4</span><span class="p">))</span> <span class="c1">#For better display</span>

    <span class="n">_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\vec</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">)</span> <span class="c1"># For both</span>

    <span class="n">valid_planes</span> <span class="o">=</span> <span class="s1">&#39;xyzxzyx&#39;</span> <span class="c1"># cylic</span>
    <span class="k">if</span> <span class="n">plane</span> <span class="ow">and</span> <span class="n">plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_planes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`plane` expects value in &#39;xyzxzyx&#39; or None, got </span><span class="si">{</span><span class="n">plane</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plane</span> <span class="ow">and</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">valid_planes</span><span class="p">:</span> <span class="c1">#Project 2D</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">valid_planes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">f</span><span class="p">[:,</span><span class="n">j</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="n">color</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">vectors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v3</span><span class="p">:</span>
                <span class="n">s_basis</span> <span class="o">=</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span>
                <span class="n">ijk</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_basis</span> <span class="o">=</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span><span class="c1"># Only two.</span>
                <span class="n">ijk</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span><span class="n">s_basis</span><span class="p">):</span>
                <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; $</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_label</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mf">0.8</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">l</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]],[</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">)</span> <span class="c1"># Must be to scale below arrow.</span>

            <span class="n">s_zero</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">s_b</span> <span class="ow">in</span> <span class="n">s_basis</span><span class="p">]</span> <span class="c1"># either 3 or 2.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">s_zero</span><span class="p">,</span><span class="n">s_zero</span><span class="p">,</span><span class="o">*</span><span class="n">s_basis</span><span class="o">.</span><span class="n">T</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]],</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">angles</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">scale_units</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_planes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_planes</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Must for 2D axes to show actual lengths of BZ</span>
        <span class="k">return</span> <span class="n">ax</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># Plot 3D</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">and</span> <span class="n">ax</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;3d&quot;</span><span class="p">:</span>
            <span class="n">ax3d</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="n">ax3d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span><span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">proj_type</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colormap</span><span class="p">:</span>
                <span class="n">colormap</span> <span class="o">=</span> <span class="n">colormap</span> <span class="k">if</span> <span class="n">colormap</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;viridis&#39;</span>
                <span class="n">cz</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">cz</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cz</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">cz</span><span class="p">)</span> <span class="c1"># along Z.</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)(</span><span class="n">levels</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">*</span><span class="n">mplc</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">color</span><span class="p">)]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span><span class="p">])</span> <span class="c1"># Single color.</span>
            <span class="k">if</span> <span class="n">light_from</span><span class="p">:</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">normals</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">light_from</span><span class="p">)</span> <span class="c1">#Plane facing light</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensity</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">c</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span><span class="n">colors</span><span class="p">)])</span>

            <span class="n">poly</span> <span class="o">=</span> <span class="n">Poly3DCollection</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="p">[</span><span class="n">color</span><span class="p">,],</span><span class="n">facecolors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">ax3d</span><span class="o">.</span><span class="n">add_collection3d</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">ax3d</span><span class="o">.</span><span class="n">autoscale_view</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax3d</span><span class="o">.</span><span class="n">plot3D</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">f</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">f</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="n">color</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">vectors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="mf">0.35</span><span class="o">*</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">):</span>
                <span class="n">ax3d</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="sa">r</span><span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_label</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

            <span class="n">XYZ</span><span class="p">,</span><span class="n">UVW</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">T</span>
            <span class="n">fancy_quiver3d</span><span class="p">(</span><span class="o">*</span><span class="n">XYZ</span><span class="p">,</span><span class="o">*</span><span class="n">UVW</span><span class="p">,</span><span class="n">C</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3d</span><span class="p">,</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-|&gt;&quot;</span><span class="p">,</span><span class="n">mutation_scale</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="n">l_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">h_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">l_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">h_</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">l_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">h_</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">([</span><span class="n">l_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">h_</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

        <span class="c1"># Set aspect to same as data.</span>
        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
        <span class="n">ax3d</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ax3d</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">iplot_bz</span><span class="p">(</span><span class="n">bz_data</span><span class="p">,</span><span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;rgba(168,204,216,0.4)&#39;</span><span class="p">,</span><span class="n">background</span> <span class="o">=</span> <span class="s1">&#39;rgb(255,255,255)&#39;</span><span class="p">,</span><span class="n">vname</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">special_kpoints</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">ortho3d</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - Plots interactive figure showing axes,BZ surface, special points and basis, each of which could be hidden or shown.</span>
<span class="sd">    Args:</span>
<span class="sd">        - bz_data    : Output of `get_bz`.</span>
<span class="sd">        - fill       : True by defult, determines whether to fill surface of BZ or not.</span>
<span class="sd">        - color      : color to fill surface &#39;rgba(168,204,216,0.4)` by default.</span>
<span class="sd">        - background : Plot background color, default is &#39;rgb(255,255,255)&#39;.</span>
<span class="sd">        - vname      : Default is `b` for reciprocal space, can set `a` for plotting cell as after `get_bz(get_bz().basis)` you get real space lattice back if `primitive=True` both times.</span>
<span class="sd">        - special_kpoints : True by default, determines whether to plot special points or not.</span>
<span class="sd">        - alpha      : Opacity of BZ planes.</span>
<span class="sd">        - ortho3d    : Default is True, decides whether x,y,z are orthogonal or perspective.</span>
<span class="sd">        - fig        : (Optional) Plotly&#39;s `go.Figure`. If you want to plot on another plotly&#39;s figure, provide that.</span>
<span class="sd">    - **Returns**</span>
<span class="sd">        - fig   : plotly.graph_object&#39;s Figure instance.</span>

<span class="sd">    &gt; Tip: `iplot_bz(rec_basis,primitive=True)` will plot cell in real space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="c1"># Name fixing</span>
    <span class="n">axes_text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;b&gt;k&lt;/b&gt;&lt;sub&gt;x&lt;/sub&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;k&lt;/b&gt;&lt;sub&gt;y&lt;/sub&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;k&lt;/b&gt;&lt;sub&gt;z&lt;/sub&gt;&quot;</span><span class="p">]</span>
    <span class="n">s_name</span> <span class="o">=</span> <span class="s1">&#39;BZ&#39;</span>
    <span class="n">a_name</span> <span class="o">=</span> <span class="s1">&#39;Axes&#39;</span>
    <span class="k">if</span> <span class="n">vname</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
        <span class="n">axes_text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;b&gt;x&lt;/b&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;y&lt;/b&gt;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;z&lt;/b&gt;&quot;</span><span class="p">]</span> <span class="c1"># Real space</span>
        <span class="n">s_name</span> <span class="o">=</span> <span class="s1">&#39;Lattice&#39;</span>
        <span class="n">a_name</span> <span class="o">=</span> <span class="s1">&#39;RealAxes&#39;</span>

    <span class="c1"># Axes</span>
    <span class="n">_len</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">_len</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">_len</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">_len</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+text&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span> <span class="n">axes_text</span><span class="p">,</span>
        <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">a_name</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">a_name</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Cone</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">_len</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.95</span><span class="o">*</span><span class="n">_len</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.95</span><span class="o">*</span><span class="n">_len</span><span class="p">],</span>
        <span class="n">u</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">_len</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.2</span><span class="o">*</span><span class="n">_len</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.2</span><span class="o">*</span><span class="n">_len</span><span class="p">],</span><span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">,</span><span class="n">legendgroup</span><span class="o">=</span><span class="n">a_name</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">a_name</span><span class="p">))</span>
    <span class="c1"># Basis</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+text&#39;</span><span class="p">,</span><span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{}</span><span class="s2">&lt;/b&gt;&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{}</span><span class="s2">&lt;/b&gt;&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Cone</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">u</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="o">*</span><span class="n">b</span>  <span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
            <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{}</span><span class="s2">&lt;/b&gt;&lt;sub&gt;</span><span class="si">{}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># Faces</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span><span class="n">line_color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">legendgroup</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="n">legend</span><span class="p">))</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Only first legend to show for all</span>

    <span class="k">if</span> <span class="n">fill</span><span class="p">:</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">ConvexHull</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Mesh3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">xc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">xc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="n">alphahull</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">lighting</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">diffuse</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">legendgroup</span><span class="o">=</span><span class="n">s_name</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">s_name</span><span class="p">))</span>

    <span class="c1"># Special Points only if in reciprocal space.</span>
    <span class="k">if</span> <span class="n">vname</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span> <span class="ow">and</span> <span class="n">special_kpoints</span><span class="p">:</span>
        <span class="n">texts</span><span class="p">,</span><span class="n">values</span> <span class="o">=</span><span class="p">[],[]</span>
        <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">specials</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">specials</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">norm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">kpoints</span><span class="p">,</span> <span class="n">sps</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">norms</span><span class="p">)):</span>
            <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;P</span><span class="si">{}</span><span class="s2">&lt;/br&gt;d = </span><span class="si">{}</span><span class="s2">&lt;/br&gt; Index = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">norm</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="o">*</span><span class="n">value</span><span class="p">,</span><span class="n">norm</span><span class="p">]])</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">norm_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">c_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="mi">255</span><span class="o">/</span><span class="n">norm_max</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]])</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c_vals</span><span class="p">]</span>
        <span class="n">_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">c_vals</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_lnp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">_unique</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_u_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rgb(</span><span class="si">{}</span><span class="s2">,0,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_lnp</span><span class="p">,</span><span class="n">_lnp</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">_un</span><span class="p">,</span><span class="n">_uc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_unique</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">_u_colors</span><span class="p">):</span>
            <span class="n">_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c_vals</span> <span class="o">==</span> <span class="n">_un</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">_ind</span> <span class="ow">in</span> <span class="n">_index</span><span class="p">:</span>
                <span class="n">colors</span><span class="p">[</span><span class="n">_ind</span><span class="p">]</span><span class="o">=</span><span class="n">_uc</span>

        <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="s2">&quot;rgb(255,215,0)&quot;</span> <span class="c1"># Gold color at Gamma!.</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="o">=</span><span class="n">values</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">hovertext</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;HSK&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;orthographic&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">ortho3d</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">camera</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span><span class="o">**</span><span class="n">proj</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene_camera</span><span class="o">=</span><span class="n">camera</span><span class="p">,</span><span class="n">paper_bgcolor</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">plot_bgcolor</span><span class="o">=</span><span class="n">background</span><span class="p">,</span>
        <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span><span class="n">font_size</span><span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
        <span class="n">scene</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">aspectmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">xaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">showbackground</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                        <span class="n">yaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">showbackground</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                        <span class="n">zaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">showbackground</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span>
                        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Cell</span>
<div class="viewcode-block" id="to_R3"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.to_R3">[docs]</a><span class="k">def</span> <span class="nf">to_R3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms coordinates of points (relative to non-othogonal basis) into orthogonal space.</span>
<span class="sd">    Args:</span>
<span class="sd">        - basis : Non-orthogonal basis of real or reciprocal space.</span>
<span class="sd">        - points: 3D points relative to basis, such as KPOINTS and Lattice Points.</span>

<span class="sd">    **Note**: Do not use this function if points are Cartesian or provide identity basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rec_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="c1"># Formula to make coordinates from relative points.</span>
    <span class="c1"># kx, ky, kz = n1*b1 + n2*b2 +n3*b3</span>
    <span class="c1">#            = [n1, n2, n3].dot(rec_basis)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rec_basis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coords</span></div>

<div class="viewcode-block" id="to_basis"><a class="viewcode-back" href="../../apidoc.html#ipyvasp.to_basis">[docs]</a><span class="k">def</span> <span class="nf">to_basis</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">coords</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms coordinates of points (relative to othogonal basis) into basis space.</span>
<span class="sd">    Args:</span>
<span class="sd">        - basis : Non-orthogonal basis of real or reciprocal space.</span>
<span class="sd">        - points: 3D points relative to cartesian axes, such as KPOINTS and Lattice Points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">kpoints2bz</span><span class="p">(</span><span class="n">bz_data</span><span class="p">,</span><span class="n">kpoints</span><span class="p">,</span><span class="n">sys_info</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Brings KPOINTS inside BZ. Applies `to_R3` only if `primitive=True`.</span>
<span class="sd">    Args:</span>
<span class="sd">        - bz_data  : Output of get_bz(), make sure use same value of `primitive` there and here.</span>
<span class="sd">        - kpoints  : List or array of KPOINTS to transorm into BZ or R3.</span>
<span class="sd">        - sys_info : If given, returns kpoints using that information. Useful If kpoints are cartesian and you need to scale those.</span>
<span class="sd">        - primitive: Default is False and brings kpoints into regular BZ. If True, returns `to_R3()`.</span>
<span class="sd">        - shift    : This value is added to kpoints before any other operation, single number of list of 3 numbers for each direction.</span>

<span class="sd">    **Note**: If kpoints are Cartesian, provide sys_info, otherwise it will go wrong.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kpoints</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span>
    <span class="k">if</span> <span class="n">sys_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys_info</span><span class="o">.</span><span class="n">space_info</span><span class="o">.</span><span class="n">cartesian_kpoints</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_R3</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span><span class="n">kpoints</span><span class="p">)</span> <span class="c1"># Already relative to basis of BZ</span>

    <span class="k">if</span> <span class="n">primitive</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">to_R3</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span><span class="n">kpoints</span><span class="p">)</span>

    <span class="n">cent_planes</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">face</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">bz_data</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span>

    <span class="n">out_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">kpoints</span><span class="p">))</span> <span class="c1"># To store back</span>

    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span><span class="n">cent_planes</span><span class="p">):</span>
        <span class="n">_dots_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coord</span><span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cent_planes</span><span class="p">])</span> <span class="c1">#max in all planes</span>
        <span class="c1">#print(_dots_)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_dots_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span> <span class="c1"># Outside</span>
            <span class="k">return</span> <span class="p">[]</span> <span class="c1"># empty for comparison</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Inside</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="c1"># Must be in list form</span>


    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kpoints</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># First translate, then make coords, then feed it back</span>
            <span class="c1">#print(q)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">to_R3</span><span class="p">(</span><span class="n">bz_data</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">inside</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">cent_planes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                <span class="c1">#print(p,&#39;--&gt;&#39;,r)</span>
                <span class="n">out_coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="ne">StopIteration</span>

    <span class="k">return</span> <span class="n">out_coords</span> <span class="c1"># These may have duplicates, apply np.unique(out_coords,axis=0). do this in surface plots</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">fix_sites</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">translate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add equivalent sites to make a full data shape of lattice. Returns same data after fixing.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: Output of `export_poscar` or `export_vasprun().poscar`.</span>
<span class="sd">        - tol   : Tolerance value. Default is 0.01.</span>
<span class="sd">        - eqv_sites: If True, add sites on edges and faces. If False, just fix coordinates, i.e. `pos &gt; 1 - tol -&gt; pos - 1`, useful for merging poscars to make slabs.</span>
<span class="sd">        - translate: A number(+/-) or list of three numbers to translate in a,b,c directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># We can also do poscar_data.copy().positions that copies all contents.</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">labels</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># For output</span>

    <span class="k">if</span> <span class="n">translate</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">translate</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">translate</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">translate</span><span class="p">))</span> <span class="c1"># Only translate in 0 - 1</span>
    <span class="k">elif</span> <span class="n">translate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">txyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">translate</span><span class="p">])</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">txyz</span> <span class="o">-</span> <span class="n">txyz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="c1"># Fix coordinates of sites distributed on edges and faces</span>
    <span class="n">pos</span> <span class="o">-=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tol</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># Move towards orign for common fixing like in joining POSCARs</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Modified by ipyvasp&#39;</span>

    <span class="c1"># Add equivalent sites on edges and faces if given,handle each sepecies separately</span>
    <span class="k">if</span> <span class="n">eqv_sites</span><span class="p">:</span>
        <span class="n">new_dict</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="p">{},</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">vpos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">pos_x</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># Add 1 to x if within tol</span>
            <span class="n">pos_y</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># Add 1 to y on modified and if within tol</span>
            <span class="n">pos_z</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># Add 1 to z and if within tol</span>
            <span class="n">pos_xy</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># Add 1 to x and y and if within tol</span>
            <span class="n">pos_yz</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># Add 1 to y and z and if within tol</span>
            <span class="n">pos_zx</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># Add 1 to z and x and if within tol</span>
            <span class="n">pos_xyz</span> <span class="o">=</span> <span class="n">vpos</span><span class="p">[((</span><span class="n">vpos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tol</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># Add 1 to x,y,z and if within tol</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vpos</span><span class="p">,</span><span class="n">pos_x</span><span class="p">,</span><span class="n">pos_y</span><span class="p">,</span><span class="n">pos_z</span><span class="p">,</span><span class="n">pos_xy</span><span class="p">,</span><span class="n">pos_yz</span><span class="p">,</span><span class="n">pos_zx</span><span class="p">,</span><span class="n">pos_xyz</span><span class="p">])}</span>
            <span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]))</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>

        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">new_dict</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">translate_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Translate sites of a PPSCAR. Usully a farction of integarers like 1/2,1/4 etc.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: Output of `export_poscar` or `export_vasprun().poscar`.</span>
<span class="sd">        - offset: A number(+/-) or list of three numbers to translate in a,b,c directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fix_sites</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">translate</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">eqv_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_pairs</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a tuple of Lattice (coords,pairs), so coords[pairs] given nearest site bonds.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: Output of `export_poscar` or `export_vasprun().poscar`.</span>
<span class="sd">        - positions: Array(N,3) of fractional positions of lattice sites. If coordinates positions, provide unity basis.</span>
<span class="sd">        - r        : Cartesian distance between the pairs in units of Angstrom e.g. 1.2 -&gt; 1.2E-10.</span>
<span class="sd">        - tol      : Tolerance value. Default is 10^-3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">cartesian</span> <span class="k">else</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">to_R3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">*</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">query_pairs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="n">tol</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">dict2tuple</span><span class="p">(</span><span class="s1">&#39;Lattice&#39;</span><span class="p">,{</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span><span class="n">coords</span><span class="p">,</span><span class="s1">&#39;pairs&#39;</span><span class="p">:</span><span class="n">inds</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">_get_bond_length</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">given</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
    <span class="s2">&quot;tol is add to calculated bond length in order to fix small differences, paramater `given` in range [0,1] which is scaled to V^(1/3).&quot;</span>
    <span class="k">if</span> <span class="n">given</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">given</span><span class="o">*</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">volume</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">tol</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">cartesian</span> <span class="k">else</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">_coords</span> <span class="o">=</span> <span class="n">to_R3</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">_arr</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Sort in ascending. returns list</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_arr</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">tol</span> <span class="k">if</span> <span class="n">_arr</span> <span class="k">else</span> <span class="mi">1</span> <span class="c1">#Between nearest and second nearest.</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">iplot_lat</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">sizes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">bond_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">bond_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">translate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">line_width</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">edge_color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
              <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ortho3d</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interactive plot of lattice.</span>
<span class="sd">    - **Main Parameters**</span>
<span class="sd">        - poscar_data: Output of export_poscar or export_vasprun().poscar.</span>
<span class="sd">        - sizes      : Size of sites. Either one int/float or list equal to type of ions.</span>
<span class="sd">        - colors     : Sequence of colors for each type. Automatically generated if not provided.</span>
<span class="sd">        - bond_length: Length of bond in fractional unit [0,1]. It is scaled to V^1/3 and auto calculated if not provides.</span>
<span class="sd">    Other parameters just mean what they seem to be.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">fix_sites</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="n">eqv_sites</span><span class="p">,</span><span class="n">translate</span><span class="o">=</span><span class="n">translate</span><span class="p">)</span>
    <span class="n">bond_length</span> <span class="o">=</span> <span class="n">_get_bond_length</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">given</span><span class="o">=</span><span class="n">bond_length</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="n">coords</span><span class="p">,</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">get_pairs</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                        <span class="n">r</span><span class="o">=</span><span class="n">bond_length</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="n">bond_tol</span><span class="p">)</span> <span class="c1"># bond tolernce shpuld be smaller than cell tolernce.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fig</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">uelems</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sizes</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">sizes</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Number of colors does not match number of elements. Using default colors.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">_atom_colors</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rgb(</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">_c</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">_c</span> <span class="ow">in</span> <span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">]</span>

    <span class="n">_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">vs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">])</span>
    <span class="n">h_text</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">coords_p</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="c1">#paired points</span>
        <span class="n">_colors</span> <span class="o">=</span> <span class="n">_colors</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="c1"># Colors at pairs</span>
        <span class="n">coords_n</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colors_n</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c_p</span><span class="p">,</span> <span class="n">_c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords_p</span><span class="p">,</span><span class="n">_colors</span><span class="p">):</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c_p</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">c_p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">c_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">coords_n</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">coords_n</span><span class="p">,</span><span class="o">*</span><span class="n">arr</span><span class="p">]</span> <span class="c1"># Same shape</span>
            <span class="n">colors_n</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">colors_n</span><span class="p">,</span><span class="o">*</span><span class="n">_c</span><span class="p">]</span> <span class="c1"># same shape.</span>

        <span class="n">coords_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords_n</span><span class="p">)</span>
        <span class="n">colors_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors_n</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cp</span><span class="p">),</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">coords_n</span><span class="p">),</span><span class="n">colors_n</span><span class="p">):</span>
            <span class="n">showlegend</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span><span class="n">line_color</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
                <span class="n">legendgroup</span><span class="o">=</span><span class="s1">&#39;Bonds&#39;</span><span class="p">,</span><span class="n">showlegend</span><span class="o">=</span><span class="n">showlegend</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bonds&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">=</span><span class="n">line_width</span><span class="p">))</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="n">c</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">colors</span><span class="p">,</span><span class="n">sizes</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">v</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">v</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">v</span><span class="p">][:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span><span class="n">marker_color</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span>
            <span class="n">hovertext</span> <span class="o">=</span> <span class="n">h_text</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
            <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;rgba(1,1,1,0)&#39;</span><span class="p">,</span><span class="n">line_width</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">marker_size</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span><span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>

    <span class="n">bz</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span><span class="n">path_pos</span><span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">rec_basis</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">iplot_bz</span><span class="p">(</span><span class="n">bz</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">vname</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">ortho3d</span><span class="o">=</span><span class="n">ortho3d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">splot_lat</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">plane</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">bond_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span><span class="n">bond_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">translate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.4</span><span class="p">)),</span>
              <span class="n">vectors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">v3</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">light_from</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
              <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">alpha_points</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Static plot of lattice.</span>
<span class="sd">    - **Main Parameters**</span>
<span class="sd">        - poscar_data: Output of export_poscar or export_vasprun().poscar.</span>
<span class="sd">        - plane      : Plane to plot. Either &#39;xy&#39;,&#39;xz&#39;,&#39;yz&#39; or None for 3D plot.</span>
<span class="sd">        - sizes      : Size of sites. Either one int/float or list equal to type of ions.</span>
<span class="sd">        - bond_length: Length of bond in fractional unit [0,1]. It is scaled to V^1/3 and auto calculated if not provides.</span>
<span class="sd">        - colors: Sequence of colors for each ion type. If None, automatically generated.</span>
<span class="sd">        - colormap: This is passed to splot_bz.</span>
<span class="sd">        - alpha_points: Opacity of points and bonds.</span>
<span class="sd">    Other parameters just mean what they seem to be.</span>

<span class="sd">    &gt; Tip: Use `plt.style.use(&#39;ggplot&#39;)` for better 3D perception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Plane fix</span>
    <span class="k">if</span> <span class="n">plane</span> <span class="ow">and</span> <span class="n">plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;xyzxzyx&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plane expects in &#39;xyzxzyx&#39; or None.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plane</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="s1">&#39;xyzxzyx&#39;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ix</span><span class="p">,</span><span class="n">iy</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">fix_sites</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="n">eqv_sites</span><span class="p">,</span><span class="n">translate</span><span class="o">=</span><span class="n">translate</span><span class="p">)</span>
    <span class="n">bond_length</span> <span class="o">=</span> <span class="n">_get_bond_length</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">given</span><span class="o">=</span><span class="n">bond_length</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="n">coords</span><span class="p">,</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">get_pairs</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span>
                        <span class="n">positions</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span>
                        <span class="n">r</span><span class="o">=</span><span class="n">bond_length</span><span class="p">,</span><span class="n">tol</span> <span class="o">=</span> <span class="n">bond_tol</span><span class="p">)</span> <span class="c1"># bond tolernce shpuld be smaller than cell tolernce.</span>
    <span class="n">bz</span> <span class="o">=</span> <span class="n">get_bz</span><span class="p">(</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">rec_basis</span><span class="p">,</span> <span class="n">primitive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">splot_bz</span><span class="p">(</span><span class="n">bz</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">vname</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span><span class="n">colormap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">plane</span><span class="o">=</span><span class="n">plane</span><span class="p">,</span><span class="n">v3</span><span class="o">=</span><span class="n">v3</span><span class="p">,</span>
                <span class="n">vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">,</span><span class="n">light_from</span><span class="o">=</span><span class="n">light_from</span><span class="p">)</span>

    <span class="n">uelems</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sizes</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">sizes</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Number of colors does not match number of elements. Using default colors.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">_atom_colors</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

    <span class="c1"># Before doing other stuff, create something for legend.</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="n">c</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="n">colors</span><span class="p">,</span><span class="n">sizes</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],[],</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span> <span class="c1"># Works both for 3D and 2D.</span>

    <span class="c1"># Now change colors and sizes to whole array size</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">vs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">])</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">vs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">coords_p</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="c1">#paired points</span>
        <span class="n">_colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="c1"># Colors at pairs</span>
        <span class="n">coords_n</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colors_n</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c_p</span><span class="p">,</span> <span class="n">_c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords_p</span><span class="p">,</span><span class="n">_colors</span><span class="p">):</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c_p</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">c_p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">c_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">coords_n</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">coords_n</span><span class="p">,</span><span class="o">*</span><span class="n">arr</span><span class="p">]</span> <span class="c1"># Same shape</span>
            <span class="n">colors_n</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">colors_n</span><span class="p">,</span><span class="o">*</span><span class="n">_c</span><span class="p">]</span> <span class="c1"># same shape.</span>

        <span class="n">coords_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords_n</span><span class="p">)</span>
        <span class="n">colors_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors_n</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plane</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">_c</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="n">line_width</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_points</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">_c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords_n</span><span class="p">,</span><span class="n">colors_n</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">plane</span> <span class="ow">in</span> <span class="s1">&#39;xyzxzyx&#39;</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">c</span><span class="p">[:,</span><span class="n">iy</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="n">_c</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="n">line_width</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_points</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">_c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords_n</span><span class="p">,</span><span class="n">colors_n</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">plane</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">c</span> <span class="o">=</span> <span class="n">colors</span> <span class="p">,</span><span class="n">s</span> <span class="o">=</span><span class="n">sizes</span><span class="p">,</span><span class="n">depthshade</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha_points</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plane</span> <span class="ow">in</span> <span class="s1">&#39;xyzxzyx&#39;</span><span class="p">:</span>
        <span class="n">iz</span><span class="p">,</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)]</span>
        <span class="n">zorder</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span><span class="n">iz</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plane</span> <span class="ow">in</span> <span class="s1">&#39;yxzy&#39;</span><span class="p">:</span> <span class="c1"># Left handed</span>
            <span class="n">zorder</span> <span class="o">=</span> <span class="n">zorder</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">zorder</span><span class="p">][:,</span><span class="n">ix</span><span class="p">],</span><span class="n">coords</span><span class="p">[</span><span class="n">zorder</span><span class="p">][:,</span><span class="n">iy</span><span class="p">],</span><span class="n">c</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">zorder</span><span class="p">]</span> <span class="p">,</span><span class="n">s</span> <span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="n">zorder</span><span class="p">],</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="n">alpha_points</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">sp</span><span class="o">.</span><span class="n">add_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">join_poscars</span><span class="p">(</span><span class="n">poscar1</span><span class="p">,</span><span class="n">poscar2</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Joins two POSCARs in a given direction. In-plane lattice parameters are kept from `poscar1` and basis of `poscar2` parallel to `direction` is modified while volume is kept same.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar1, poscar2:  Base and secondary POSCARs respectivly. Output of `export_poscar` or similar object from other functions.</span>
<span class="sd">        - direction: The joining direction. It is general and can join in any direction along basis. Expect one of [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;].</span>
<span class="sd">        - tol: Default is 0.01. It is used to bring sites near 1 to near zero in order to complete sites in plane. Vasp relaxation could move a point, say at 0.00100 to 0.99800 which is not useful while merging sites.</span>
<span class="sd">        - system: If system is given, it is written on top of file. Otherwise, it is infered from atomic species.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_poscar1</span> <span class="o">=</span> <span class="n">fix_sites</span><span class="p">(</span><span class="n">poscar1</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_poscar2</span> <span class="o">=</span> <span class="n">fix_sites</span><span class="p">(</span><span class="n">poscar2</span><span class="p">,</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span><span class="n">eqv_sites</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pos1</span> <span class="o">=</span> <span class="n">_poscar1</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pos2</span> <span class="o">=</span> <span class="n">_poscar2</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span> <span class="c1"># Half length for each.</span>
    <span class="n">a1</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">_poscar1</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">a2</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">_poscar2</span><span class="o">.</span><span class="n">basis</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">_poscar1</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Must be copied, otherwise change outside.</span>

    <span class="c1"># Processing in orthogonal space since a.(b x c) = abc sin(theta)cos(phi), and theta and phi are same for both.</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="s1">&#39;cC&#39;</span><span class="p">:</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">b2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="n">b1</span><span class="p">)</span><span class="o">*</span><span class="n">c2</span> <span class="c1"># Conservation of volume for right side to stretch in c-direction.</span>
        <span class="n">netc</span> <span class="o">=</span> <span class="n">c1</span><span class="o">+</span><span class="n">c2</span>
        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="n">netc</span><span class="p">,</span> <span class="n">c2</span><span class="o">/</span><span class="n">netc</span>
        <span class="n">pos1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1</span><span class="o">*</span><span class="n">pos1</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pos2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="o">*</span><span class="n">pos2</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span>
        <span class="n">basis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">netc</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">#Update 3rd vector</span>

    <span class="k">elif</span> <span class="n">direction</span> <span class="ow">in</span> <span class="s1">&#39;bB&#39;</span><span class="p">:</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">c2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">b2</span> <span class="c1"># Conservation of volume for right side to stretch in b-direction.</span>
        <span class="n">netb</span> <span class="o">=</span> <span class="n">b1</span><span class="o">+</span><span class="n">b2</span>
        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">b1</span><span class="o">/</span><span class="n">netb</span><span class="p">,</span> <span class="n">b2</span><span class="o">/</span><span class="n">netb</span>
        <span class="n">pos1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1</span><span class="o">*</span><span class="n">pos1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pos2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="o">*</span><span class="n">pos2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span>
        <span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">netb</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#Update 2nd vector</span>

    <span class="k">elif</span> <span class="n">direction</span> <span class="ow">in</span> <span class="s1">&#39;aA&#39;</span><span class="p">:</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2</span><span class="o">*</span><span class="n">c2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b1</span><span class="o">*</span><span class="n">c1</span><span class="p">)</span><span class="o">*</span><span class="n">a2</span> <span class="c1"># Conservation of volume for right side to stretch in a-direction.</span>
        <span class="n">neta</span> <span class="o">=</span> <span class="n">a1</span><span class="o">+</span><span class="n">a2</span>
        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">a1</span><span class="o">/</span><span class="n">neta</span><span class="p">,</span> <span class="n">a2</span><span class="o">/</span><span class="n">neta</span>
        <span class="n">pos1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1</span><span class="o">*</span><span class="n">pos1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="o">*</span><span class="n">pos2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span>
        <span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">neta</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#Update 1st vector</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;direction expects one of [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;]&quot;</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">_poscar1</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">_poscar2</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">u_all</span> <span class="o">=</span> <span class="p">({</span><span class="o">**</span><span class="n">u1</span><span class="p">,</span><span class="o">**</span><span class="n">u2</span><span class="p">})</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="c1"># Union of unique elements to keep track of order.</span>


    <span class="n">pos_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">u_all</span><span class="p">:</span>
        <span class="n">_i_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">u1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_i_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u1</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
            <span class="n">pos_all</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pos_all</span><span class="p">,</span><span class="o">*</span><span class="n">pos1</span><span class="p">[</span><span class="n">u1</span><span class="p">[</span><span class="n">u</span><span class="p">]]]</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">u2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_i_</span> <span class="o">=</span> <span class="n">_i_</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">u2</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
            <span class="n">pos_all</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">pos_all</span><span class="p">,</span><span class="o">*</span><span class="n">pos2</span><span class="p">[</span><span class="n">u2</span><span class="p">[</span><span class="n">u</span><span class="p">]]]</span>
        <span class="n">i_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_i_</span><span class="p">)</span>

    <span class="n">i_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="n">i_all</span><span class="p">])</span> <span class="c1"># Do it after labels</span>
    <span class="n">uelems</span> <span class="o">=</span> <span class="p">{</span><span class="n">_u</span><span class="p">:</span><span class="nb">range</span><span class="p">(</span><span class="n">i_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i_all</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">_u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">u_all</span><span class="p">)}</span>
    <span class="n">sys</span> <span class="o">=</span> <span class="n">system</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uelems</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">iscartesian</span> <span class="o">=</span> <span class="n">poscar1</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">cartesian</span> <span class="ow">or</span> <span class="n">poscar2</span><span class="o">.</span><span class="n">extra_info</span><span class="o">.</span><span class="n">cartesian</span>
    <span class="n">extra_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cartesian&#39;</span><span class="p">:</span><span class="n">iscartesian</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Modified by ipyvasp&#39;</span><span class="p">}</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">:</span><span class="n">sys</span><span class="p">,</span><span class="s1">&#39;basis&#39;</span><span class="p">:</span><span class="n">basis</span><span class="p">,</span><span class="s1">&#39;extra_info&#39;</span><span class="p">:</span><span class="n">extra_info</span><span class="p">,</span><span class="s1">&#39;positions&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_all</span><span class="p">),</span><span class="s1">&#39;unique&#39;</span><span class="p">:</span><span class="n">uelems</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">out_dict</span><span class="p">)</span>


<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">repeat_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repeat a given POSCAR.</span>
<span class="sd">    Args:</span>
<span class="sd">        - path_poscar: Path/to/POSCAR or `poscar` data object.</span>
<span class="sd">        - n: Number of repetitions.</span>
<span class="sd">        - direction: Direction of repetition. Can be &#39;a&#39;, &#39;b&#39; or &#39;c&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n must be an integer greater than 1.&quot;</span><span class="p">)</span>
    <span class="n">given_poscar</span> <span class="o">=</span> <span class="n">poscar_data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">join_poscars</span><span class="p">(</span><span class="n">given_poscar</span><span class="p">,</span> <span class="n">poscar_data</span><span class="p">,</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">poscar_data</span>

<span class="k">def</span> <span class="nf">scale_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create larger/smaller cell from a given POSCAR. Can be used to repeat a POSCAR with integer scale values.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: `poscar` data object.</span>
<span class="sd">        - scale: Tuple of three values along (a,b,c) vectors. int or float values. If number of sites are not as expected in output, tweak `tol` instead of `scale`. You can put a minus sign with `tol` to get more sites and plus sign to reduce sites.</span>
<span class="sd">        - tol: It is used such that site positions are blow `1 - tol`, as 1 belongs to next cell, not previous one.</span>
<span class="sd">    **Tip:** scale = (2,2,2) enlarges a cell and next operation of (1/2,1/2,1/2) should bring original cell back.</span>
<span class="sd">    **Caveat:** A POSACR scaled with Non-integer values should only be used for visualization purposes, Not for any other opration such as making supercells, joining POSCARs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># Need int for joining.</span>

    <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># No need to scale.</span>
        <span class="k">return</span> <span class="n">poscar_data</span>

    <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">repeat_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">jj</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">repeat_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kk</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">repeat_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">s</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scale</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">poscar_data</span> <span class="c1"># No need to prcess further in case of integer scaling.</span>

    <span class="n">new_poscar</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Update in it</span>

    <span class="c1"># Get clip fraction</span>
    <span class="n">fi</span><span class="p">,</span> <span class="n">fj</span><span class="p">,</span> <span class="n">fk</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ii</span><span class="p">,</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">jj</span><span class="p">,</span> <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">kk</span>

    <span class="c1"># Clip at end according to scale, change length of basis as fractions.</span>
    <span class="n">pos</span>   <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fi</span><span class="p">,</span><span class="n">fj</span><span class="p">,</span><span class="n">fk</span><span class="p">])</span> <span class="c1"># rescale for clip</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),[</span><span class="n">fi</span><span class="p">,</span><span class="n">fj</span><span class="p">,</span><span class="n">fk</span><span class="p">]):</span>
        <span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Basis rescale for clip</span>

    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Modified by ipyvasp&#39;</span>

    <span class="n">uelems</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="c1"># Minus in below for block is because if we have 0-2 then 1 belongs to next cell not original.</span>
    <span class="n">positions</span><span class="p">,</span><span class="n">shift</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">s_p</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="c1"># Get positions of key</span>
        <span class="n">s_p</span> <span class="o">=</span> <span class="n">s_p</span><span class="p">[(</span><span class="n">s_p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># Get sites within tolerance</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No sites found for </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1">, cannot scale down. Increase scale!&#39;</span><span class="p">)</span>

        <span class="n">uelems</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span><span class="n">shift</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_p</span><span class="p">))</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">positions</span><span class="p">,</span><span class="o">*</span><span class="n">s_p</span><span class="p">]</span> <span class="c1"># Pick sites</span>
        <span class="n">shift</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_p</span><span class="p">)</span> <span class="c1">#Update for next element</span>

    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">uelems</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">new_poscar</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rotate_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">angle_deg</span><span class="p">,</span><span class="n">axis_vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a given POSCAR.</span>
<span class="sd">    Args:</span>
<span class="sd">        - path_poscar: Path/to/POSCAR or `poscar` data object.</span>
<span class="sd">        - angle_deg: Rotation angle in degrees.</span>
<span class="sd">        - axis_vec : (x,y,z) of axis about which rotation takes place. Axis passes through origin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">rotation</span><span class="p">(</span><span class="n">angle_deg</span><span class="o">=</span><span class="n">angle_deg</span><span class="p">,</span><span class="n">axis_vec</span><span class="o">=</span><span class="n">axis_vec</span><span class="p">)</span>
    <span class="n">p_dict</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">])</span> <span class="c1"># Rotate basis so that they are transpose</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Modified by ipyvasp&#39;</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">p_dict</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mirror_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
    <span class="s2">&quot;Mirror a POSCAR in a given direction. Sometime you need it before joining two POSCARs&quot;</span>
    <span class="n">poscar</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Avoid modifying original</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="c1"># Check if direction is valid</span>
    <span class="n">poscar</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">][:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">poscar</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">][:,</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># Trick: Mirror by subtracting from 1. not by multiplying with -1.</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">poscar</span><span class="p">)</span> <span class="c1"># Return new POSCAR</span>

<span class="k">def</span> <span class="nf">convert_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">atoms_mapping</span><span class="p">,</span> <span class="n">basis_factor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a POSCAR to a similar structure of other atomic types or same type with strained basis.</span>
<span class="sd">    `atoms_mapping` is a dictionary of {old_atom: new_atom} like {&#39;Ga&#39;:&#39;Al&#39;} will convert GaAs to AlAs structure.</span>
<span class="sd">    `basis_factor` is a scaling factor multiplied with basis vectors, single value (useful for conversion to another type)</span>
<span class="sd">    or list of three values to scale along (a,b,c) vectors (useful for strained structures).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Avoid modifying original</span>
    <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">atoms_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="c1"># Update types</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Get basis to avoid modifying original</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis_factor</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
        <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis_factor</span><span class="o">*</span><span class="n">basis</span> <span class="c1"># Rescale basis</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basis_factor</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_factor</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;basis_factor should be a list/tuple/array of length 3&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">basis_factor</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;basis_factor should be a list/tuple/array of 3 int/float values&#39;</span><span class="p">)</span>

        <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">basis_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">basis_factor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">basis_factor</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">basis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;basis_factor should be a list/tuple/array of 3 int/float values, got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">basis_factor</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">)</span> <span class="c1"># Return new POSCAR</span>

<span class="k">def</span> <span class="nf">get_transform_matrix</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">target_basis</span><span class="p">):</span>
    <span class="s2">&quot;Returns a transformation matrix that gives `target_bsis` when applied on basis of current lattice. Useful in transforming crystal structure.&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">target_basis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">transform_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">transform_matrix</span><span class="p">,</span> <span class="n">repeat_given</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform a POSCAR with a given transformation matrix.</span>
<span class="sd">    Use `get_transform_matrix` to get transformation matrix from one basis to another.</span>
<span class="sd">    `repeat_given` is used to repeat the POSCAR before applying transformation matrix to include</span>
<span class="sd">    all possible sites in resultant cell.&quot;&quot;&quot;</span>
    <span class="n">new_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">transform_matrix</span><span class="p">,</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">basis</span><span class="p">)</span> <span class="c1"># Transforms basis to target basis</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">repeat_given</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`repeat_given` must be a list of three integers.&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="n">repeat_given</span><span class="p">:</span> <span class="c1"># Repeat if needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rep</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span> <span class="ow">and</span> <span class="n">rep</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`repeat_given` must have all values as integer &gt;= 1.&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">_dir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">repeat_given</span><span class="p">,</span><span class="s1">&#39;abc&#39;</span><span class="p">):</span> <span class="c1"># Repeat if needed for including atoms in new cell</span>
        <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">repeat_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="n">_dir</span><span class="p">)</span>

    <span class="n">center_coords</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Center around origin</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">to_basis</span><span class="p">(</span><span class="n">new_basis</span><span class="p">,</span><span class="n">center_coords</span><span class="p">)</span> <span class="c1"># Transform coordinates to new basis around origin</span>

    <span class="n">new_poscar</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Update in it</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_basis</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_basis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Transformed by ipyvasp&#39;</span>

    <span class="n">uelems</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">positions</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span> <span class="n">unique_dict</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span><span class="p">,</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">uelems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">s_p</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="c1"># Get positions of key</span>
        <span class="n">s_p</span> <span class="o">=</span> <span class="n">s_p</span><span class="p">[((</span><span class="n">s_p</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s_p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tol</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># Get sites within tolerance</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No sites found for </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1">, transformation stopped! You may need to increase `repeat_given` parameter.&#39;</span><span class="p">)</span>

        <span class="n">unique_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span><span class="n">shift</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_p</span><span class="p">))</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">positions</span><span class="p">,</span><span class="o">*</span><span class="n">s_p</span><span class="p">]</span> <span class="c1"># Pick sites</span>
        <span class="n">shift</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s_p</span><span class="p">)</span> <span class="c1">#Update for next element</span>

    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">unique_dict</span>
    <span class="n">new_poscar</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">new_poscar</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_vaccum</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add vacuum to a POSCAR.</span>
<span class="sd">    Args:</span>
<span class="sd">        - poscar_data: `poscar` data object.</span>
<span class="sd">        - thickness: Thickness of vacuum in Angstrom.</span>
<span class="sd">        - direction: Direction of vacuum. Can be &#39;a&#39;, &#39;b&#39; or &#39;c&#39;.</span>
<span class="sd">        - left: If True, vacuum is added to left of sites. By default, vacuum is added to right of sites.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;abc&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Direction must be a, b or c.&#39;</span><span class="p">)</span>

    <span class="n">poscar_dict</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Avoid modifying original</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">poscar_dict</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Copy basis to avoid modifying original</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">poscar_dict</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Copy positions to avoid modifying original</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">basis</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="c1"># Get length of basis vector</span>
    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">norm</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span> <span class="o">+</span> <span class="n">thickness</span><span class="p">),</span> <span class="n">thickness</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span> <span class="o">+</span> <span class="n">thickness</span><span class="p">)</span> <span class="c1"># Get scaling factors</span>
    <span class="n">basis</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">thickness</span> <span class="o">+</span> <span class="n">norm</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span> <span class="c1"># Add thickness to basis</span>
    <span class="n">poscar_dict</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span>
    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
        <span class="n">pos</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">s2</span> <span class="c1"># Scale down positions</span>
        <span class="n">pos</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s1</span> <span class="c1"># Add vacuum to left of sites</span>
        <span class="n">poscar_dict</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">s1</span> <span class="c1"># Scale down positions</span>
        <span class="n">poscar_dict</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">poscar_dict</span><span class="p">)</span> <span class="c1"># Return new POSCAR</span>


<span class="c1"># Cell</span>
<span class="k">def</span> <span class="nf">transpose_poscar</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
    <span class="s2">&quot;Transpose a POSCAR by switching basis from [0,1,2] -&gt; `axes`. By Default, x and y are transposed.&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`axes` must be a list of three integers.&#39;</span><span class="p">)</span>

        <span class="n">poscar_data</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1">#</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Copy basis to avoid modifying original</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Copy positions to avoid modifying original</span>
        <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="c1"># Transpose basis</span>
        <span class="n">poscar_data</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[:,</span><span class="n">axes</span><span class="p">]</span> <span class="c1"># Transpose positions</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">)</span> <span class="c1"># Return new POSCAR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;`axes` must be a squence of length 3.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_atoms</span><span class="p">(</span><span class="n">poscar_data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="s2">&quot;Add atoms with a `name` to a POSCAR at given `positions` in fractional coordinates.&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1"> already exists in POSCAR. Cannot add duplicate atoms.&#39;</span><span class="p">)</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`positions` must be a 2D array of shape (n,3)&#39;</span><span class="p">)</span>

    <span class="n">new_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span><span class="n">positions</span><span class="p">])</span> <span class="c1"># Add new positions to existing ones</span>

    <span class="n">unique</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">unique</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Copy unique dictionary to avoid modifying original</span>
    <span class="n">unique</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">poscar_data</span><span class="o">.</span><span class="n">positions</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pos</span><span class="p">))</span> <span class="c1"># Add new unique element</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">poscar_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="c1"># Copy data to avoid modifying original</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique</span> <span class="c1"># Update unique dictionary</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_pos</span> <span class="c1"># Update positions</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SYSTEM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SYSTEM&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Update SYSTEM</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;extra_info&#39;</span><span class="p">][</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;extra_info&quot;</span><span class="p">][</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> + Added </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">&#39;</span> <span class="c1"># Update comment</span>

    <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">PoscarData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Return new POSCAR</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Abdul Saboor
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    </body>
</html>